<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="robots" content="noindex, nofollow">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-Buy Agent (Final Integrated)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Google Sans', 'sans-serif'] },
                    colors: {
                        gemini: { bg: '#ffffff', sidebar: '#f0f4f9', input: '#f0f4f9', blue: '#1a73e8' }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.6s ease-out forwards',
                        'slide-up': 'slideUp 0.5s ease-out forwards',
                        'blink': 'blink 1s step-end infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        blink: { '0%, 100%': { opacity: '1' }, '50%': { opacity: '0' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Google Sans', sans-serif; background-color: white; color: #1f1f1f; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .text-gradient { background: linear-gradient(to right, #4285f4, #9b72cb, #d96570); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: inline-block; }
        .cursor { display: inline-block; width: 8px; height: 16px; background-color: #1a73e8; margin-left: 2px; vertical-align: middle; }
    </style>
</head>
<body class="h-screen flex overflow-hidden bg-white">

    <!-- Development Version Badge -->
    <div class="fixed z-50 top-4 right-14 md:top-4 md:right-4 bg-gray-100/80 backdrop-blur text-gray-400 text-[10px] px-2 py-0.5 rounded border border-gray-200 font-mono pointer-events-none">
        v0.1.6 (Dev)
    </div>

    <!-- Settings Modal (Only for Gemini Key) -->
    <div id="settings-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm hidden">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl animate-slide-up">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                <i class="fas fa-key text-blue-600"></i> API Key Required
            </h2>
            <p class="text-sm text-gray-500 mb-4">
                서비스 이용을 위해 <strong>Gemini API Key</strong>가 필요합니다.<br>
                (Shopify 연동은 자동으로 설정되어 있습니다.)
            </p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-700 mb-1">Gemini API Key</label>
                    <input type="password" id="input-gemini-key" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="AIzaSy...">
                </div>
            </div>

            <div class="mt-6 flex gap-2">
                <button onclick="saveSettings()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-bold text-sm transition">Start Shopping</button>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <aside class="hidden md:flex w-[280px] bg-gemini-sidebar flex-col p-4 space-y-4 border-r border-gray-100">
        <div class="flex items-center gap-2 px-2 py-1 mb-2">
            <span class="font-medium text-gray-600 text-lg tracking-tight">K-Buy Agent</span>
        </div>
        <button onclick="location.reload()" class="flex items-center gap-3 px-4 py-3 rounded-full bg-[#dde3ea] hover:bg-white text-sm font-medium transition shadow-sm">
            <i class="fas fa-plus text-gray-600"></i> New chat
        </button>
        <div class="mt-auto">
            <button onclick="openSettings()" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-[#e0e4e9] transition text-xs text-gray-600 font-medium">
                <i class="fas fa-cog"></i> Update API Key
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col relative h-full bg-white">
        <!-- Mobile Header -->
        <header class="md:hidden flex items-center justify-between p-4 bg-white sticky top-0 z-10 shadow-sm">
            <span class="text-xl font-medium text-gray-600">K-Buy Agent</span>
            <button onclick="openSettings()"><i class="fas fa-cog text-gray-500"></i></button>
        </header>

        <div id="chat-container" class="flex-1 overflow-y-auto pb-40 w-full max-w-4xl mx-auto px-4 scrollbar-hide pt-8">
            <div id="welcome-screen" class="flex flex-col h-full justify-center items-start space-y-8 pb-20 animate-fade-in">
                <div class="space-y-2">
                    <h1 class="text-5xl md:text-6xl font-medium tracking-tight">
                        <span class="text-gradient font-bold">Hello, Stranger</span>
                    </h1>
                    <h2 class="text-4xl md:text-5xl font-medium text-[#c4c7c5]">Ready to shop K-Goods?</h2>
                </div>
                
                <!-- 복원된 쇼핑 버튼들 -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 w-full mt-8">
                    <button onclick="fillInput('https://smtownandstore.com/product/wayv-winter-special-album')" class="text-left bg-gemini-sidebar hover:bg-[#e0e4e9] p-4 rounded-xl h-36 flex flex-col justify-between transition group">
                        <span class="text-sm font-medium text-gray-700 group-hover:text-black">Buy K-Pop Album</span>
                        <div class="self-end bg-white p-2 rounded-full shadow-sm">
                            <i class="fas fa-compact-disc text-gemini-blue"></i>
                        </div>
                    </button>
                    <button onclick="fillInput('BTS 앨범 추천해줘')" class="text-left bg-gemini-sidebar hover:bg-[#e0e4e9] p-4 rounded-xl h-36 flex flex-col justify-between transition group">
                        <span class="text-sm font-medium text-gray-700 group-hover:text-black">Recommend Items</span>
                        <div class="self-end bg-white p-2 rounded-full shadow-sm">
                            <i class="fas fa-wand-magic-sparkles text-blue-500"></i>
                        </div>
                    </button>
                    <button onclick="fillInput('한국 과자 추천해줘')" class="text-left bg-gemini-sidebar hover:bg-[#e0e4e9] p-4 rounded-xl h-36 flex flex-col justify-between transition group">
                        <span class="text-sm font-medium text-gray-700 group-hover:text-black">Find K-Snacks</span>
                        <div class="self-end bg-white p-2 rounded-full shadow-sm">
                            <i class="fas fa-cookie-bite text-orange-500"></i>
                        </div>
                    </button>
                </div>
            </div>
        </div>

        <div class="fixed bottom-0 left-0 md:left-[280px] right-0 bg-white/90 backdrop-blur-sm pb-6 pt-2 px-4">
            <div class="max-w-3xl mx-auto relative">
                <div class="flex items-center w-full bg-gemini-input rounded-full border border-transparent focus-within:border-gray-300 focus-within:shadow-md transition-all">
                    <input id="user-input" type="text" class="w-full bg-transparent h-14 pl-6 pr-12 outline-none text-base" placeholder="Enter URL or ask for recommendation..." onkeypress="if(event.key === 'Enter') sendMessage()">
                    <button onclick="sendMessage()" class="absolute right-2 p-2 rounded-full hover:bg-gray-200 transition text-blue-600">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <p class="text-center text-[10px] text-gray-500 mt-2">
                    K-Buy Agent displays inaccurate info, including about people, so double-check its responses.
                </p>
            </div>
        </div>
    </main>

    <script>
        // --- Configuration ---
        const config = {
            geminiKey: '', // 사용자 입력 대기
            shopUrl: 'aigent-kim.myshopify.com',
            // 요청하신 Shopify Access Token 내장
            shopToken: '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' 
        };

        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const welcomeScreen = document.getElementById('welcome-screen');
        const modal = document.getElementById('settings-modal');
        let currentStep = 0;
        let selectedProduct = null;

        // --- Settings Management ---
        function openSettings() {
            document.getElementById('input-gemini-key').value = config.geminiKey;
            modal.classList.remove('hidden');
        }

        function saveSettings() {
            const key = document.getElementById('input-gemini-key').value.trim();
            if (!key) {
                alert('Gemini API Key를 입력해주세요.');
                return;
            }
            config.geminiKey = key;
            modal.classList.add('hidden');
            
            // 첫 메시지
            if (chatContainer.children.length <= 1) { // Welcome screen 제외
                const botMsg = createMessageContainer('bot');
                typeWriter(botMsg, "Gemini connected! How can I help you shop today?");
            }
        }

        // 초기 로드 시 Gemini Key 없으면 모달 띄움
        window.onload = () => {
            if (!config.geminiKey) setTimeout(openSettings, 500);
        };

        // --- UI Utils ---
        function fillInput(text) {
            userInput.value = text;
            userInput.focus();
        }

        function scrollToBottom() {
            chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
        }

        async function typeWriter(element, text) {
            const cursor = document.createElement('span');
            cursor.className = 'cursor animate-blink';
            element.appendChild(cursor);
            for (let i = 0; i < text.length; i += 2) {
                cursor.before(text.substring(i, i + 2));
                scrollToBottom();
                await new Promise(r => setTimeout(r, 10));
            }
            cursor.remove();
        }

        function createMessageContainer(sender) {
            if (welcomeScreen.style.display !== 'none') welcomeScreen.style.display = 'none';
            
            const wrapper = document.createElement('div');
            wrapper.className = `w-full mb-6 ${sender === 'user' ? '' : 'animate-slide-up'}`;
            
            const icon = sender === 'bot' 
                ? `<div class="w-8 h-8 rounded-full bg-white border border-gray-100 flex items-center justify-center flex-shrink-0 shadow-sm text-blue-500"><i class="fas fa-wand-magic-sparkles"></i></div>`
                : `<div class="w-8 h-8 rounded-full bg-gray-800 text-white flex items-center justify-center flex-shrink-0 text-xs font-bold">U</div>`;

            wrapper.innerHTML = `
                <div class="max-w-3xl mx-auto flex gap-4 ${sender === 'user' ? 'flex-row-reverse' : ''}">
                    ${icon}
                    <div class="message-content ${sender === 'user' ? 'bg-[#f0f4f9] px-5 py-3 rounded-[20px] rounded-tr-sm' : 'pt-1'} text-[15px] leading-7 text-gray-800 flex-1 overflow-hidden min-w-0 prose">
                        <div class="text-body"></div>
                    </div>
                </div>`;
            chatContainer.appendChild(wrapper);
            return wrapper.querySelector('.text-body');
        }

        function showLoading() {
            const id = 'loading-' + Date.now();
            const wrapper = createMessageContainer('bot');
            wrapper.innerHTML = `<div id="${id}" class="flex items-center gap-2 h-6"><i class="fas fa-circle-notch fa-spin text-blue-500"></i><span class="text-gray-400 text-sm">Thinking...</span></div>`;
            return { id, wrapper };
        }

        function removeLoading(id) {
            const el = document.getElementById(id);
            if (el) el.closest('.w-full').remove();
        }

        // --- Core Logic ---
        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            if (!config.geminiKey) {
                openSettings();
                return;
            }

            userInput.value = '';
            const userMsg = createMessageContainer('user');
            userMsg.innerText = text;

            const { id } = showLoading();
            try {
                await processScenario(text);
            } catch (e) {
                const botMsg = createMessageContainer('bot');
                botMsg.innerText = "Error: " + e.message;
            } finally {
                removeLoading(id);
            }
        }

        async function fetchRecommendations(query) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${config.geminiKey}`;
            const prompt = `
                You are a shopping assistant. Recommend 3 Korean products for "${query}".
                Return ONLY JSON Array: [{title, category, priceKrw (string), priceNum (int), weight (string), weightNum (float)}].
            `;
            
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await res.json();
            if (data.error) throw new Error(data.error.message);
            return JSON.parse(data.candidates[0].content.parts[0].text.replace(/```json|```/g, ''));
        }

        // Shopify Draft Order 생성 (내장된 토큰 사용)
        async function createShopifyDraftOrder() {
            // 환율 및 배송비
            const EX_RATE = 1400;
            const priceUsd = (selectedProduct.priceNum / EX_RATE).toFixed(2);
            const weight = selectedProduct.weightNum || 1.0;
            const shippingCost = (weight * 20).toFixed(2);
            
            const payload = {
                draft_order: {
                    line_items: [{
                        title: selectedProduct.title,
                        price: priceUsd,
                        quantity: 1,
                        requires_shipping: true,
                        grams: weight * 1000
                    }],
                    shipping_line: {
                        title: "International Shipping (EMS)",
                        price: shippingCost
                    },
                    customer: {
                        email: "customer@example.com" // 데모용
                    },
                    use_customer_default_address: false
                }
            };

            try {
                // 브라우저 직접 호출 (CORS 에러 발생 가능성 있음 -> 에러 발생 시 Fallback 처리)
                const res = await fetch(`https://${config.shopUrl}/admin/api/2023-10/draft_orders.json`, {
                    method: 'POST',
                    headers: {
                        'X-Shopify-Access-Token': config.shopToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    const data = await res.json();
                    return data.draft_order.invoice_url;
                } else {
                    throw new Error("API call failed");
                }
            } catch (error) {
                console.warn("Direct API call blocked by browser (CORS). Returning mock URL for demo.");
                // 실제 배포 시에는 백엔드 Proxy 필요. 여기서는 데모를 위해 가상 링크 반환
                return `https://${config.shopUrl}/checkouts/cn/demo-${Math.random().toString(36).substr(2, 9)}`;
            }
        }

        async function processScenario(text) {
            const botMsg = createMessageContainer('bot');

            if (currentStep === 0) {
                // URL 입력 감지
                if (text.includes('http')) {
                     // URL Mock Data Logic
                    let productData = {};
                    
                    if (text.includes('luxboy')) {
                        productData = {
                            title: "[Prada] Saffiano Leather Mini Bag",
                            priceKrw: "₩ 2,450,000",
                            priceNum: 2450000,
                            weight: "1.2kg",
                            weightNum: 1.2,
                            category: "Luxury > Bags"
                        };
                    } else if (text.includes('kurly')) {
                        productData = {
                            title: "[Kurly Only] Gangnam Galbi Tang",
                            priceKrw: "₩ 15,000",
                            priceNum: 15000,
                            weight: "1.5kg",
                            weightNum: 1.5,
                            category: "Food > Instant"
                        };
                    } else {
                        // Default (SM Town)
                        productData = {
                            title: "WayV - Winter Special Album",
                            priceKrw: "₩ 27,800",
                            priceNum: 27800,
                            weight: "0.8kg",
                            weightNum: 0.8,
                            category: "Album"
                        };
                    }

                    selectedProduct = productData;
                    await typeWriter(botMsg, "I analyzed the URL. Here is the product:");
                    renderProductCard(botMsg, selectedProduct);
                    return;
                }

                // 일반 검색/추천
                const products = await fetchRecommendations(text);
                await typeWriter(botMsg, `I found these products for "${text}".`);
                
                const grid = document.createElement('div');
                grid.className = "grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 animate-slide-up";
                
                products.forEach(p => {
                    const imgUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(p.title)}?width=300&height=200&nologo=true`;
                    const card = document.createElement('div');
                    card.className = "bg-white border rounded-xl overflow-hidden shadow-sm hover:shadow-md transition cursor-pointer";
                    card.innerHTML = `
                        <img src="${imgUrl}" class="w-full h-32 object-cover">
                        <div class="p-3">
                            <h3 class="font-bold text-sm truncate">${p.title}</h3>
                            <div class="flex justify-between mt-2">
                                <span class="text-blue-600 font-bold text-xs">${p.priceKrw}</span>
                                <button class="bg-blue-50 text-blue-600 px-2 py-1 rounded text-xs font-bold">Select</button>
                            </div>
                        </div>`;
                    card.onclick = () => selectProduct(p);
                    grid.appendChild(card);
                });
                botMsg.appendChild(grid);
            }
            else if (currentStep === 3) {
                await typeWriter(botMsg, "Creating secure checkout link on Shopify...");
                const checkoutUrl = await createShopifyDraftOrder();
                
                const linkCard = document.createElement('div');
                linkCard.className = "mt-4 bg-green-50 border border-green-200 rounded-xl p-4 animate-slide-up";
                linkCard.innerHTML = `
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white"><i class="fas fa-check"></i></div>
                        <span class="font-bold text-green-800">Order Ready!</span>
                    </div>
                    <p class="text-sm text-green-700 mb-3">Product has been added to your cart.</p>
                    <a href="${checkoutUrl}" target="_blank" class="block w-full bg-green-600 hover:bg-green-700 text-white text-center py-3 rounded-lg font-bold transition">
                        Proceed to Payment <i class="fas fa-external-link-alt ml-1"></i>
                    </a>
                `;
                botMsg.appendChild(linkCard);
                currentStep = 0; 
            }
        }

        function renderProductCard(container, product) {
            const card = document.createElement('div');
            card.className = "mt-4 bg-white border rounded-xl p-4 max-w-sm animate-slide-up shadow-sm";
            const imgUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(product.title)}?width=300&height=200&nologo=true`;
            card.innerHTML = `
                <img src="${imgUrl}" class="w-full h-40 object-cover rounded-lg mb-3">
                <h3 class="font-bold">${product.title}</h3>
                <p class="text-sm text-gray-500">${product.category}</p>
                <div class="flex justify-between items-center mt-3">
                    <span class="font-bold text-blue-600">${product.priceKrw}</span>
                    <button class="bg-blue-600 text-white px-4 py-1.5 rounded-lg text-sm font-medium hover:bg-blue-700 transition" onclick='selectProduct(${JSON.stringify(product)})'>Calculate</button>
                </div>
            `;
            container.appendChild(card);
        }

        async function selectProduct(product) {
            selectedProduct = product;
            const { id } = showLoading();
            setTimeout(async () => {
                removeLoading(id);
                const botMsg = createMessageContainer('bot');
                
                const totalUsd = ((product.priceNum / 1400) + (product.weightNum * 20)).toFixed(2);
                
                await typeWriter(botMsg, `Estimated Total: $${totalUsd} (Item + Shipping to USA).`);
                
                const btn = document.createElement('button');
                btn.className = "mt-3 bg-black text-white px-6 py-2 rounded-full font-bold hover:bg-gray-800 transition animate-slide-up";
                btn.innerHTML = `Checkout on Shopify <i class="fas fa-arrow-right ml-2"></i>`;
                btn.onclick = () => {
                    const userMsg = createMessageContainer('user');
                    userMsg.innerText = "Yes, please.";
                    currentStep = 3;
                    const {id} = showLoading(); 
                    setTimeout(() => { removeLoading(id); processScenario(""); }, 1000);
                };
                botMsg.appendChild(btn);
            }, 800);
        }
    </script>
</body>
</html>
