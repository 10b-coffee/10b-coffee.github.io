<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>넘버블록스: 넘버랜드 축제 대모험</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 5.3. 사운드 라이브러리 (Tone.js) 로드 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    
    <!-- 기존 Google Font 'Inter' 삭제 -->
    <!-- 
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    -->

    <!-- Pretendard 웹폰트 CDN 추가 -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    
    <style>
        body {
            /* font-family: 'Inter', sans-serif; */
            /* Pretendard 폰트 스택으로 변경 (한/영 모두 적용) */
            font-family: "Pretendard", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            background-color: #f0f9ff;
        }
        .game-screen {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        .active-screen {
            display: block;
        }
        
        /* 이전 오류의 원인이었던 잘못된 주석을 완전히 제거했습니다.
        */

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="min-h-screen p-4">

    <div id="game-container" class="w-full max-w-4xl mx-auto bg-white/70 rounded-lg shadow-2xl backdrop-blur-sm overflow-hidden">

        <!-- 화면 1: 메인 메뉴 -->
        <div id="screen-main-menu" class="game-screen active-screen p-4 md:p-8">
            <!-- 4.2. 언어 전환 버튼 -->
            <div class="flex gap-4 justify-center mb-4">
                <!-- .lang-btn의 기본 스타일을 직접 적용 -->
                <button id="lang-ko-btn" class="p-3 rounded-lg shadow-md transition-all" title="한국어">🇰🇷</button>
        // --- Initialize Game ---
        document.addEventListener('DOMContentLoaded', () => {
            
            <!-- .game-title 스타일 직접 적용 -->
            <h1 class="text-2xl p-5 md:text-3xl md:p-4 font-bold text-center text-blue-800" data-i18n-key="title">넘버블록스: 넘버랜드 축제 대모험</h1>
            
            <div class="flex flex-col items-center gap-4 mt-8">
                <p class="text-base md:text-lg text-center text-gray-700 p-5 md:p-4" data-i18n-key="welcome">
                    넘버랜드 축제에 오신 것을 환영합니다!
                </p>
                <!-- .game-button 스타일 직접 적용 -->
                <button id="start-game-btn" class="text-base p-5 md:text-lg md:p-4 bg-blue-500 text-white font-bold rounded-lg shadow-md hover:bg-blue-600 transition-all duration-300 transform hover:scale-105 active:scale-95 w-full md:w-1/2" data-i18n-key="start_game">
                    게임 시작!
                </button>
            </div>
        </div>

        <!-- 화면 2: 월드맵 -->
        <div id="screen-world-map" class="game-screen p-4 md:p-8">
            <!-- .game-title 스타일 직접 적용 -->
            <h1 class="text-2xl p-5 md:text-3xl md:p-4 font-bold text-center text-blue-800" data-i18n-key="world_map">월드맵: 넘버랜드 축제</h1>
            
            <div class="flex justify-between items-center mb-4 p-5 md:p-4">
                <!-- .game-button 스타일 + override 스타일 직접 적용 -->
                <button id="back-to-menu-btn" class="text-base p-5 md:text-lg md:p-4 bg-blue-500 text-white font-bold rounded-lg shadow-md hover:bg-blue-600 transition-all duration-300 transform hover:scale-105 active:scale-95 !text-sm !p-2 !md:p-3 !bg-gray-500" data-i18n-key="main_menu">
                    &larr; 메인 메뉴
                </button>
                <div class="text-base md:text-lg bg-white px-4 py-2 rounded-lg shadow-inner">
                    <span class="font-bold text-yellow-500">🟡</span>
                    <span id="numberblobs-count" class="font-bold text-gray-700">0</span>
                </div>
                <!-- .game-button 스타일 + override 스타일 직접 적용 -->
                <button id="stickerbook-btn" class="text-base p-5 md:text-lg md:p-4 bg-blue-500 text-white font-bold rounded-lg shadow-md hover:bg-blue-600 transition-all duration-300 transform hover:scale-105 active:scale-95 !text-sm !p-2 !md:p-3 !bg-purple-500" data-i18n-key="stickerbook">
                    스티커북 📒
                </button>
            </div>

            <!-- 3.1. / 5.2. 모든 5개 스테이지 -->
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-8">
                <!-- .game-card 스타일 직접 적용 -->
                <button data-stage-id="1" class="p-5 md:p-4 bg-white rounded-lg shadow-lg text-center transform hover:scale-105 transition-transform cursor-pointer">
                    <div class="text-4xl md:text-6xl">1️⃣</div>
                    <p class="text-base md:text-lg font-bold mt-2" data-i18n-key="stage1_title">도형 파티 전시관</p>
                </button>
                
                <!-- .game-card 스타일 직접 적용. .stage-locked는 JS가 제어 -->
                <button data-stage-id="2" class="p-5 md:p-4 bg-white rounded-lg shadow-lg text-center transform hover:scale-105 transition-transform cursor-pointer">
                    <div class="text-4xl md:text-6xl">2️⃣</div>
                    <p class="text-base md:text-lg font-bold mt-2" data-i18n-key="stage2_title">수 세기 퍼레이드</p>
                </button>

                <!-- .game-card 스타일 직접 적용 -->
                <button data-stage-id="3" class="p-5 md:p-4 bg-white rounded-lg shadow-lg text-center transform hover:scale-105 transition-transform cursor-pointer">
                    <div class="text-4xl md:text-6xl">3️⃣</div>
                    <p class="text-base md:text-lg font-bold mt-2" data-i18n-key="stage3_title">슈퍼 스피드 광장</p>
                </button>
                
                <!-- .game-card 스타일 직접 적용 -->
                <button data-stage-id="4" class="p-5 md:p-4 bg-white rounded-lg shadow-lg text-center transform hover:scale-105 transition-transform cursor-pointer">
                    <div class="text-4xl md:text-6xl">4️⃣</div>
                    <p class="text-base md:text-lg font-bold mt-2" data-i18n-key="stage4_title">스퀘어 클럽</p>
                </button>
                
                <!-- .game-card 스타일 직접 적용 -->
                <button data-stage-id="5" class="p-5 md:p-4 bg-white rounded-lg shadow-lg text-center transform hover:scale-105 transition-transform cursor-pointer">
                    <div class="text-4xl md:text-6xl">5️⃣</div>
                    <p class="text-base md:text-lg font-bold mt-2" data-i18n-key="stage5_title">패턴 팰리스</p>
                </button>
            </div>
        </div>

        <!-- 화면 3: 게임 스테이지 -->
        <div id="screen-game-stage" class="game-screen p-4 md:p-8">
            <!-- .game-button 스타일 + override 스타일 직접 적용 -->
            <button id="back-to-map-btn" class="text-base p-5 md:text-lg md:p-4 bg-blue-500 text-white font-bold rounded-lg shadow-md hover:bg-blue-600 transition-all duration-300 transform hover:scale-105 active:scale-95 !text-sm !p-2 !md:p-3 !bg-gray-500 mb-4" data-i18n-key="world_map_back">
                &larr; 월드맵으로
            </button>
            <!-- .game-card 스타일 직접 적용 -->
            <div class="p-5 md:p-4 bg-white rounded-lg shadow-lg">
                <!-- .game-title 스타일 + override 스타일 직접 적용 -->
                <h2 id="stage-title" class="text-2xl p-5 md:text-3xl md:p-4 font-bold text-center text-blue-800 !text-xl !md:text-2xl !p-0 mb-4">
                    <!-- 퀴즈 로딩 시 동적 변경 -->
                </h2>
                <div id="quiz-question-text" class="bg-gray-100 rounded-lg p-5 md:p-8 min-h-[200px] flex flex-col items-center justify-center">
                    <!-- 퀴즈 질문 텍스트와 프롬프트가 여기에 삽입됩니다 -->
                </div>
                
                <div id="quiz-options-container" class="grid grid-cols-2 gap-4 mt-6">
                    <!-- 퀴즈 로딩 시 동적 생성 -->
                </div>
            </div>
        </div>

        <!-- 화면 4: 스티커북 -->
        <div id="screen-stickerbook" class="game-screen p-4 md:p-8">
            <!-- .game-button 스타일 + override 스타일 직접 적용 -->
            <button id="stickerbook-back-btn" class="text-base p-5 md:text-lg md:p-4 bg-blue-500 text-white font-bold rounded-lg shadow-md hover:bg-blue-600 transition-all duration-300 transform hover:scale-105 active:scale-95 !text-sm !p-2 !md:p-3 !bg-gray-500 mb-4" data-i18n-key="world_map_back">
                &larr; 월드맵으로
            </button>
            <!-- .game-card 스타일 직접 적용 -->
            <div class="p-5 md:p-4 bg-white rounded-lg shadow-lg">
                <!-- .game-title 스타일 + override 스타일 직접 적용 -->
                <h2 class="text-2xl p-5 md:text-3xl md:p-4 font-bold text-center text-blue-800 !text-xl !md:text-2xl !p-0 mb-4" data-i18n-key="stickerbook_title">
                    나의 스티커북 📒
                </h2>
                <div id="stickerbook-grid" class="bg-gray-100 rounded-lg p-8 min-h-[300px] grid grid-cols-3 md:grid-cols-4 gap-4">
                    <p id="empty-stickerbook-msg" class="text-base md:text-lg text-gray-500 col-span-full text-center" data-i18n-key="stickerbook_empty">
                        (아직 수집한 스티커가 없어요!)
                    </p>
                    <!-- 수집한 스티커가 여기에 추가됩니다 -->
                </div>
            </div>
        </div>

    </div> <!-- End of game-container -->

    <!-- 모달: 건설적 교정 (4.1.) -->
    <!-- 'game-screen' 클래스 제거, 'hidden' 클래스 추가 -->
    <div id="modal-feedback" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
        <!-- .game-card 스타일 직접 적용 -->
        <div class="p-5 md:p-4 bg-white rounded-lg shadow-lg w-full max-w-md">
            <!-- .game-title 스타일 + override 스타일 직접 적용 -->
            <h3 class="text-2xl p-5 md:text-3xl md:p-4 font-bold text-center text-blue-800 !text-xl !md:text-2xl !p-0 mb-4" data-i18n-key="feedback_title">
                다시 생각해 볼까요?
            </h3>
            <!-- 4.1. 시각적 힌트 영역 -->
            <div id="feedback-hint-container" class="min-h-[150px] flex flex-col items-center justify-center bg-gray-100 rounded-lg p-4">
                <div id="feedback-visual" class="text-6xl"></div>
                <p id="feedback-text" class="text-base md:text-lg mt-4"></p>
            </div>
            <!-- .game-button 스타일 + override 스타일 직접 적용 -->
            <button id="close-feedback-modal-btn" class="text-base p-5 md:text-lg md:p-4 bg-blue-500 text-white font-bold rounded-lg shadow-md hover:bg-blue-600 transition-all duration-300 transform hover:scale-105 active:scale-95 w-full mt-4 !bg-orange-500 hover:!bg-orange-600" data-i18n-key="feedback_confirm">
                알겠어요!
            </button>
        </div>
    </div>

    <!-- 모달: 보상 -->
    <!-- 'game-screen' 클래스 제거, 'hidden' 클래스 추가 -->
    <div id="modal-reward" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
        <!-- .game-card 스타일 직접 적용 -->
        <div class="p-5 md:p-4 bg-white rounded-lg shadow-lg w-full max-w-md text-center">
            <!-- .game-title 스타일 + override 스타일 직접 적용 -->
            <h3 id="reward-title" class="text-2xl p-5 md:text-3xl md:p-4 font-bold text-center text-blue-800 !text-xl !md:text-2xl !p-0 mb-4" data-i18n-key="reward_clear">
                스테이지 클리어!
            </h3>
            <div id="reward-visual" class="text-6xl md:text-8xl animate-pulse">🎉</div>
            <p id="reward-sticker-text" class="text-base md:text-lg my-4"></p>
            <!-- .game-button 스타일 직접 적용 -->
            <button id="close-reward-modal-btn" class="text-base p-5 md:text-lg md:p-4 bg-blue-500 text-white font-bold rounded-lg shadow-md hover:bg-blue-600 transition-all duration-300 transform hover:scale-105 active:scale-95 w-full mt-4" data-i18n-key="reward_confirm">
                월드맵으로
            </button>
        </div>
    </div>


    <!-- JavaScript 로직 -->
    <script>
        // --- 1. Game State ---
        let gameState = {
// ... existing code ... -->
        // --- Core SPA Logic ---
        function showScreen(screenId) {
            document.querySelectorAll('.game-screen').forEach(screen => {
                screen.classList.remove('active-screen');
            });
            const activeScreen = document.getElementById(screenId);
            if (activeScreen) {
                activeScreen.classList.add('active-screen');
            }
        }
        
        // --- 모달 전용 함수 ---
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex'); // 'flex'를 사용하여 items-center, justify-center 적용
            }
        }

        function hideModal(modalId) {
            document.getElementById('lang-en-btn').addEventListener('click', () => updateLanguage('en'));
            
            // 네비게이션 버튼
            // [수정] 주석 처리되어 있던 'start-game-btn' 이벤트 리스너의 주석을 해제합니다.
            document.getElementById('start-game-btn').addEventListener('click', () => {
                playSound(clickSound, "C4");
                showScreen('screen-world-map');
                updateWorldMapUI(); // 월드맵 UI (잠금/해제) 업데이트
            });
            
            document.getElementById('back-to-menu-btn').addEventListener('click', () => {
                playSound(clickSound, "C4");
                showScreen('screen-world-map');
            });
            
            // 모달 닫기 버튼 (hideModal 사용하도록 수정)
            document.getElementById('close-feedback-modal-btn').addEventListener('click', () => {
                playSound(clickSound, "C4");
                hideModal('modal-feedback');
                // showScreen('screen-game-stage'); // 모달은 화면을 가릴 뿐, 화면을 전환하지 않음
            });
            document.getElementById('close-reward-modal-btn').addEventListener('click', () => {
                playSound(clickSound, "C4");
                hideModal('modal-reward');
                // showScreen('screen-world-map'); // 월드맵으로 가는 로직은 reward 모달 띄울 때 결정
            });
            
            // 5.2. 월드맵 스테이지 버튼 동적 생성
// ... existing code ... -->
        // 4.1. 피드백 모달 표시
        function showFeedbackModal(text, visual) {
            document.getElementById('feedback-text').innerText = text;
            document.getElementById('feedback-visual').innerText = visual;
            showModal('modal-feedback'); // showScreen 대신 showModal 사용
        }

        function handleStageClear() {
// ... existing code ... -->
        // 4.1. / 3.4. 보상 모달 (통합)
        function showRewardModal(isSpeedRound) {
            const lang = gameState.language;
            const closeButton = document.getElementById('close-reward-modal-btn');
            
            if (isSpeedRound) {
                document.getElementById('reward-title').innerText = i18n[lang]['reward_speed_round_title'];
// ... existing code ... -->
                document.getElementById('reward-sticker-text').innerText = i18n[lang]['reward_speed_round_text'];
                // 스피드 라운드 모달 닫기 버튼은 다음 문제로 진행
                closeButton.onclick = () => {
                    playSound(clickSound, "C4");
                    hideModal('modal-reward');
                    goToNextQuestion(); // 다음 문제로
                };
            } else {
// ... existing code ... -->
                document.getElementById('reward-visual').innerText = '🎉';
                document.getElementById('reward-sticker-text').innerText = `${i18n[lang]['sticker_text']} '${stageData.sticker}'`;
                // 일반 클리어 모달 닫기 버튼은 월드맵으로
                closeButton.onclick = () => {
                    playSound(clickSound, "C4");
                    hideModal('modal-reward');
                    showScreen('screen-world-map'); // 월드맵으로 화면 전환
                };
            }
            showModal('modal-reward'); // showScreen 대신 showModal 사용
        }

        // 5.2. 스티커북 렌더링
// ... existing code ... -->


