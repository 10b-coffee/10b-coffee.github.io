<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë„˜ë²„ë¸”ë¡ìŠ¤: ë„˜ë²„ëœë“œ ì¶•ì œ ëŒ€ëª¨í—˜</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 5.3. ì‚¬ìš´ë“œ ë¼ì´ë¸ŒëŸ¬ë¦¬ (Tone.js) ë¡œë“œ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f9ff;
        }
        .game-screen {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        .active-screen {
            display: block;
        }
        .game-button {
            @apply text-base p-5;
            @apply md:text-lg md:p-4;
            @apply bg-blue-500 text-white font-bold rounded-lg shadow-md hover:bg-blue-600 transition-all duration-300 transform hover:scale-105 active:scale-95;
        }
        .game-card {
            @apply p-5;
            @apply md:p-4;
            @apply bg-white rounded-lg shadow-lg;
        }
        .game-title {
            @apply text-2xl p-5;
            @apply md:text-3xl md:p-4;
            @apply font-bold text-center text-blue-800;
        }
        
        /* 3.1. / 5.2. ì ê¸´ ìŠ¤í…Œì´ì§€ ìŠ¤íƒ€ì¼ */
        .stage-locked {
            @apply filter grayscale opacity-50 cursor-not-allowed transform-none hover:scale-100;
        }
        
        /* 4.2. ì–¸ì–´ ì„ íƒ ë²„íŠ¼ í™œì„±/ë¹„í™œì„± ìŠ¤íƒ€ì¼ */
        .lang-btn {
            @apply p-3 rounded-lg shadow-md transition-all;
        }
        .lang-btn.active {
            @apply bg-blue-500 ring-4 ring-blue-200;
        }
        .lang-btn.inactive {
            @apply bg-gray-200 hover:bg-gray-300;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="min-h-screen p-4">

    <div id="game-container" class="w-full max-w-4xl mx-auto bg-white/70 rounded-lg shadow-2xl backdrop-blur-sm overflow-hidden">

        <!-- í™”ë©´ 1: ë©”ì¸ ë©”ë‰´ -->
        <div id="screen-main-menu" class="game-screen active-screen p-4 md:p-8">
            <!-- 4.2. ì–¸ì–´ ì „í™˜ ë²„íŠ¼ -->
            <div class="flex gap-4 justify-center mb-4">
                <button id="lang-ko-btn" class="lang-btn active" title="í•œêµ­ì–´">ğŸ‡°ğŸ‡·</button>
                <button id="lang-en-btn" class="lang-btn inactive" title="English">ğŸ‡¬ğŸ‡§</button>
            </div>
            
            <h1 class="game-title" data-i18n-key="title">ë„˜ë²„ë¸”ë¡ìŠ¤: ë„˜ë²„ëœë“œ ì¶•ì œ ëŒ€ëª¨í—˜</h1>
            
            <div class="flex flex-col items-center gap-4 mt-8">
                <p class="text-base md:text-lg text-center text-gray-700 p-5 md:p-4" data-i18n-key="welcome">
                    ë„˜ë²„ëœë“œ ì¶•ì œì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!
                </p>
                <button id="start-game-btn" class="game-button w-full md:w-1/2" data-i18n-key="start_game">
                    ê²Œì„ ì‹œì‘!
                </button>
            </div>
        </div>

        <!-- í™”ë©´ 2: ì›”ë“œë§µ -->
        <div id="screen-world-map" class="game-screen p-4 md:p-8">
            <h1 class="game-title" data-i18n-key="world_map">ì›”ë“œë§µ: ë„˜ë²„ëœë“œ ì¶•ì œ</h1>
            
            <div class="flex justify-between items-center mb-4 p-5 md:p-4">
                <button id="back-to-menu-btn" class="game-button !text-sm !p-2 !md:p-3 !bg-gray-500" data-i18n-key="main_menu">
                    &larr; ë©”ì¸ ë©”ë‰´
                </button>
                <div class="text-base md:text-lg bg-white px-4 py-2 rounded-lg shadow-inner">
                    <span class="font-bold text-yellow-500">ğŸŸ¡</span>
                    <span id="numberblobs-count" class="font-bold text-gray-700">0</span>
                </div>
                <button id="stickerbook-btn" class="game-button !text-sm !p-2 !md:p-3 !bg-purple-500" data-i18n-key="stickerbook">
                    ìŠ¤í‹°ì»¤ë¶ ğŸ“’
                </button>
            </div>

            <!-- 3.1. / 5.2. ëª¨ë“  5ê°œ ìŠ¤í…Œì´ì§€ -->
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-8">
                <!-- 1êµ¬ì—­ (í™œì„±í™”) -->
                <button data-stage-id="1" class="game-card text-center transform hover:scale-105 transition-transform cursor-pointer">
                    <div class="text-4xl md:text-6xl">1ï¸âƒ£</div>
                    <p class="text-base md:text-lg font-bold mt-2" data-i18n-key="stage1_title">ë„í˜• íŒŒí‹° ì „ì‹œê´€</p>
                </button>
                
                <!-- 2êµ¬ì—­ (ë¹„í™œì„±í™”) -->
                <button data-stage-id="2" class="game-card text-center transform hover:scale-105 transition-transform cursor-pointer stage-locked">
                    <div class="text-4xl md:text-6xl">2ï¸âƒ£</div>
                    <p class="text-base md:text-lg font-bold mt-2" data-i18n-key="stage2_title">ìˆ˜ ì„¸ê¸° í¼ë ˆì´ë“œ</p>
                </button>

                <!-- 3êµ¬ì—­ (ë¹„í™œì„±í™”) -->
                <button data-stage-id="3" class="game-card text-center transform hover:scale-105 transition-transform cursor-pointer stage-locked">
                    <div class="text-4xl md:text-6xl">3ï¸âƒ£</div>
                    <p class="text-base md:text-lg font-bold mt-2" data-i18n-key="stage3_title">ìŠˆí¼ ìŠ¤í”¼ë“œ ê´‘ì¥</p>
                </button>
                
                <!-- 4êµ¬ì—­ (ë¹„í™œì„±í™”) -->
                <button data-stage-id="4" class="game-card text-center transform hover:scale-105 transition-transform cursor-pointer stage-locked">
                    <div class="text-4xl md:text-6xl">4ï¸âƒ£</div>
                    <p class="text-base md:text-lg font-bold mt-2" data-i18n-key="stage4_title">ìŠ¤í€˜ì–´ í´ëŸ½</p>
                </button>
                
                <!-- 5êµ¬ì—­ (ë¹„í™œì„±í™”) -->
                <button data-stage-id="5" class="game-card text-center transform hover:scale-105 transition-transform cursor-pointer stage-locked">
                    <div class="text-4xl md:text-6xl">5ï¸âƒ£</div>
                    <p class="text-base md:text-lg font-bold mt-2" data-i18n-key="stage5_title">íŒ¨í„´ íŒ°ë¦¬ìŠ¤</p>
                </button>
            </div>
        </div>

        <!-- í™”ë©´ 3: ê²Œì„ ìŠ¤í…Œì´ì§€ -->
        <div id="screen-game-stage" class="game-screen p-4 md:p-8">
            <button id="back-to-map-btn" class="game-button !text-sm !p-2 !md:p-3 !bg-gray-500 mb-4" data-i18n-key="world_map_back">
                &larr; ì›”ë“œë§µìœ¼ë¡œ
            </button>
            <div class="game-card">
                <h2 id="stage-title" class="game-title !text-xl !md:text-2xl !p-0 mb-4">
                    <!-- í€´ì¦ˆ ë¡œë”© ì‹œ ë™ì  ë³€ê²½ -->
                </h2>
                <div id="quiz-question-text" class="bg-gray-100 rounded-lg p-5 md:p-8 min-h-[200px] flex flex-col items-center justify-center">
                    <!-- í€´ì¦ˆ ì§ˆë¬¸ í…ìŠ¤íŠ¸ì™€ í”„ë¡¬í”„íŠ¸ê°€ ì—¬ê¸°ì— ì‚½ì…ë©ë‹ˆë‹¤ -->
                </div>
                
                <div id="quiz-options-container" class="grid grid-cols-2 gap-4 mt-6">
                    <!-- í€´ì¦ˆ ë¡œë”© ì‹œ ë™ì  ìƒì„± -->
                </div>
            </div>
        </div>

        <!-- í™”ë©´ 4: ìŠ¤í‹°ì»¤ë¶ -->
        <div id="screen-stickerbook" class="game-screen p-4 md:p-8">
            <button id="stickerbook-back-btn" class="game-button !text-sm !p-2 !md:p-3 !bg-gray-500 mb-4" data-i18n-key="world_map_back">
                &larr; ì›”ë“œë§µìœ¼ë¡œ
            </button>
            <div class="game-card">
                <h2 class="game-title !text-xl !md:text-2xl !p-0 mb-4" data-i18n-key="stickerbook_title">
                    ë‚˜ì˜ ìŠ¤í‹°ì»¤ë¶ ğŸ“’
                </h2>
                <div id="stickerbook-grid" class="bg-gray-100 rounded-lg p-8 min-h-[300px] grid grid-cols-3 md:grid-cols-4 gap-4">
                    <p id="empty-stickerbook-msg" class="text-base md:text-lg text-gray-500 col-span-full text-center" data-i18n-key="stickerbook_empty">
                        (ì•„ì§ ìˆ˜ì§‘í•œ ìŠ¤í‹°ì»¤ê°€ ì—†ì–´ìš”!)
                    </p>
                    <!-- ìˆ˜ì§‘í•œ ìŠ¤í‹°ì»¤ê°€ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>

    </div> <!-- End of game-container -->

    <!-- ëª¨ë‹¬: ê±´ì„¤ì  êµì • (4.1.) -->
    <div id="modal-feedback" class="game-screen fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
        <div class="game-card w-full max-w-md">
            <h3 class="game-title !text-xl !md:text-2xl !p-0 mb-4" data-i18n-key="feedback_title">
                ë‹¤ì‹œ ìƒê°í•´ ë³¼ê¹Œìš”?
            </h3>
            <!-- 4.1. ì‹œê°ì  íŒíŠ¸ ì˜ì—­ -->
            <div id="feedback-hint-container" class="min-h-[150px] flex flex-col items-center justify-center bg-gray-100 rounded-lg p-4">
                <div id="feedback-visual" class="text-6xl"></div>
                <p id="feedback-text" class="text-base md:text-lg mt-4"></p>
            </div>
            <button id="close-feedback-modal-btn" class="game-button w-full mt-4 !bg-orange-500 hover:!bg-orange-600" data-i18n-key="feedback_confirm">
                ì•Œê² ì–´ìš”!
            </button>
        </div>
    </div>

    <!-- ëª¨ë‹¬: ë³´ìƒ -->
    <div id="modal-reward" class="game-screen fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
        <div class="game-card w-full max-w-md text-center">
            <h3 id="reward-title" class="game-title !text-xl !md:text-2xl !p-0 mb-4" data-i18n-key="reward_clear">
                ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´!
            </h3>
            <div id="reward-visual" class="text-6xl md:text-8xl animate-pulse">ğŸ‰</div>
            <p id="reward-sticker-text" class="text-base md:text-lg my-4"></p>
            <button id="close-reward-modal-btn" class="game-button w-full mt-4" data-i18n-key="reward_confirm">
                ì›”ë“œë§µìœ¼ë¡œ
            </button>
        </div>
    </div>


    <!-- JavaScript ë¡œì§ -->
    <script>
        // --- 1. Game State ---
        let gameState = {
            language: 'ko',
            numberblobs: 0,
            unlockedStages: [1],
            collectedStickers: [],
            currentStage: 1,
            currentQuestionIndex: 0,
            leoProfile: { weakness: 'geometry', strength: 'multiplication' },
            stageAttempts: { stage1_wrong: 0, stage3_correct: 0 },
            isSpeedRound: false // 4.1. ê°•ì  ì‹¬í™”
        };

        // --- 5.3. ì‚¬ìš´ë“œ ì´í™íŠ¸ ì´ˆê¸°í™” ---
        let soundsReady = false;
        let clickSound, correctSound, wrongSound, clearSound;
        
        // ì‚¬ìš©ìê°€ ìƒí˜¸ì‘ìš©(í´ë¦­ ë“±)ì„ í•´ì•¼ ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ê°€ ì‹œì‘ë¨
        function initAudio() {
            if (soundsReady || typeof Tone === 'undefined') return;
            Tone.start(); // ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ ì‹œì‘
            clickSound = new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 } }).toDestination();
            correctSound = new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.2 } }).toDestination();
            wrongSound = new Tone.Synth({ oscillator: { type: "square" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.2 } }).toDestination();
            clearSound = new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.4, sustain: 0, release: 0.1 } }).toDestination();
            soundsReady = true;
        }
        
        function playSound(sound, note, duration = "16n") {
            if (soundsReady && sound) {
                sound.triggerAttackRelease(note, duration);
            }
        }
        
        // --- 4.2. ì–¸ì–´ ë°ì´í„° (i18n) ---
        const i18n = {
            'ko': {
                'title': 'ë„˜ë²„ë¸”ë¡ìŠ¤: ë„˜ë²„ëœë“œ ì¶•ì œ ëŒ€ëª¨í—˜',
                'welcome': 'ë„˜ë²„ëœë“œ ì¶•ì œì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!',
                'start_game': 'ê²Œì„ ì‹œì‘!',
                'world_map': 'ì›”ë“œë§µ: ë„˜ë²„ëœë“œ ì¶•ì œ',
                'main_menu': '&larr; ë©”ì¸ ë©”ë‰´',
                'stickerbook': 'ìŠ¤í‹°ì»¤ë¶ ğŸ“’',
                'stickerbook_title': 'ë‚˜ì˜ ìŠ¤í‹°ì»¤ë¶ ğŸ“’',
                'stickerbook_empty': '(ì•„ì§ ìˆ˜ì§‘í•œ ìŠ¤í‹°ì»¤ê°€ ì—†ì–´ìš”!)',
                'world_map_back': '&larr; ì›”ë“œë§µìœ¼ë¡œ',
                'stage1_title': 'ë„í˜• íŒŒí‹° ì „ì‹œê´€',
                'stage2_title': 'ìˆ˜ ì„¸ê¸° í¼ë ˆì´ë“œ',
                'stage3_title': 'ìŠˆí¼ ìŠ¤í”¼ë“œ ê´‘ì¥',
                'stage4_title': 'ìŠ¤í€˜ì–´ í´ëŸ½',
                'stage5_title': 'íŒ¨í„´ íŒ°ë¦¬ìŠ¤',
                'feedback_title': 'ë‹¤ì‹œ ìƒê°í•´ ë³¼ê¹Œìš”?',
                'feedback_confirm': 'ì•Œê² ì–´ìš”!',
                'reward_clear': 'ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´!',
                'reward_confirm': 'ì›”ë“œë§µìœ¼ë¡œ',
                'reward_speed_round_title': 'ìŠˆí¼ ìŠ¤í”¼ë“œ ë¼ìš´ë“œ!',
                'reward_speed_round_text': 'ê³±ì…ˆ ì²œì¬! ìŠ¤í”¼ë“œ ë¼ìš´ë“œ ì‹œì‘!',
                'sticker_text': 'ìŠ¤í‹°ì»¤ íšë“!'
            },
            'en': {
                'title': 'Numberblocks: The Numberland Fair Adventure',
                'welcome': 'Welcome to the Numberland Fair!',
                'start_game': 'Start Game!',
                'world_map': 'World Map: Numberland Fair',
                'main_menu': '&larr; Main Menu',
                'stickerbook': 'Stickerbook ğŸ“’',
                'stickerbook_title': 'My Stickerbook ğŸ“’',
                'stickerbook_empty': '(No stickers collected yet!)',
                'world_map_back': '&larr; To World Map',
                'stage1_title': 'Shape Party Exhibition',
                'stage2_title': 'Counting Parade',
                'stage3_title': 'Super Speed Square',
                'stage4_title': 'Square Club',
                'stage5_title': 'Pattern Palace',
                'feedback_title': "Let's think again!",
                'feedback_confirm': 'Got it!',
                'reward_clear': 'Stage Clear!',
                'reward_confirm': 'To World Map',
                'reward_speed_round_title': 'Super Speed Round!',
                'reward_speed_round_text': 'Multiplication genius! Speed round starts!',
                'sticker_text': 'Sticker Get!'
            }
        };

        // --- 3.1. í€´ì¦ˆ ë°ì´í„° í™•ì¥ ---
        const quizData = {
            1: { // ë„í˜• (ì•½ì )
                title: "stage1_title",
                sticker: "ğŸ”º",
                questions: [
                    { qKey: "q1_1", prompt: "ğŸ”º", options: ["o_square", "o_triangle", "o_circle"], correct: "o_triangle", feedbackKey: "f1_1", visual: "ğŸ”º" },
                    { qKey: "q1_2", prompt: "ğŸŸ¦", options: ["n_3", "n_4", "n_5"], correct: "n_4", feedbackKey: "f1_2", visual: "4ï¸âƒ£" }
                ]
            },
            2: { // ìˆ˜ ì„¸ê¸°
                title: "stage2_title",
                sticker: "2ï¸âƒ£",
                questions: [
                    { qKey: "q2_1", prompt: "ğŸŸ¡ğŸŸ¡ğŸŸ¡", options: ["n_2", "n_3", "n_4"], correct: "n_3", feedbackKey: "f2_1", visual: "3ï¸âƒ£" },
                    { qKey: "q2_2", prompt: "ğŸŸ¡ğŸŸ¡ğŸŸ¡ğŸŸ¡ğŸŸ¡", options: ["n_4", "n_5", "n_6"], correct: "n_5", feedbackKey: "f2_2", visual: "5ï¸âƒ£" }
                ]
            },
            3: { // ê³±ì…ˆ (ê°•ì )
                title: "stage3_title",
                sticker: "âœ–ï¸",
                questions: [
                    { qKey: "q3_1", prompt: "2 x 3 = ?", options: ["n_5", "n_6", "n_7"], correct: "n_6", feedbackKey: "f3_1", visual: "2ï¸âƒ£ âœ–ï¸ 3ï¸âƒ£ = 6ï¸âƒ£" },
                    { qKey: "q3_2", prompt: "3 x 4 = ?", options: ["n_10", "n_12", "n_14"], correct: "n_12", feedbackKey: "f3_2", visual: "3ï¸âƒ£ âœ–ï¸ 4ï¸âƒ£ = 1ï¸âƒ£2ï¸âƒ£" }
                ]
            },
            4: { // ì œê³±ìˆ˜ (ê°•ì )
                title: "stage4_title",
                sticker: "ğŸŸª", // ìŠ¤í€˜ì–´ í´ëŸ½
                questions: [
                    { qKey: "q4_1", prompt: "3 x 3 = ?", options: ["n_6", "n_8", "n_9"], correct: "n_9", feedbackKey: "f4_1", visual: "3ï¸âƒ£ âœ–ï¸ 3ï¸âƒ£ = 9ï¸âƒ£" },
                    { qKey: "q4_2", prompt: "4 x 4 = ?", options: ["n_12", "n_16", "n_8"], correct: "n_16", feedbackKey: "f4_2", visual: "4ï¸âƒ£ âœ–ï¸ 4ï¸âƒ£ = 1ï¸âƒ£6ï¸âƒ£" }
                ]
            },
            5: { // íŒ¨í„´
                title: "stage5_title",
                sticker: "ğŸ¨",
                questions: [
                    { qKey: "q5_1", prompt: "1, 3, 5, ... ?", options: ["n_6", "n_7", "n_8"], correct: "n_7", feedbackKey: "f5_1", visual: "+2" },
                    { qKey: "q5_2", prompt: "10, 8, 6, ... ?", options: ["n_4", "n_5", "n_3"], correct: "n_4", feedbackKey: "f5_2", visual: "-2" }
                ]
            }
        };

        // 3.1. í€´ì¦ˆ í…ìŠ¤íŠ¸ (i18n ë¶„ë¦¬)
        const quizText = {
            'ko': {
                'q1_1': "ì´ ë„í˜•ì˜ ì´ë¦„ì€ ë¬´ì—‡ì¸ê°€ìš”?", 'o_square': "ì‚¬ê°í˜•", 'o_triangle': "ì‚¼ê°í˜•", 'o_circle': "ì›", 'f1_1': "ì‚¼ê°í˜•ì€ ë³€ì´ 3ê°œì˜ˆìš”!",
                'q1_2': "ì´ ë„í˜•ì€ ëª‡ ê°œì˜ ë³€ì„ ê°€ì§€ê³  ìˆë‚˜ìš”?", 'n_3': "3ê°œ", 'n_4': "4ê°œ", 'n_5': "5ê°œ", 'f1_2': "ì‚¬ê°í˜•ì€ ë³€ì´ 4ê°œ! ë„˜ë²„ë¸”ë¡ 4!",
                'q2_1': "ë„˜ë²„ë¸”ë¡­ì´ ëª‡ ê°œ ìˆë‚˜ìš”?", 'n_2': "2ê°œ", 'f2_1': "ì…‹! 3ì´ì—ìš”!",
                'q2_2': "ë„˜ë²„ë¸”ë¡­ì´ ëª‡ ê°œ ìˆë‚˜ìš”?", 'n_6': "6ê°œ", 'f2_2': "ë‹¤ì„¯! 5ì˜ˆìš”!",
                'q3_1': "2 ê³±í•˜ê¸° 3ì€?", 'n_7': "7", 'n_6': "6", 'f3_1': "2ê°€ 3ë²ˆ! 6!",
                'q3_2': "3 ê³±í•˜ê¸° 4ëŠ”?", 'n_10': "10", 'n_12': "12", 'n_14': "14", 'f3_2': "3ì´ 4ë²ˆ! 12!",
                'q4_1': "ìŠ¤í€˜ì–´ í´ëŸ½! 3 ê³±í•˜ê¸° 3ì€?", 'n_8': "8", 'n_9': "9", 'f4_1': "3ì€ ìŠˆí¼ ìŠ¤í€˜ì–´! 9!",
                'q4_2': "ìŠ¤í€˜ì–´ í´ëŸ½! 4 ê³±í•˜ê¸° 4ëŠ”?", 'n_16': "16", 'f4_2': "4ëŠ” ìŠˆí¼ ìŠ¤í€˜ì–´! 16!",
                'q5_1': "ë‹¤ìŒ ìˆ«ìëŠ” ë¬´ì—‡ì¼ê¹Œìš”? 1, 3, 5, ... ?", 'n_7': "7", 'n_8': "8", 'f5_1': "2ì”© ì»¤ì§€ê³  ìˆì–´ìš”!",
                'q5_2': "ë‹¤ìŒ ìˆ«ìëŠ” ë¬´ì—‡ì¼ê¹Œìš”? 10, 8, 6, ... ?", 'n_4': "4", 'f5_2': "2ì”© ì‘ì•„ì§€ê³  ìˆì–´ìš”!"
            },
            'en': {
                'q1_1': "What is the name of this shape?", 'o_square': "Square", 'o_triangle': "Triangle", 'o_circle': "Circle", 'f1_1': "A triangle has 3 sides!",
                'q1_2': "How many sides does this shape have?", 'n_3': "3", 'n_4': "4", 'n_5': "5", 'f1_2': "A square has 4 sides! Numberblock 4!",
                'q2_1': "How many Numberblobs?", 'n_2': "2", 'f2_1': "Three! It's 3!",
                'q2_2': "How many Numberblobs?", 'n_6': "6", 'f2_2': "Five! It's 5!",
                'q3_1': "What is 2 times 3?", 'n_7': "7", 'n_6': "6", 'f3_1': "2, three times! It's 6!",
                'q3_2': "What is 3 times 4?", 'n_10': "10", 'n_12': "12", 'n_14': "14", 'f3_2': "3, four times! It's 12!",
                'q4_1': "Square Club! What is 3 times 3?", 'n_8': "8", 'n_9': "9", 'f4_1': "3 is a Super Square! 9!",
                'q4_2': "Square Club! What is 4 times 4?", 'n_16': "16", 'f4_2': "4 is a Super Square! 16!",
                'q5_1': "What is the next number? 1, 3, 5, ... ?", 'n_7': "7", 'n_8': "8", 'f5_1': "It's growing by 2!",
                'q5_2': "What is the next number? 10, 8, 6, ... ?", 'n_4': "4", 'f5_2': "It's shrinking by 2!"
            }
        };


        // --- Core SPA Logic ---
        function showScreen(screenId) {
            document.querySelectorAll('.game-screen').forEach(screen => {
                screen.classList.remove('active-screen');
            });
            const activeScreen = document.getElementById(screenId);
            if (activeScreen) {
                activeScreen.classList.add('active-screen');
            }
        }
        
        // --- 4.2. ì–¸ì–´ ì „í™˜ ê¸°ëŠ¥ ---
        function updateLanguage(lang) {
            if (!['ko', 'en'].includes(lang)) return;
            
            gameState.language = lang;
            
            // ë²„íŠ¼ í™œì„±/ë¹„í™œì„±
            document.getElementById('lang-ko-btn').classList.toggle('active', lang === 'ko');
            document.getElementById('lang-ko-btn').classList.toggle('inactive', lang !== 'ko');
            document.getElementById('lang-en-btn').classList.toggle('active', lang === 'en');
            document.getElementById('lang-en-btn').classList.toggle('inactive', lang !== 'en');

            // ëª¨ë“  í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            document.querySelectorAll('[data-i18n-key]').forEach(el => {
                const key = el.dataset.i18nKey;
                if (i18n[lang][key]) {
                    el.innerHTML = i18n[lang][key];
                }
            });
            
            // ì›”ë“œë§µ ìŠ¤í…Œì´ì§€ ì œëª© (íŠ¹ìˆ˜ ì¼€ì´ìŠ¤)
            document.querySelectorAll('[data-stage-id]').forEach(btn => {
                const stageId = btn.dataset.stageId;
                if (quizData[stageId] && quizData[stageId].title) {
                    const titleKey = quizData[stageId].title;
                    btn.querySelector('p').innerHTML = i18n[lang][titleKey] || titleKey;
                }
            });
        }

        // --- Initialize Game ---
        document.addEventListener('DOMContentLoaded', () => {
            
            // ë§¨ ì²˜ìŒ í´ë¦­ ì‹œ ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
            document.body.addEventListener('click', initAudio, { once: true });
            
            // ì–¸ì–´ ë²„íŠ¼
            document.getElementById('lang-ko-btn').addEventListener('click', ()d => updateLanguage('ko'));
            document.getElementById('lang-en-btn').addEventListener('click', () => updateLanguage('en'));
            
            // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼
            document.getElementById('start-game-btn').addEventListener('click', () => {
                playSound(clickSound, "C4");
                showScreen('screen-world-map');
                updateWorldMapUI();
                updateUI();
            });

            document.getElementById('back-to-menu-btn').addEventListener('click', () => {
                playSound(clickSound, "C4");
                showScreen('screen-main-menu');
            });

            document.getElementById('stickerbook-btn').addEventListener('click', () => {
                playSound(clickSound, "C4");
                renderStickerbook();
                showScreen('screen-stickerbook');
            });

            document.getElementById('stickerbook-back-btn').addEventListener('click', () => {
                playSound(clickSound, "C4");
                showScreen('screen-world-map');
            });
            
            document.getElementById('back-to-map-btn').addEventListener('click', () => {
                playSound(clickSound, "C4");
                showScreen('screen-world-map');
            });
            
            // ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼
            document.getElementById('close-feedback-modal-btn').addEventListener('click', () => {
                playSound(clickSound, "C4");
                showScreen('screen-game-stage');
            });
            document.getElementById('close-reward-modal-btn').addEventListener('click', () => {
                playSound(clickSound, "C4");
                showScreen('screen-world-map');
            });
            
            // 5.2. ì›”ë“œë§µ ìŠ¤í…Œì´ì§€ ë²„íŠ¼ ë™ì  ìƒì„±
            document.querySelectorAll('[data-stage-id]').forEach(button => {
                button.addEventListener('click', () => {
                    const stageId = parseInt(button.dataset.stageId, 10);
                    if (gameState.unlockedStages.includes(stageId)) {
                        playSound(clickSound, "C4");
                        loadQuiz(stageId);
                    } else {
                        playSound(wrongSound, "A2"); // ì ê¹€ ì•Œë¦¼ìŒ
                    }
                });
            });

            // ì´ˆê¸° ì–¸ì–´ ë° UI ì„¤ì •
            updateLanguage(gameState.language);
            showScreen('screen-main-menu');
        });

        // --- UI Update Functions ---
        function updateUI() {
            document.getElementById('numberblobs-count').innerText = gameState.numberblobs;
        }
        
        // 5.2. ì›”ë“œë§µ ì ê¸ˆ/í•´ì œ UI ì—…ë°ì´íŠ¸
        function updateWorldMapUI() {
            document.querySelectorAll('[data-stage-id]').forEach(button => {
                const stageId = parseInt(button.dataset.stageId, 10);
                const isUnlocked = gameState.unlockedStages.includes(stageId);
                button.classList.toggle('stage-locked', !isUnlocked);
            });
        }

        // --- Quiz Logic ---
        function loadQuiz(stageId) {
            gameState.currentStage = stageId;
            gameState.currentQuestionIndex = 0;
            gameState.isSpeedRound = false; // ìŠ¤í”¼ë“œ ë¼ìš´ë“œ ë¦¬ì…‹
            gameState.stageAttempts.stage3_correct = 0; // 3êµ¬ì—­ ì‹œë„ ë¦¬ì…‹

            const stageData = quizData[stageId];
            if (!stageData) return;

            showScreen('screen-game-stage');
            
            const titleKey = stageData.title;
            document.getElementById('stage-title').innerText = i18n[gameState.language][titleKey] || titleKey;

            renderQuestion();
        }

        function renderQuestion() {
            const stageData = quizData[gameState.currentStage];
            const question = stageData.questions[gameState.currentQuestionIndex];
            if (!question) return;

            const lang = gameState.language;
            const qText = quizText[lang][question.qKey] || question.qKey;

            const questionTextContainer = document.getElementById('quiz-question-text');
            questionTextContainer.innerHTML = `
                <p class="text-base md:text-lg text-gray-700 text-center font-bold mb-4">${qText}</p>
                <div class="text-6xl md:text-8xl">${question.prompt}</div>
            `;

            const optionsContainer = document.getElementById('quiz-options-container');
            optionsContainer.innerHTML = ''; 

            question.options.forEach(optionKey => {
                const button = document.createElement('button');
                button.className = 'game-button !bg-cyan-500 hover:!bg-cyan-600';
                button.innerText = quizText[lang][optionKey] || optionKey;
                
                button.addEventListener('click', () => {
                    const isCorrect = (optionKey === question.correct);
                    const feedback = {
                        text: quizText[lang][question.feedbackKey] || question.feedbackKey,
                        visual: question.visual
                    };
                    checkAnswer(isCorrect, feedback);
                });
                
                optionsContainer.appendChild(button);
            });
        }

        function checkAnswer(isCorrect, feedback) {
            if (isCorrect) {
                // ì •ë‹µ
                playSound(correctSound, "C5");
                gameState.numberblobs += (gameState.isSpeedRound ? 10 : 5); // ìŠ¤í”¼ë“œ ë¼ìš´ë“œ ë³´ë„ˆìŠ¤
                updateUI();
                
                // 4.1. ê°•ì  ì‹¬í™” (3êµ¬ì—­)
                if (gameState.currentStage === 3 && !gameState.isSpeedRound) {
                    gameState.stageAttempts.stage3_correct++;
                    if (gameState.stageAttempts.stage3_correct >= 2) {
                        gameState.isSpeedRound = true;
                        showRewardModal(true); // ìŠ¤í”¼ë“œ ë¼ìš´ë“œ ì•Œë¦¼
                        return; // ë‹¤ìŒ ë¬¸ì œë¡œ ë°”ë¡œ ë„˜ì–´ê°€ì§€ ì•Šê³  ëª¨ë‹¬ í‘œì‹œ
                    }
                }
                
                // ë‹¤ìŒ ë¬¸ì œë¡œ
                goToNextQuestion();

            } else {
                // ì˜¤ë‹µ
                playSound(wrongSound, "A3");
                
                // 4.1. ì•½ì  ë³´ì™„ (1êµ¬ì—­)
                if (gameState.currentStage === 1) {
                    gameState.stageAttempts.stage1_wrong++;
                }
                
                // 4.1. ê±´ì„¤ì  êµì • ëª¨ë‹¬ í‘œì‹œ
                showFeedbackModal(feedback.text, feedback.visual);
            }
        }
        
        function goToNextQuestion() {
            gameState.currentQuestionIndex++;
            const stageData = quizData[gameState.currentStage];
            
            if (gameState.currentQuestionIndex < stageData.questions.length) {
                renderQuestion();
            } else {
                handleStageClear();
            }
        }
        
        // 4.1. í”¼ë“œë°± ëª¨ë‹¬ í‘œì‹œ
        function showFeedbackModal(text, visual) {
            document.getElementById('feedback-text').innerText = text;
            document.getElementById('feedback-visual').innerText = visual;
            showScreen('modal-feedback');
        }

        function handleStageClear() {
            playSound(clearSound, "G5", "4n");
            const stageData = quizData[gameState.currentStage];
            
            if (!gameState.collectedStickers.includes(stageData.sticker)) {
                gameState.collectedStickers.push(stageData.sticker);
            }
            
            const nextStage = gameState.currentStage + 1;
            if (nextStage <= 5 && !gameState.unlockedStages.includes(nextStage)) {
                gameState.unlockedStages.push(nextStage);
                updateWorldMapUI(); // ì›”ë“œë§µ UI ì—…ë°ì´íŠ¸
            }

            showRewardModal(false); // ì¼ë°˜ ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´
        }
        
        // 4.1. / 3.4. ë³´ìƒ ëª¨ë‹¬ (í†µí•©)
        function showRewardModal(isSpeedRound) {
            const lang = gameState.language;
            
            if (isSpeedRound) {
                document.getElementById('reward-title').innerText = i18n[lang]['reward_speed_round_title'];
                document.getElementById('reward-visual').innerText = 'ğŸš€';
                document.getElementById('reward-sticker-text').innerText = i18n[lang]['reward_speed_round_text'];
                // ìŠ¤í”¼ë“œ ë¼ìš´ë“œ ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ì€ ë‹¤ìŒ ë¬¸ì œë¡œ ì§„í–‰
                document.getElementById('close-reward-modal-btn').onclick = () => {
                    playSound(clickSound, "C4");
                    showScreen('screen-game-stage');
                    goToNextQuestion(); // ë‹¤ìŒ ë¬¸ì œë¡œ
                };
            } else {
                const stageData = quizData[gameState.currentStage];
                document.getElementById('reward-title').innerText = i18n[lang]['reward_clear'];
                document.getElementById('reward-visual').innerText = 'ğŸ‰';
                document.getElementById('reward-sticker-text').innerText = `${i18n[lang]['sticker_text']} '${stageData.sticker}'`;
                // ì¼ë°˜ í´ë¦¬ì–´ ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ì€ ì›”ë“œë§µìœ¼ë¡œ
                document.getElementById('close-reward-modal-btn').onclick = () => {
                    playSound(clickSound, "C4");
                    showScreen('screen-world-map');
                };
            }
            showScreen('modal-reward');
        }

        // 5.2. ìŠ¤í‹°ì»¤ë¶ ë Œë”ë§
        function renderStickerbook() {
            const grid = document.getElementById('stickerbook-grid');
            const emptyMsg = document.getElementById('empty-stickerbook-msg');
            
            grid.innerHTML = '';
            
            if (gameState.collectedStickers.length === 0) {
                grid.appendChild(emptyMsg);
            } else {
                gameState.collectedStickers.forEach(stickerEmoji => {
                    const stickerDiv = document.createElement('div');
                    stickerDiv.className = 'game-card !p-2 text-4xl md:text-6xl text-center aspect-square flex items-center justify-center bg-white/50';
                    stickerDiv.innerText = stickerEmoji; 
                    grid.appendChild(stickerDiv);
                });
            }
        }
    </script>
</body>
</html>

