<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>ë ˆìŠ¤í† ì§€ë‹ˆ v1.0.1 (Cloud Fix)</title>
    
    <!-- Pretendard Webfont -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Markdown Parser (for AI responses) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root {
            --toss-blue: #3182F6;
            --toss-blue-light: #E8F3FF;
            --toss-grey-50: #F9FAFB;
            --toss-grey-100: #F2F4F6;
            --toss-grey-300: #D1D6DB;
            --toss-grey-500: #8B95A1;
            --toss-grey-700: #4E5968;
            --toss-grey-900: #191F28;
            --gemini-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
            background-color: var(--toss-grey-50);
            color: var(--toss-grey-900);
            -webkit-font-smoothing: antialiased;
        }

        /* Toss-like UI Components */
        .card {
            background: white;
            border-radius: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.02);
            border: 1px solid rgba(0,0,0,0.03);
        }

        .btn-primary {
            background-color: var(--toss-blue);
            color: white;
            font-weight: 600;
            border-radius: 12px;
            transition: 0.2s;
        }
        .btn-primary:hover { background-color: #1B64DA; }

        .btn-secondary {
            background-color: var(--toss-grey-100);
            color: var(--toss-grey-700);
            font-weight: 600;
            border-radius: 12px;
            transition: 0.2s;
        }
        .btn-secondary:hover { background-color: var(--toss-grey-300); }
        
        .btn-ai {
            background: var(--gemini-gradient);
            color: white;
            font-weight: 600;
            border-radius: 12px;
            border: none;
            transition: 0.2s;
            box-shadow: 0 4px 12px rgba(79, 172, 254, 0.3);
        }
        .btn-ai:hover { box-shadow: 0 6px 16px rgba(79, 172, 254, 0.5); transform: translateY(-1px); }

        .input-field {
            background-color: var(--toss-grey-50);
            border: 1px solid transparent;
            border-radius: 12px;
            padding: 12px 16px;
            width: 100%;
            transition: 0.2s;
            outline: none;
            font-size: 15px;
        }
        .input-field:focus {
            background-color: white;
            border-color: var(--toss-blue);
            box-shadow: 0 0 0 2px var(--toss-blue-light);
        }
        .input-field:disabled {
            background-color: var(--toss-grey-100);
            color: var(--toss-grey-500);
            cursor: not-allowed;
        }

        /* Loading Overlay */
        #global-loading {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--toss-blue);
        }

        /* Calendar Grid */
        .calendar-grid-week {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr);
            border-top: 1px solid var(--toss-grey-100);
            border-left: 1px solid var(--toss-grey-100);
            user-select: none;
        }
        .calendar-grid-month {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            border-top: 1px solid var(--toss-grey-100);
            border-left: 1px solid var(--toss-grey-100);
            height: 100%;
        }

        .calendar-header {
            background-color: white;
            font-weight: 600;
            text-align: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--toss-grey-100);
            border-right: 1px solid var(--toss-grey-100);
            color: var(--toss-grey-700);
        }
        .time-label {
            text-align: right;
            padding-right: 8px;
            font-size: 12px;
            color: var(--toss-grey-500);
            border-bottom: 1px solid var(--toss-grey-100);
            border-right: 1px solid var(--toss-grey-100);
            height: 48px; /* 1 hour height */
            position: relative;
            top: -6px;
        }
        .calendar-cell {
            background-color: white;
            border-bottom: 1px solid var(--toss-grey-100);
            border-right: 1px solid var(--toss-grey-100);
            cursor: pointer;
            position: relative;
        }
        .calendar-cell-week { height: 12px; }
        .calendar-cell-month {
            min-height: 100px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .calendar-cell-month:hover { background-color: var(--toss-grey-50); }
        .calendar-cell.hour-marker { border-bottom: 1px solid var(--toss-grey-300); }
        .calendar-cell:hover { background-color: var(--toss-blue-light); }
        .calendar-cell.selected { background-color: var(--toss-blue); opacity: 0.5; }

        .event-block {
            background-color: var(--toss-blue);
            color: white;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 11px;
            overflow: hidden;
            z-index: 10;
            pointer-events: auto;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .event-block.week { position: absolute; width: 90%; left: 5%; }
        .event-block.month { width: 100%; white-space: nowrap; text-overflow: ellipsis; }

        /* Modal Overlay */
        .modal-overlay { background-color: rgba(0, 0, 0, 0.4); backdrop-filter: blur(4px); }

        /* Chat Widget */
        .chat-widget { position: fixed; bottom: 24px; right: 24px; z-index: 50; display: flex; flex-direction: column; align-items: flex-end; }
        .chat-btn { width: 60px; height: 60px; border-radius: 30px; background: var(--gemini-gradient); color: white; display: flex; align-items: center; justify-content: center; font-size: 28px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); cursor: pointer; transition: 0.3s; }
        .chat-btn:hover { transform: scale(1.05); }
        .chat-window { width: 350px; height: 500px; background: white; border-radius: 24px; box-shadow: 0 8px 30px rgba(0,0,0,0.12); margin-bottom: 16px; display: none; flex-direction: column; overflow: hidden; border: 1px solid rgba(0,0,0,0.05); }
        .chat-header { background: var(--toss-grey-50); padding: 16px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--toss-grey-100); }
        .chat-messages { flex: 1; padding: 16px; overflow-y: auto; font-size: 14px; display: flex; flex-direction: column; gap: 12px; }
        .chat-input-area { padding: 12px; border-top: 1px solid var(--toss-grey-100); display: flex; gap: 8px; }
        .message { max-width: 80%; padding: 10px 14px; border-radius: 16px; line-height: 1.5; }
        .message.user { background-color: var(--toss-blue); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .message.ai { background-color: var(--toss-grey-100); color: var(--toss-grey-900); align-self: flex-start; border-bottom-left-radius: 4px; }
        .typing-indicator span { display: inline-block; width: 6px; height: 6px; background-color: #ccc; border-radius: 50%; animation: typing 1.4s infinite ease-in-out both; margin: 0 1px; }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; } .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        .spinner { border: 3px solid rgba(0,0,0,0.1); border-radius: 50%; border-top: 3px solid var(--toss-blue); width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .markdown-body ul { list-style-type: disc; padding-left: 20px; margin-bottom: 10px; }
        .markdown-body ol { list-style-type: decimal; padding-left: 20px; margin-bottom: 10px; }
        .markdown-body p { margin-bottom: 10px; }
        .markdown-body strong { font-weight: 700; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #E5E8EB; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #B0B8C1; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- Global Loading Overlay -->
    <div id="global-loading" class="hidden">
        <div class="spinner w-10 h-10 border-4 border-t-blue-600 mb-4"></div>
        <p>í´ë¼ìš°ë“œ ë™ê¸°í™” ì¤‘...</p>
    </div>

    <!-- API Setup Modal (First Run - Hidden by default if URL exists) -->
    <div id="modal-api-setup" class="fixed inset-0 z-[60] hidden bg-black/50 backdrop-blur-sm flex items-center justify-center">
        <div class="bg-white rounded-2xl p-8 w-full max-w-md shadow-2xl">
            <h2 class="text-2xl font-bold mb-4 text-gray-900">í´ë¼ìš°ë“œ ì—°ê²° ì„¤ì •</h2>
            <p class="text-gray-600 mb-4 text-sm">Google Apps Script ë°°í¬ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.<br>ì´ URLì€ ë¸Œë¼ìš°ì €ì— ì•ˆì „í•˜ê²Œ ì €ì¥ë©ë‹ˆë‹¤.</p>
            <input type="text" id="gas-url-input" class="input-field mb-4" placeholder="https://script.google.com/macros/s/...">
            <button onclick="saveApiUrl()" class="btn-primary w-full py-3">ì—°ê²°í•˜ê¸°</button>
            <div class="mt-4 text-xs text-gray-400 text-center">
                * ì„¤ì • > ë°°í¬ > ì›¹ ì•± > 'ì›¹ ì•± URL' ë³µì‚¬
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <aside class="w-64 bg-white border-r border-gray-100 flex-shrink-0 flex flex-col justify-between z-20">
        <div class="p-6">
            <h1 class="text-xl font-bold text-blue-500 mb-8 flex items-center gap-2 cursor-pointer" onclick="openApiSetup()">
                <i class="ph-fill ph-storefront"></i> ë ˆìŠ¤í† ì§€ë‹ˆ <span class="text-xs bg-blue-100 text-blue-600 px-1.5 py-0.5 rounded">v1.0.1</span>
            </h1>
            <nav class="space-y-2">
                <button onclick="switchTab('employees')" id="nav-employees" class="w-full text-left px-4 py-3 rounded-xl font-medium text-gray-600 hover:bg-gray-50 flex items-center gap-3">
                    <i class="ph ph-users text-xl"></i> ì§ì› ê´€ë¦¬
                </button>
                <button onclick="switchTab('schedule')" id="nav-schedule" class="w-full text-left px-4 py-3 rounded-xl font-medium text-gray-600 hover:bg-gray-50 flex items-center gap-3">
                    <i class="ph ph-calendar text-xl"></i> ê·¼ë¬´ ì¼ì •
                </button>
                <button onclick="switchTab('payroll')" id="nav-payroll" class="w-full text-left px-4 py-3 rounded-xl font-medium text-gray-600 hover:bg-gray-50 flex items-center gap-3">
                    <i class="ph ph-money text-xl"></i> ê¸‰ì—¬ ì •ì‚°
                </button>
            </nav>
        </div>
        <div class="p-6 border-t border-gray-100">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-500">
                    <i class="ph-fill ph-user"></i>
                </div>
                <div>
                    <p class="text-sm font-bold text-gray-900">ê´€ë¦¬ìë‹˜</p>
                    <p class="text-xs text-green-600 flex items-center gap-1"><i class="ph-fill ph-cloud-check"></i> Connected</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto bg-[#F9FAFB] relative" id="main-content">
        
        <!-- View: Employee Management -->
        <div id="view-employees" class="p-8 max-w-5xl mx-auto hidden">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900">ì§ì› ê´€ë¦¬</h2>
                    <p class="text-gray-500 mt-1">ë§¤ì¥ì˜ ì†Œì¤‘í•œ ë™ë£Œë“¤ì„ ë“±ë¡í•˜ê³  ê³„ì•½ì„ ê´€ë¦¬í•˜ì„¸ìš”.</p>
                </div>
                <button onclick="openEmployeeModal()" class="btn-primary px-5 py-3 flex items-center gap-2">
                    <i class="ph-bold ph-plus"></i> ì§ì› ë“±ë¡
                </button>
            </div>
            <div id="employee-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>

        <!-- View: Schedule -->
        <div id="view-schedule" class="flex h-full hidden">
            <div class="w-64 border-r border-gray-200 bg-white p-4 flex flex-col z-10">
                <h3 class="font-bold text-lg mb-4 flex items-center gap-2 px-2"><i class="ph-bold ph-users"></i> ì§ì› ëª©ë¡</h3>
                <div id="schedule-employee-list" class="space-y-1 overflow-y-auto flex-1"></div>
            </div>
            <div class="flex-1 flex flex-col bg-gray-50 relative">
                <div class="p-4 bg-white border-b border-gray-100 flex justify-between items-center shadow-sm z-10">
                    <div class="flex items-center gap-4">
                        <button onclick="changeDate(-1)" class="p-2 hover:bg-gray-100 rounded-lg text-gray-600"><i class="ph-bold ph-caret-left"></i></button>
                        <div class="relative group">
                            <span id="calendar-title" class="text-xl font-bold cursor-pointer hover:text-blue-500 transition-colors flex items-center gap-1"></span>
                            <input type="month" id="calendar-month-picker" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full" onchange="jumpToDate(this.value)">
                        </div>
                        <button onclick="changeDate(1)" class="p-2 hover:bg-gray-100 rounded-lg text-gray-600"><i class="ph-bold ph-caret-right"></i></button>
                    </div>
                    <div class="flex bg-gray-100 p-1 rounded-xl">
                        <button onclick="setScheduleView('month')" id="btn-view-month" class="px-4 py-1.5 rounded-lg text-sm font-medium transition-all">ì›”ê°„</button>
                        <button onclick="setScheduleView('week')" id="btn-view-week" class="px-4 py-1.5 rounded-lg text-sm font-medium transition-all">ì£¼ê°„</button>
                    </div>
                </div>
                <div class="flex-1 overflow-auto relative p-4" id="calendar-container">
                    <div id="calendar-grid-wrapper" class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden h-full"></div>
                </div>
            </div>
        </div>

        <!-- View: Payroll -->
        <div id="view-payroll" class="p-8 max-w-6xl mx-auto hidden">
             <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-2">ê¸‰ì—¬ ì •ì‚°</h2>
                    <p class="text-gray-500 mt-1">ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ë°ì´í„° ê¸°ë°˜ ì‹¤ì‹œê°„ ì •ì‚° ë‚´ì—­ì…ë‹ˆë‹¤.</p>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="generatePayrollReport()" class="btn-ai px-4 py-2 flex items-center gap-2 text-sm shadow-md hover:shadow-lg transition-all">
                        <i class="ph-fill ph-sparkle"></i> AI ê¸‰ì—¬ ë¶„ì„
                    </button>
                    <input type="month" id="payroll-month" class="input-field w-40" onchange="renderPayroll()">
                </div>
            </div>
            <div id="ai-report-container" class="hidden mb-6 card p-6 bg-gradient-to-r from-blue-50 to-white border-blue-100">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex items-center gap-2"><i class="ph-fill ph-sparkle text-blue-500 text-xl"></i><h3 class="font-bold text-lg text-gray-800">AI ê²½ì˜ ë¶„ì„ ë¦¬í¬íŠ¸</h3></div>
                    <button onclick="closeAiReport()" class="text-gray-400 hover:text-gray-600"><i class="ph-bold ph-x"></i></button>
                </div>
                <div id="ai-report-content" class="markdown-body text-sm text-gray-700 leading-relaxed"></div>
            </div>
            <div id="payroll-list" class="space-y-6"></div>
        </div>
    </main>

    <!-- Chat Widget -->
    <div class="chat-widget">
        <div class="chat-window" id="chat-window">
            <div class="chat-header"><div class="flex items-center gap-2"><i class="ph-fill ph-robot text-blue-500 text-xl"></i><span>AI ë…¸ë¬´ì‚¬</span></div><button onclick="toggleChat()" class="text-gray-400 hover:text-gray-600"><i class="ph-bold ph-x"></i></button></div>
            <div class="chat-messages" id="chat-messages"><div class="message ai">ì•ˆë…•í•˜ì„¸ìš”! ì‚¬ì¥ë‹˜. ğŸ‘‹<br>ê¶ê¸ˆí•œ ë…¸ë¬´ ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</div></div>
            <div class="chat-input-area"><input type="text" id="chat-input" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." class="flex-1 bg-gray-50 rounded-xl px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-100" onkeypress="handleChatKey(event)"><button onclick="sendMessage()" class="bg-blue-500 text-white rounded-xl w-10 h-10 flex items-center justify-center hover:bg-blue-600 transition"><i class="ph-bold ph-paper-plane-right"></i></button></div>
        </div>
        <div class="chat-btn" onclick="toggleChat()"><i class="ph-fill ph-chat-teardrop-text"></i></div>
    </div>

    <!-- Employee Modal -->
    <div id="modal-employee" class="fixed inset-0 z-50 hidden modal-overlay flex items-center justify-center">
        <div class="bg-white rounded-3xl w-full max-w-2xl p-8 shadow-2xl max-h-[95vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold" id="modal-employee-title">ì§ì› ë“±ë¡</h3>
                <button onclick="closeEmployeeModal()" class="p-2 hover:bg-gray-100 rounded-full"><i class="ph-bold ph-x"></i></button>
            </div>
            <form id="employee-form" onsubmit="saveEmployee(event)" class="space-y-6">
                <input type="hidden" id="emp-id">
                <div>
                    <h4 class="text-sm font-bold text-gray-900 mb-3 flex items-center gap-1"><i class="ph-fill ph-user"></i> ì¸ì  ì‚¬í•­</h4>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">ì´ë¦„</label><input type="text" id="emp-name" required class="input-field" placeholder="ê¹€í† ìŠ¤"></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸</label><div class="flex items-center gap-2"><input type="text" id="emp-rrn-front" maxlength="6" class="input-field w-1/2" placeholder="ìƒë…„ì›”ì¼"><span>-</span><input type="password" id="emp-rrn-back" maxlength="7" class="input-field w-1/2" placeholder="ë’¤ 7ìë¦¬"></div></div>
                    </div>
                    <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-1">ì£¼ì†Œ</label><input type="text" id="emp-address" placeholder="ì„œìš¸ì‹œ ê°•ë‚¨êµ¬..." class="input-field"></div>
                </div>
                <div class="border-t border-gray-100 my-4"></div>
                <div>
                    <h4 class="text-sm font-bold text-gray-900 mb-3 flex items-center gap-1"><i class="ph-fill ph-briefcase"></i> ê·¼ë¬´ ì •ë³´</h4>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">ì…ì‚¬ì¼</label><input type="date" id="emp-join-date" required class="input-field"></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">í‡´ì‚¬ì¼</label><input type="date" id="emp-leave-date" disabled class="input-field"><div class="mt-2 flex items-center gap-2"><input type="checkbox" id="emp-is-working" checked onchange="toggleLeaveDate()" class="w-4 h-4 text-blue-600 rounded"><label for="emp-is-working" class="text-sm text-gray-600">í˜„ì¬ ì¬ì§ ì¤‘</label></div></div>
                    </div>
                    <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-1">ì§ì±…</label><select id="emp-role" class="input-field"><option value="staff">ì¼ë°˜ ì§ì›</option><option value="manager">ë§¤ë‹ˆì €</option><option value="owner">ì ì¥</option></select></div>
                    <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">ìš”ì¼ë³„ ê·¼ë¬´ ì‹œê°„ (ê¸°ë³¸ ìŠ¤ì¼€ì¤„)</label><div class="bg-gray-50 p-4 rounded-xl border border-gray-100 space-y-2"><div id="work-schedule-rows" class="space-y-2 text-sm"></div></div></div>
                </div>
                <div class="border-t border-gray-100 my-4"></div>
                <div>
                    <h4 class="text-sm font-bold text-gray-900 mb-3 flex items-center gap-1"><i class="ph-fill ph-money"></i> ê¸‰ì—¬ ë° ê³„ì•½</h4>
                    <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-1">ê³„ì•½ í˜•íƒœ</label><select id="emp-type" class="input-field" onchange="updateAllowancePreview()"><option value="hourly">ì‹œê¸‰ì œ (íŒŒíŠ¸íƒ€ì„)</option><option value="monthly">ì›”ê¸‰ì œ (ì •ê·œ/ê³„ì•½)</option></select></div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                         <div><label class="block text-sm font-medium text-gray-700 mb-1" id="label-pay">ê¸°ë³¸ê¸‰</label><div class="relative"><input type="number" id="emp-pay" required class="input-field pr-8" placeholder="0"><span class="absolute right-3 top-3 text-gray-500 text-sm">ì›</span></div></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">ìˆ˜ë‹¹ (ì§ì ‘ ì…ë ¥)</label><div class="relative"><input type="number" id="emp-allowance-manual" class="input-field pr-8" placeholder="0"><span class="absolute right-3 top-3 text-gray-500 text-sm">ì›</span></div><p class="text-xs text-gray-500 mt-1" id="allowance-hint">ì‹œê¸‰ì œ: ì‹œê°„ë‹¹ ì¶”ê°€ / ì›”ê¸‰ì œ: ì›” ì¶”ê°€</p></div>
                    </div>
                    <div id="hourly-options" class="mb-4 bg-blue-50 p-3 rounded-lg hidden"><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="emp-juhyu-included" class="w-4 h-4 text-blue-600 rounded"><span class="text-sm text-blue-800 font-medium">ì…ë ¥í•œ ì‹œê¸‰ì— ì£¼íœ´ìˆ˜ë‹¹ í¬í•¨</span></label><p class="text-xs text-blue-600 mt-1 ml-6">* ì²´í¬ ì‹œ ê¸°ë³¸ê¸‰ì„ ì—­ì‚°í•˜ì—¬ ê³„ì‚°í•©ë‹ˆë‹¤ (ì•½ Ã·1.2)</p></div>
                     <div><label class="block text-sm font-medium text-gray-700 mb-1">ë³´í—˜ ì ìš©</label><select id="emp-insurance" class="input-field"><option value="4major">4ëŒ€ë³´í—˜ (êµ­ë¯¼,ê±´ê°•,ê³ ìš©,ì‚°ì¬)</option><option value="2major">2ëŒ€ë³´í—˜ (ê³ ìš©,ì‚°ì¬)</option><option value="freelance">í”„ë¦¬ëœì„œ (3.3%)</option></select></div>
                </div>
                <div class="border-t border-gray-100 my-4"></div>
                <div>
                    <h4 class="text-sm font-bold text-gray-900 mb-3 flex items-center gap-1"><i class="ph-fill ph-credit-card"></i> ê³„ì¢Œ ì •ë³´</h4>
                    <div class="grid grid-cols-3 gap-2">
                        <select id="emp-bank-name" class="input-field"><option value="">ì€í–‰ ì„ íƒ</option><option value="KBêµ­ë¯¼">KBêµ­ë¯¼</option><option value="ì‹ í•œ">ì‹ í•œ</option><option value="ìš°ë¦¬">ìš°ë¦¬</option><option value="í•˜ë‚˜">í•˜ë‚˜</option><option value="NHë†í˜‘">NHë†í˜‘</option><option value="IBKê¸°ì—…">IBKê¸°ì—…</option><option value="í† ìŠ¤ë±…í¬">í† ìŠ¤ë±…í¬</option><option value="ì¹´ì¹´ì˜¤ë±…í¬">ì¹´ì¹´ì˜¤ë±…í¬</option><option value="ì¼€ì´ë±…í¬">ì¼€ì´ë±…í¬</option><option value="SCì œì¼">SCì œì¼</option><option value="ìš°ì²´êµ­">ìš°ì²´êµ­</option><option value="ë¶€ì‚°">ë¶€ì‚°</option><option value="ëŒ€êµ¬">ëŒ€êµ¬</option><option value="ìƒˆë§ˆì„">ìƒˆë§ˆì„</option><option value="ì‹ í˜‘">ì‹ í˜‘</option></select>
                        <input type="text" id="emp-account-number" placeholder="ê³„ì¢Œë²ˆí˜¸ (- ì œì™¸)" class="input-field col-span-2">
                    </div>
                    <div class="mt-2"><input type="text" id="emp-account-holder" placeholder="ì˜ˆê¸ˆì£¼" class="input-field"></div>
                </div>
                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="deleteEmployee()" id="btn-delete-emp" class="btn-secondary w-1/3 hidden text-red-500 bg-red-50 hover:bg-red-100">ì‚­ì œ</button>
                    <button type="submit" class="btn-primary flex-1 py-3 text-lg">ì €ì¥í•˜ê¸°</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Schedule Detail -->
    <div id="modal-schedule" class="fixed inset-0 z-50 hidden modal-overlay flex items-center justify-center">
        <div class="bg-white rounded-3xl w-80 p-6 shadow-xl">
             <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold" id="modal-schedule-title">ê·¼ë¬´ ì‹œê°„ ìˆ˜ì •</h3><button onclick="closeScheduleModal()" class="p-1"><i class="ph-bold ph-x"></i></button></div>
            <form onsubmit="saveScheduleDetail(event)">
                <input type="hidden" id="sch-date"><p id="sch-date-display" class="text-sm text-gray-500 mb-3 text-center"></p>
                <div class="space-y-3">
                    <div><label class="text-xs text-gray-500">ì‹œì‘ ì‹œê°„</label><input type="time" id="sch-start" required class="input-field"></div>
                    <div><label class="text-xs text-gray-500">ì¢…ë£Œ ì‹œê°„</label><input type="time" id="sch-end" required class="input-field"></div>
                </div>
                <div class="flex gap-2 mt-4"><button type="button" id="btn-delete-schedule" onclick="deleteScheduleDetail()" class="flex-1 btn-secondary text-red-500 bg-red-50">ì‚­ì œ</button><button type="submit" class="flex-1 btn-primary">ì €ì¥</button></div>
            </form>
        </div>
    </div>

    <script>
        // --- Configuration & Cloud Sync ---
        // v1.0.1 Update: Changed storage key to force refresh URL for users with old cached URL
        const STORAGE_KEY_URL = 'rg_api_url_v1_0_1';
        let API_URL = localStorage.getItem(STORAGE_KEY_URL) || 'https://script.google.com/macros/s/AKfycbw964noWTdqm_01XB7ujPtQLCYKxGOsUZd0iGcpferVOjKiwdR4KdPTWE4RB50bhXaFwg/exec';
        const apiKey = ""; 

        const state = {
            employees: [],
            schedules: [],
            currentView: 'employees',
            scheduleViewMode: 'month',
            currentDate: new Date(),
            selectedEmpIdForSchedule: null,
            dragStart: null,
        };

        async function apiCall(op, payload = {}, id = null) {
            if (!API_URL) {
                openApiSetup();
                return null;
            }
            showLoading(true);
            
            // 15ì´ˆ íƒ€ì„ì•„ì›ƒ ì„¤ì • (ë¬´í•œ ë¡œë”© ë°©ì§€)
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000);

            try {
                let response;
                const fetchOptions = {
                    signal: controller.signal,
                    redirect: 'follow'
                };

                if (op === 'init') {
                    response = await fetch(`${API_URL}?op=init`, { method: 'GET', ...fetchOptions });
                } else {
                    response = await fetch(API_URL, {
                        method: 'POST',
                        mode: 'cors',
                        headers: { 'Content-Type': 'text/plain' }, // GASëŠ” text/plainì„ ì„ í˜¸
                        body: JSON.stringify({ op, payload, id }),
                        ...fetchOptions
                    });
                }
                
                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ (${response.status})`);
                }
                
                // Safe JSON Parsing to prevent silent failures on HTML error pages
                const text = await response.text();
                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    throw new Error("ì„œë²„ ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (HTML ë°˜í™˜ë¨ - ë°°í¬ ê¶Œí•œì„ 'ëª¨ë“  ì‚¬ìš©ì'ë¡œ ì„¤ì •í–ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”)");
                }

                if (data.error) throw new Error(data.error);
                return data;

            } catch (err) {
                console.error("API Call Error:", err);
                let msg = err.message;
                if (err.name === 'AbortError') {
                    msg = 'ì„œë²„ ì‘ë‹µ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. (15ì´ˆ)';
                } else if (msg.includes('Failed to fetch')) {
                    msg = 'ì„œë²„ ì—°ê²° ì‹¤íŒ¨. ë°°í¬ ê¶Œí•œì´ "ëª¨ë“  ì‚¬ìš©ì"ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.';
                }
                alert(`ë™ê¸°í™” ì‹¤íŒ¨: ${msg}`);
                return null;
            } finally {
                showLoading(false); // ë¬´ì¡°ê±´ ë¡œë”© ì¢…ë£Œ
            }
        }

        function showLoading(show) { document.getElementById('global-loading').classList.toggle('hidden', !show); }
        function openApiSetup() { document.getElementById('modal-api-setup').classList.remove('hidden'); document.getElementById('gas-url-input').value = API_URL; }
        function saveApiUrl() {
            const url = document.getElementById('gas-url-input').value.trim();
            if (url) { localStorage.setItem(STORAGE_KEY_URL, url); API_URL = url; document.getElementById('modal-api-setup').classList.add('hidden'); initApp(); }
        }

        async function initApp() {
            if (!API_URL) { openApiSetup(); return; }
            const data = await apiCall('init');
            if (data) {
                state.employees = data.employees || [];
                state.schedules = data.schedules || [];
                document.getElementById('payroll-month').value = new Date().toISOString().slice(0, 7);
                if (state.employees.length > 0) state.selectedEmpIdForSchedule = state.employees[0].id;
                switchTab(state.currentView);
            }
        }
        document.addEventListener('DOMContentLoaded', initApp);

        // --- Routing ---
        function switchTab(tab) {
            state.currentView = tab;
            document.querySelectorAll('main > div').forEach(d => d.classList.add('hidden'));
            const view = document.getElementById(`view-${tab}`);
            if(view) view.classList.remove('hidden');
            document.querySelectorAll('aside nav button').forEach(b => { b.className = 'w-full text-left px-4 py-3 rounded-xl font-medium text-gray-600 hover:bg-gray-50 flex items-center gap-3'; });
            document.getElementById(`nav-${tab}`).className = 'w-full text-left px-4 py-3 rounded-xl font-medium text-blue-600 bg-blue-50 flex items-center gap-3';
            if (tab === 'employees') renderEmployeeList();
            if (tab === 'schedule') { renderScheduleSidebar(); renderCalendar(); }
            if (tab === 'payroll') renderPayroll();
        }

        // --- Core Logic Helpers ---
        function generateId() { return Math.random().toString(36).substr(2, 9); }
        function getMonday(d) { d = new Date(d); var day = d.getDay(), diff = d.getDate() - day + (day == 0 ? -6 : 1); return new Date(d.setDate(diff)); }
        function addDays(d, days) { var date = new Date(d.valueOf()); date.setDate(date.getDate() + days); return date; }
        function formatDate(d) { return d.toISOString().split('T')[0]; }
        function formatMoney(n) { return Math.ceil(n).toLocaleString() + 'ì›'; }

        // --- Employee Logic ---
        function renderEmployeeList() {
            const container = document.getElementById('employee-list'); container.innerHTML = '';
            if (state.employees.length === 0) { container.innerHTML = `<div class="col-span-2 text-center py-20 text-gray-400">ë“±ë¡ëœ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>`; return; }
            state.employees.forEach(emp => {
                const el = document.createElement('div'); el.className = 'card p-6 cursor-pointer hover:border-blue-200 transition'; el.onclick = () => openEmployeeModal(emp.id);
                let badgeColor = emp.type === 'monthly' ? 'bg-purple-100 text-purple-600' : 'bg-green-100 text-green-600';
                let typeText = emp.type === 'monthly' ? 'ì›”ê¸‰ì œ' : 'ì‹œê¸‰ì œ';
                el.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div><div class="flex items-center gap-2 mb-1"><h3 class="text-lg font-bold text-gray-900">${emp.name}</h3><span class="text-xs px-2 py-1 rounded-full ${badgeColor} font-bold">${typeText}</span></div><p class="text-sm text-gray-500">${emp.role === 'manager' ? 'ë§¤ë‹ˆì €' : emp.role === 'owner' ? 'ì ì¥' : 'ìŠ¤íƒœí”„'} Â· ${emp.joinDate} ì…ì‚¬</p></div>
                        <button class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-400 hover:bg-gray-100 hover:text-blue-500"><i class="ph-bold ph-pencil-simple"></i></button>
                    </div>
                    <div class="text-right"><p class="text-xs text-gray-500 mb-1">ê¸°ë³¸ê¸‰ì—¬</p><p class="text-lg font-bold text-gray-900">${formatMoney(emp.pay)}</p></div>`;
                container.appendChild(el);
            });
        }
        function openEmployeeModal(id = null) {
            const form = document.getElementById('employee-form'); form.reset(); document.getElementById('modal-employee').classList.remove('hidden');
            let scheduleData = null;
            if (id) {
                const emp = state.employees.find(e => e.id === id);
                document.getElementById('modal-employee-title').innerText = 'ì§ì› ì •ë³´ ìˆ˜ì •';
                document.getElementById('emp-id').value = emp.id;
                document.getElementById('emp-name').value = emp.name;
                if (emp.rrn && emp.rrn.includes('-')) { const [front, back] = emp.rrn.split('-'); document.getElementById('emp-rrn-front').value = front; document.getElementById('emp-rrn-back').value = back; }
                document.getElementById('emp-address').value = emp.address || '';
                document.getElementById('emp-join-date').value = emp.joinDate;
                document.getElementById('emp-leave-date').value = emp.leaveDate || '';
                document.getElementById('emp-is-working').checked = !emp.leaveDate;
                toggleLeaveDate();
                document.getElementById('emp-role').value = emp.role;
                document.getElementById('emp-type').value = emp.type;
                document.getElementById('emp-pay').value = emp.pay;
                document.getElementById('emp-allowance-manual').value = emp.manualAllowance || '';
                document.getElementById('emp-juhyu-included').checked = emp.juhyuIncluded || false;
                document.getElementById('emp-insurance').value = emp.insurance;
                document.getElementById('emp-bank-name').value = emp.bankName || '';
                document.getElementById('emp-account-number').value = emp.accountNumber || '';
                document.getElementById('emp-account-holder').value = emp.accountHolder || '';
                scheduleData = emp.workSchedule;
                document.getElementById('btn-delete-emp').classList.remove('hidden');
            } else {
                document.getElementById('modal-employee-title').innerText = 'ì§ì› ë“±ë¡';
                document.getElementById('emp-id').value = '';
                document.getElementById('emp-is-working').checked = true;
                toggleLeaveDate();
                document.getElementById('btn-delete-emp').classList.add('hidden');
            }
            updateAllowancePreview();
            renderScheduleRows(scheduleData);
        }
        function toggleLeaveDate() { const isWorking = document.getElementById('emp-is-working').checked; document.getElementById('emp-leave-date').disabled = isWorking; if (isWorking) document.getElementById('emp-leave-date').value = ''; }
        function updateAllowancePreview() {
            const type = document.getElementById('emp-type').value; const payLabel = document.getElementById('label-pay'); const hint = document.getElementById('allowance-hint'); const hourlyOptions = document.getElementById('hourly-options');
            if (type === 'monthly') { payLabel.innerText = 'ì›” ê¸°ë³¸ê¸‰'; hint.innerText = 'ì›” ë‹¨ìœ„ ì¶”ê°€ ì§€ê¸‰ì•¡'; hourlyOptions.classList.add('hidden'); }
            else { payLabel.innerText = 'ê¸°ë³¸ ì‹œê¸‰'; hint.innerText = 'ì‹œê°„ë‹¹ ì¶”ê°€ ì§€ê¸‰ì•¡'; hourlyOptions.classList.remove('hidden'); }
        }
        function renderScheduleRows(scheduleData) {
            const container = document.getElementById('work-schedule-rows'); container.innerHTML = '';
            const days = [{ id: 'mon', label: 'ì›”' }, { id: 'tue', label: 'í™”' }, { id: 'wed', label: 'ìˆ˜' }, { id: 'thu', label: 'ëª©' }, { id: 'fri', label: 'ê¸ˆ' }, { id: 'sat', label: 'í† ' }, { id: 'sun', label: 'ì¼' }];
            days.forEach(day => {
                const saved = scheduleData ? scheduleData.find(s => s.day === day.id) : null;
                const isActive = saved ? saved.active : false; const start = saved ? saved.start : '09:00'; const end = saved ? saved.end : '18:00';
                const row = document.createElement('div'); row.className = 'flex items-center gap-3';
                row.innerHTML = `<div class="w-12"><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" class="sch-day-check w-4 h-4 text-blue-600 rounded" data-day="${day.id}" ${isActive ? 'checked' : ''}><span>${day.label}</span></label></div><div class="flex-1 flex gap-2"><input type="time" class="sch-start input-field py-1 text-sm" value="${start}" ${!isActive ? 'disabled' : ''}><input type="time" class="sch-end input-field py-1 text-sm" value="${end}" ${!isActive ? 'disabled' : ''}></div>`;
                const cb = row.querySelector('.sch-day-check'); const inputs = row.querySelectorAll('input[type="time"]');
                cb.addEventListener('change', (e) => { inputs.forEach(inp => inp.disabled = !e.target.checked); });
                container.appendChild(row);
            });
        }
        function closeEmployeeModal() { document.getElementById('modal-employee').classList.add('hidden'); }
        async function saveEmployee(e) {
            e.preventDefault();
            const id = document.getElementById('emp-id').value;
            const scheduleRows = document.querySelectorAll('#work-schedule-rows > div');
            const workSchedule = Array.from(scheduleRows).map(row => { const cb = row.querySelector('.sch-day-check'); return { day: cb.dataset.day, active: cb.checked, start: row.querySelector('.sch-start').value, end: row.querySelector('.sch-end').value }; });
            const rrnFront = document.getElementById('emp-rrn-front').value; const rrnBack = document.getElementById('emp-rrn-back').value;
            const rrn = (rrnFront && rrnBack) ? `${rrnFront}-${rrnBack}` : '';
            const empData = {
                id: id || generateId(),
                name: document.getElementById('emp-name').value,
                rrn: rrn,
                address: document.getElementById('emp-address').value,
                joinDate: document.getElementById('emp-join-date').value,
                leaveDate: document.getElementById('emp-is-working').checked ? '' : document.getElementById('emp-leave-date').value,
                role: document.getElementById('emp-role').value,
                type: document.getElementById('emp-type').value,
                pay: parseInt(document.getElementById('emp-pay').value) || 0,
                manualAllowance: parseInt(document.getElementById('emp-allowance-manual').value) || 0,
                juhyuIncluded: document.getElementById('emp-juhyu-included').checked,
                insurance: document.getElementById('emp-insurance').value,
                bankName: document.getElementById('emp-bank-name').value,
                accountNumber: document.getElementById('emp-account-number').value,
                accountHolder: document.getElementById('emp-account-holder').value,
                workSchedule: workSchedule
            };
            const res = await apiCall('save_employee', empData);
            if (res && res.success) { state.employees = res.employees; closeEmployeeModal(); renderEmployeeList(); }
        }
        async function deleteEmployee() {
            const id = document.getElementById('emp-id').value;
            if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            const res = await apiCall('delete_employee', {}, id);
            if (res && res.success) { state.employees = res.employees; state.schedules = state.schedules.filter(s => s.employeeId !== id); closeEmployeeModal(); renderEmployeeList(); }
        }

        // --- Schedule Logic ---
        function setScheduleView(view) {
            state.scheduleViewMode = view;
            const btnMonth = document.getElementById('btn-view-month'); const btnWeek = document.getElementById('btn-view-week');
            if (view === 'month') { btnMonth.classList.add('bg-white', 'text-blue-600', 'shadow-sm'); btnMonth.classList.remove('text-gray-500'); btnWeek.classList.remove('bg-white', 'text-blue-600', 'shadow-sm'); btnWeek.classList.add('text-gray-500'); } 
            else { btnWeek.classList.add('bg-white', 'text-blue-600', 'shadow-sm'); btnWeek.classList.remove('text-gray-500'); btnMonth.classList.remove('bg-white', 'text-blue-600', 'shadow-sm'); btnMonth.classList.add('text-gray-500'); }
            renderCalendar();
        }
        function changeDate(offset) {
            if (state.scheduleViewMode === 'month') state.currentDate.setMonth(state.currentDate.getMonth() + offset);
            else state.currentDate.setDate(state.currentDate.getDate() + (offset * 7));
            renderCalendar();
        }
        function jumpToDate(val) { if(!val) return; state.currentDate = new Date(val + '-01'); setScheduleView('month'); renderCalendar(); }
        function renderScheduleSidebar() {
            const list = document.getElementById('schedule-employee-list'); list.innerHTML = '';
            if (state.employees.length === 0) { list.innerHTML = '<div class="p-4 text-xs text-gray-400 text-center">ë“±ë¡ëœ ì§ì› ì—†ìŒ</div>'; return; }
            state.employees.forEach(emp => {
                const item = document.createElement('div'); const isSelected = emp.id === state.selectedEmpIdForSchedule;
                item.className = `p-3 rounded-lg cursor-pointer flex items-center justify-between text-sm transition-all ${isSelected ? 'bg-blue-50 text-blue-600 font-bold border border-blue-100' : 'hover:bg-gray-50 text-gray-600'}`;
                item.onclick = () => { state.selectedEmpIdForSchedule = emp.id; renderScheduleSidebar(); renderCalendar(); };
                item.innerHTML = `<span>${emp.name}</span><span class="text-xs opacity-70">${emp.role === 'manager' ? 'M' : emp.role === 'owner' ? 'O' : 'S'}</span>`;
                list.appendChild(item);
            });
            if (!state.selectedEmpIdForSchedule && state.employees.length > 0) { state.selectedEmpIdForSchedule = state.employees[0].id; renderScheduleSidebar(); }
        }
        function renderCalendar() {
            const gridWrapper = document.getElementById('calendar-grid-wrapper'); gridWrapper.innerHTML = '';
            const empId = state.selectedEmpIdForSchedule;
            const titleEl = document.getElementById('calendar-title');
            if (state.scheduleViewMode === 'month') titleEl.innerHTML = `<i class="ph-bold ph-calendar"></i> ${state.currentDate.getFullYear()}ë…„ ${state.currentDate.getMonth() + 1}ì›”`;
            else { const start = getMonday(state.currentDate); const end = addDays(start, 6); titleEl.innerHTML = `<i class="ph-bold ph-calendar"></i> ${start.getMonth()+1}.${start.getDate()} - ${end.getMonth()+1}.${end.getDate()}`; }
            if (!empId) { gridWrapper.innerHTML = '<div class="flex items-center justify-center h-full text-gray-400">ì§ì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”</div>'; return; }
            if (state.scheduleViewMode === 'month') renderMonthView(gridWrapper, empId); else renderWeekView(gridWrapper, empId);
        }
        function renderMonthView(container, empId) {
            const grid = document.createElement('div'); grid.className = 'calendar-grid-month'; container.appendChild(grid);
            const days = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼']; days.forEach(d => { const dh = document.createElement('div'); dh.className = 'calendar-header text-sm py-2 bg-gray-50'; dh.innerText = d; grid.appendChild(dh); });
            const year = state.currentDate.getFullYear(); const month = state.currentDate.getMonth(); const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startDay = new Date(year, month, 1).getDay(); const gridStartCol = startDay === 0 ? 6 : startDay - 1;
            for(let i=0; i<gridStartCol; i++) { grid.appendChild(document.createElement('div')).className = 'calendar-cell bg-gray-50/30'; }
            for(let d=1; d<=daysInMonth; d++) {
                const cell = document.createElement('div'); cell.className = 'calendar-cell-month border-b border-r border-gray-100 cursor-pointer transition hover:bg-blue-50';
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                cell.innerHTML = `<div class="text-sm font-medium text-gray-700 mb-1 ${dateStr === formatDate(new Date()) ? 'bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center' : ''}">${d}</div>`;
                const events = state.schedules.filter(s => s.employeeId === empId && s.date === dateStr);
                events.forEach(ev => { const tag = document.createElement('div'); tag.className = 'event-block month text-xs'; tag.innerText = `${ev.start}~${ev.end}`; tag.onclick = (e) => { e.stopPropagation(); openScheduleDetail(ev.id); }; cell.appendChild(tag); });
                cell.onclick = () => { openScheduleDetail(null, dateStr); }; grid.appendChild(cell);
            }
        }
        function renderWeekView(container, empId) {
            const grid = document.createElement('div'); grid.className = 'calendar-grid-week'; container.appendChild(grid);
            const weekStart = getMonday(state.currentDate); const days = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼']; const dates = [];
            grid.appendChild(document.createElement('div')).className = 'calendar-header';
            for(let i=0; i<7; i++) { const d = addDays(weekStart, i); dates.push(formatDate(d)); const h = document.createElement('div'); h.className = 'calendar-header'; h.innerHTML = `<div>${days[i]}</div><div class="text-xs font-normal mt-1">${d.getDate()}</div>`; grid.appendChild(h); }
            for (let hour = 0; hour < 24; hour++) {
                const label = document.createElement('div'); label.className = 'time-label'; label.innerText = String(hour).padStart(2,'0'); label.style.gridRow = 'span 4'; grid.appendChild(label);
                for (let q = 0; q < 4; q++) { for (let day = 0; day < 7; day++) {
                    const c = document.createElement('div'); c.className = `calendar-cell calendar-cell-week ${q===3?'hour-marker':''}`;
                    const dateStr = dates[day]; const timeStr = `${String(hour).padStart(2,'0')}:${String(q*15).padStart(2,'0')}`;
                    c.dataset.date = dateStr; c.dataset.time = timeStr; c.onclick = () => openScheduleDetail(null, dateStr); grid.appendChild(c);
                }}
            }
            state.schedules.filter(s => s.employeeId === empId).forEach(sch => {
                if (dates.includes(sch.date)) {
                    const [sh, sm] = sch.start.split(':').map(Number); const [eh, em] = sch.end.split(':').map(Number);
                    const durationMins = (eh * 60 + em) - (sh * 60 + sm);
                    const startCell = grid.querySelector(`.calendar-cell[data-date="${sch.date}"][data-time="${sch.start}"]`);
                    if (startCell) {
                        const el = document.createElement('div'); el.className = 'event-block week hover:bg-blue-600 transition cursor-pointer flex items-center justify-center shadow-md';
                        el.innerText = `${sch.start}~${sch.end}`; el.style.height = `${(durationMins/15)*12}px`; el.style.top = '0';
                        el.onclick = (e) => { e.stopPropagation(); openScheduleDetail(sch.id); }; startCell.appendChild(el);
                    }
                }
            });
        }
        function openScheduleDetail(schId, newDate = null) {
            const modal = document.getElementById('modal-schedule'); const form = modal.querySelector('form'); form.reset();
            document.getElementById('modal-schedule-title').innerText = schId ? 'ê·¼ë¬´ ì‹œê°„ ìˆ˜ì •' : 'ê·¼ë¬´ ì¶”ê°€'; document.getElementById('btn-delete-schedule').classList.toggle('hidden', !schId);
            if (schId) { const sch = state.schedules.find(s => s.id === schId); if (!sch) return; modal.dataset.schId = schId; modal.dataset.mode = 'edit'; document.getElementById('sch-date').value = sch.date; document.getElementById('sch-date-display').innerText = sch.date; document.getElementById('sch-start').value = sch.start; document.getElementById('sch-end').value = sch.end; }
            else { modal.dataset.schId = ''; modal.dataset.mode = 'create'; document.getElementById('sch-date').value = newDate; document.getElementById('sch-date-display').innerText = newDate; document.getElementById('sch-start').value = '09:00'; document.getElementById('sch-end').value = '18:00'; }
            modal.classList.remove('hidden');
        }
        function closeScheduleModal() { document.getElementById('modal-schedule').classList.add('hidden'); }
        async function saveScheduleDetail(e) {
            e.preventDefault(); const modal = document.getElementById('modal-schedule');
            const schData = {
                id: modal.dataset.mode === 'edit' ? modal.dataset.schId : generateId(),
                employeeId: state.selectedEmpIdForSchedule,
                date: document.getElementById('sch-date').value,
                start: document.getElementById('sch-start').value,
                end: document.getElementById('sch-end').value
            };
            const res = await apiCall('save_schedule', schData);
            if(res && res.success) { state.schedules = res.schedules; renderCalendar(); closeScheduleModal(); }
        }
        async function deleteScheduleDetail() {
            const id = document.getElementById('modal-schedule').dataset.schId;
            const res = await apiCall('delete_schedule', {}, id);
            if(res && res.success) { state.schedules = res.schedules; renderCalendar(); closeScheduleModal(); }
        }

        // --- Payroll & AI ---
        function renderPayroll() {
            const container = document.getElementById('payroll-list'); container.innerHTML = '';
            const monthStr = document.getElementById('payroll-month').value; if (!monthStr) return;
            const [year, month] = monthStr.split('-').map(Number); const daysInMonth = new Date(year, month, 0).getDate();
            let workDaysInMonth = 0; for(let d=1; d<=daysInMonth; d++) { const day = new Date(year, month-1, d).getDay(); if (day >= 1 && day <= 5) workDaysInMonth++; }
            state.employees.forEach(emp => {
                const calc = calculateMonthlyPayroll(emp, year, month, workDaysInMonth);
                const el = document.createElement('div'); el.className = 'card p-6';
                let detailsHtml = ''; calc.dailyLogs.forEach(log => { detailsHtml += `<tr class="border-b border-gray-100 text-sm"><td class="py-2">${log.date}</td><td class="py-2 ${log.status === 'ê²°ê·¼' ? 'text-red-500' : ''}">${log.timeStr}</td><td class="py-2 text-right">${log.workHours}h</td><td class="py-2 text-right text-gray-500">${formatMoney(log.basePay)}</td><td class="py-2 text-right text-blue-500">${log.juhyuPay > 0 ? formatMoney(log.juhyuPay) : '-'}</td><td class="py-2 text-right font-bold">${formatMoney(log.total)}</td></tr>${log.note ? `<tr><td colspan="6" class="text-xs text-gray-400 pb-2 text-right">${log.note}</td></tr>` : ''}`; });
                el.innerHTML = `<div class="flex justify-between items-center mb-4"><div class="flex items-center gap-3"><h3 class="text-xl font-bold">${emp.name}</h3><span class="text-sm bg-gray-100 px-2 py-1 rounded text-gray-600">${emp.type === 'monthly' ? 'ì›”ê¸‰' : 'ì‹œê¸‰'}</span></div><div class="text-right"><p class="text-sm text-gray-500">ì‹¤ ìˆ˜ë ¹ì•¡</p><p class="text-2xl font-bold text-blue-600">${formatMoney(calc.netPay)}</p></div></div><div class="grid grid-cols-3 gap-4 mb-4 bg-gray-50 p-4 rounded-xl text-center"><div><p class="text-xs text-gray-500">ì§€ê¸‰ ì´ì•¡(ì„¸ì „)</p><p class="font-bold">${formatMoney(calc.grossPay)}</p></div><div><p class="text-xs text-gray-500">ê³µì œ ì´ì•¡</p><p class="font-bold text-red-500">-${formatMoney(calc.totalDeduction)}</p></div><div><p class="text-xs text-gray-500">ì´ ì¸ì •ê·¼ë¡œ</p><p class="font-bold">${calc.totalHours}ì‹œê°„</p></div></div><details class="group"><summary class="flex items-center gap-2 cursor-pointer text-sm font-medium text-gray-500 hover:text-blue-500"><i class="ph-bold ph-caret-down group-open:rotate-180 transition"></i> ìƒì„¸ ê¸‰ì—¬ ëª…ì„¸ ë° ê·¼ë¬´ ê¸°ë¡ ë³´ê¸°</summary><div class="mt-4 border-t border-gray-100 pt-4"><div class="mb-6"><h4 class="text-sm font-bold mb-2">ê³µì œ ë‚´ì—­ (${calc.insuranceType})</h4><div class="grid grid-cols-2 gap-2 text-sm text-gray-600">${Object.entries(calc.taxDetails).map(([k, v]) => `<div class="flex justify-between"><span>${k}</span><span>-${formatMoney(v)}</span></div>`).join('')}</div></div><h4 class="text-sm font-bold mb-2">ì¼ë³„ ìƒì„¸ ê¸°ë¡</h4><div class="overflow-x-auto"><table class="w-full text-left min-w-[500px]"><thead><tr class="text-xs text-gray-400 border-b border-gray-200"><th class="py-2 font-normal">ë‚ ì§œ</th><th class="py-2 font-normal">ì‹œê°„/ìƒíƒœ</th><th class="py-2 font-normal text-right">ì¸ì •ì‹œê°„</th><th class="py-2 font-normal text-right">ê¸°ë³¸ê¸‰ì—¬</th><th class="py-2 font-normal text-right">ì£¼íœ´ìˆ˜ë‹¹</th><th class="py-2 font-normal text-right">ì´ì§€ê¸‰ì•¡</th></tr></thead><tbody>${detailsHtml}</tbody></table></div></div></details>`;
                container.appendChild(el);
            });
        }
        function calculateMonthlyPayroll(emp, year, month, workDaysInMonth) {
            let hourlyRate = 0; let allowanceBase = emp.manualAllowance || 0;
            if (emp.role === 'manager') allowanceBase += 200000; if (emp.role === 'owner') allowanceBase += 500000;
            if (emp.type === 'monthly') { const rawDaily = (emp.pay + allowanceBase) / workDaysInMonth; const rawHourly = rawDaily / 8; hourlyRate = Math.ceil(rawHourly / 1.2); }
            else { if (emp.juhyuIncluded) hourlyRate = Math.ceil(emp.pay / 1.2); else hourlyRate = emp.pay; }
            const daysInMonth = new Date(year, month, 0).getDate(); let dailyLogs = []; let totalGross = 0; let totalHours = 0;
            const getSched = (d) => state.schedules.find(s => s.employeeId === emp.id && s.date === d);
            let currentWeekData = { hours: 0, daysWorked: 0, logs: [], weekBasePay: 0 };
            for (let d = 1; d <= daysInMonth; d++) {
                const dateObj = new Date(year, month-1, d); const dateStr = formatDate(dateObj); const dayNum = dateObj.getDay(); const sch = getSched(dateStr);
                let workHours = 0; let dailyBasePay = 0; let status = ''; let timeStr = '';
                if (sch) {
                    const [sh, sm] = sch.start.split(':').map(Number); const [eh, em] = sch.end.split(':').map(Number);
                    let rawMins = (eh*60 + em) - (sh*60 + sm); let restMins = 0; if (rawMins >= 480) restMins = 60; else if (rawMins >= 240) restMins = 30;
                    workHours = (rawMins - restMins) / 60; if (workHours < 0) workHours = 0; timeStr = `${sch.start}~${sch.end}`;
                    let rate = hourlyRate; if (emp.type === 'hourly') rate += (emp.manualAllowance || 0);
                    dailyBasePay = Math.ceil(workHours * rate); status = 'ê·¼ë¬´'; currentWeekData.hours += workHours; currentWeekData.daysWorked++; currentWeekData.weekBasePay += dailyBasePay;
                } else { status = '-'; }
                const log = { date: dateStr, timeStr: sch ? timeStr : (status === '-' ? '' : 'ê²°ê·¼'), status: status, workHours: workHours, basePay: dailyBasePay, juhyuPay: 0, total: dailyBasePay, note: '' };
                dailyLogs.push(log); currentWeekData.logs.push(log);
                if (dayNum === 0 || d === daysInMonth) {
                    let giveJuhyu = false; let juhyuReason = ''; if (currentWeekData.hours < 15) juhyuReason = 'ì£¼ 15ì‹œê°„ ë¯¸ë§Œ'; else if (new Date(emp.joinDate) > getMonday(dateObj)) juhyuReason = 'ì…ì‚¬ ì£¼ê°„ ì œì™¸'; else giveJuhyu = true;
                    if (giveJuhyu) { const juhyuAmt = Math.ceil(currentWeekData.weekBasePay * 0.2); const lastLog = currentWeekData.logs[currentWeekData.logs.length-1]; lastLog.juhyuPay = juhyuAmt; lastLog.total += juhyuAmt; }
                    else { const lastLog = currentWeekData.logs[currentWeekData.logs.length-1]; if (currentWeekData.hours > 0) lastLog.note = `ì£¼íœ´ ì œì™¸: ${juhyuReason}`; }
                    currentWeekData = { hours: 0, daysWorked: 0, logs: [], weekBasePay: 0 };
                }
            }
            dailyLogs.forEach(l => { totalGross += l.total; totalHours += l.workHours; });
            if (emp.type === 'monthly' && emp.manualAllowance) totalGross += emp.manualAllowance;
            let taxDetails = {}; if (emp.insurance === 'freelance') taxDetails['ì‚¬ì—…ì†Œë“ì„¸(3.3%)'] = Math.ceil(totalGross * 0.033); else if (emp.insurance === '4major') { taxDetails['êµ­ë¯¼ì—°ê¸ˆ(4.5%)'] = Math.ceil(totalGross * 0.045); taxDetails['ê±´ê°•ë³´í—˜(3.545%)'] = Math.ceil(totalGross * 0.03545); taxDetails['ì¥ê¸°ìš”ì–‘(ê±´ë³´ë£Œ12.95%)'] = Math.ceil(taxDetails['ê±´ê°•ë³´í—˜(3.545%)'] * 0.1295); taxDetails['ê³ ìš©ë³´í—˜(0.9%)'] = Math.ceil(totalGross * 0.009); } else if (emp.insurance === '2major') { taxDetails['ê³ ìš©ë³´í—˜(0.9%)'] = Math.ceil(totalGross * 0.009); }
            let totalDeduction = Object.values(taxDetails).reduce((a, b) => a + b, 0);
            return { dailyLogs, totalHours, grossPay: totalGross, totalDeduction, netPay: totalGross - totalDeduction, taxDetails, insuranceType: emp.insurance };
        }
        
        async function callGemini(prompt, systemInstruction = "") {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], systemInstruction: { parts: [{ text: systemInstruction }] } })
                });
                const data = await response.json(); return data.candidates?.[0]?.content?.parts?.[0]?.text || "ì£„ì†¡í•©ë‹ˆë‹¤. ì‘ë‹µì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            } catch (error) { console.error("Gemini API Error:", error); return "API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."; }
        }
        function toggleChat() { const win = document.getElementById('chat-window'); if (win.style.display === 'flex') { win.style.display = 'none'; } else { win.style.display = 'flex'; document.getElementById('chat-input').focus(); } }
        function handleChatKey(e) { if (e.key === 'Enter') sendMessage(); }
        async function sendMessage() {
            const input = document.getElementById('chat-input'); const text = input.value.trim(); if (!text) return;
            const messagesDiv = document.getElementById('chat-messages'); messagesDiv.innerHTML += `<div class="message user">${text}</div>`; input.value = ''; messagesDiv.scrollTop = messagesDiv.scrollHeight;
            const loadingId = 'loading-' + Date.now(); messagesDiv.innerHTML += `<div class="message ai" id="${loadingId}"><div class="typing-indicator"><span></span><span></span><span></span></div></div>`; messagesDiv.scrollTop = messagesDiv.scrollHeight;
            const responseText = await callGemini(text, "ë‹¹ì‹ ì€ 'ë ˆìŠ¤í† ì§€ë‹ˆ'ì˜ AI ë…¸ë¬´ì‚¬ì…ë‹ˆë‹¤.");
            const loadingEl = document.getElementById(loadingId); if(loadingEl) loadingEl.innerHTML = marked.parse(responseText); messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        async function generatePayrollReport() {
            const container = document.getElementById('ai-report-container'); const contentDiv = document.getElementById('ai-report-content'); container.classList.remove('hidden');
            contentDiv.innerHTML = `<div class="flex items-center gap-2 text-gray-500 py-4"><div class="spinner border-gray-300 border-t-blue-500"></div><span>ë¶„ì„ ì¤‘...</span></div>`;
            const prompt = `í˜„ì¬ ì§ì› ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ ê²½ì˜ ë¦¬í¬íŠ¸ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.`;
            const responseText = await callGemini(prompt, "ë°ì´í„° ë¶„ì„ê°€"); contentDiv.innerHTML = marked.parse(responseText);
        }
        function closeAiReport() { document.getElementById('ai-report-container').classList.add('hidden'); }
    </script>
</body>
</html>
