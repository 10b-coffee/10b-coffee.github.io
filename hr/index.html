<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="robots" content="noindex, nofollow">
    <title>레스토지니 v2.1.13 (Clean)</title>
    
    <!-- Pretendard Font -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body { font-family: "Pretendard Variable", Pretendard, sans-serif; background-color: #F2F4F6; color: #191F28; -webkit-font-smoothing: antialiased; }
        
        .toss-card { background: #FFFFFF; border-radius: 24px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03); padding: 24px; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .toss-btn-primary { background-color: #3182F6; color: white; font-weight: 600; border-radius: 12px; padding: 14px 20px; transition: background-color 0.2s; }
        .toss-btn-primary:hover { background-color: #1B64DA; }
        .toss-btn-danger { background-color: #FFF1F1; color: #FF4B4B; font-weight: 600; border-radius: 12px; padding: 14px 20px; transition: background-color 0.2s; }
        .toss-btn-danger:hover { background-color: #FFE4E4; }
        .toss-btn-ai { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; font-weight: 600; border-radius: 12px; padding: 10px 16px; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 6px; }
        
        .toss-input { background-color: #F9FAFB; border: 1px solid #E5E8EB; border-radius: 12px; padding: 14px; font-size: 16px; width: 100%; transition: border-color 0.2s; }
        .toss-input:focus { outline: none; border-color: #3182F6; }
        .toss-input:disabled { background-color: #F2F4F6; color: #B0B8C1; cursor: not-allowed; }
        
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #D1D6DB; border-radius: 3px; }
        
        /* Nav States */
        .nav-item-active { background-color: #E8F3FF; color: #3182F6; }
        .nav-item-inactive { color: #8B95A1; }
        .nav-item-inactive:hover { background-color: #F9FAFB; color: #191F28; }
        
        /* Schedule UI */
        .schedule-staff-active { background-color: #3182F6; color: white; box-shadow: 0 4px 12px rgba(49, 130, 246, 0.3); }
        .schedule-staff-inactive { background-color: white; color: #4E5968; border: 1px solid #E5E8EB; }
        .time-grid-cell { border-bottom: 1px solid #F2F4F6; border-right: 1px solid #F2F4F6; height: 20px; position: relative; user-select: none; }
        .time-grid-cell:hover { background-color: #F9FAFB; }
        .time-grid-cell.selected { background-color: #E8F3FF; }
        .schedule-block { position: absolute; left: 2px; right: 2px; background-color: #3182F6; color: white; border-radius: 4px; padding: 2px 4px; font-size: 10px; font-weight: 600; overflow: hidden; z-index: 10; pointer-events: auto; box-shadow: 0 2px 4px rgba(49, 130, 246, 0.3); cursor: pointer; transition: transform 0.1s; display: flex; align-items: center; justify-content: center; }
        .schedule-block:hover { transform: scale(1.02); z-index: 20; }
        
        /* Animations */
        .ai-loading-dots span { display: inline-block; width: 6px; height: 6px; border-radius: 50%; background-color: #8b5cf6; animation: bounce 1.4s infinite ease-in-out both; margin: 0 2px; }
        .ai-loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .ai-loading-dots span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body class="h-screen w-screen flex overflow-hidden bg-[#F2F4F6]">

    <!-- Loading Overlay -->
    <div id="global-loading" style="display: none;" class="fixed inset-0 z-[9999] bg-white/90 backdrop-blur-sm flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
        <p class="text-blue-600 font-bold animate-pulse mb-6" id="loading-text">데이터 동기화 중...</p>
        <button id="force-close-loading" onclick="showLoading(false)" class="hidden px-4 py-2 bg-gray-200 text-gray-600 text-sm rounded-lg hover:bg-gray-300 font-bold">
            로딩 취소 (닫기)
        </button>
    </div>

    <!-- Desktop Sidebar -->
    <aside class="w-64 bg-white border-r border-gray-100 flex flex-col hidden md:flex z-20 shadow-sm shrink-0">
        <div class="p-8 pb-4 flex items-center gap-3">
            <div class="w-9 h-9 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-blue-200 shadow-lg">R</div>
            <h1 class="text-xl font-extrabold tracking-tight text-[#191F28]">RestoGenie</h1>
        </div>
        
        <nav class="flex-1 px-4 space-y-2 mt-6">
            <button onclick="switchTab('staff')" id="nav-staff" class="w-full flex items-center gap-3 px-5 py-3.5 rounded-2xl text-left font-bold transition-all nav-item-active">
                <i class="fas fa-users w-5 text-center"></i> 직원 관리
            </button>
            <button onclick="switchTab('schedule')" id="nav-schedule" class="w-full flex items-center gap-3 px-5 py-3.5 rounded-2xl text-left font-bold transition-all nav-item-inactive">
                <i class="far fa-calendar-alt w-5 text-center"></i> 근무 일정
            </button>
            <button onclick="switchTab('payroll')" id="nav-payroll" class="w-full flex items-center gap-3 px-5 py-3.5 rounded-2xl text-left font-bold transition-all nav-item-inactive">
                <i class="fas fa-coins w-5 text-center"></i> 급여 정산
            </button>
        </nav>

        <div class="p-6 border-t border-gray-100">
            <div class="flex items-center gap-3 mb-2">
                <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-400">
                    <i class="fas fa-user"></i>
                </div>
                <div>
                    <div class="text-xs text-gray-400 font-medium">관리자 모드</div>
                    <div class="text-sm font-bold text-gray-700">김점장님</div>
                </div>
            </div>
            <div class="text-xs text-gray-300 mt-2 pl-1">v2.1.13 (Clean)</div>
            <button onclick="openConfig()" class="text-xs text-blue-400 underline mt-1 pl-1">API 설정</button>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="flex-1 flex flex-col h-full relative overflow-hidden">
        
        <!-- Mobile Header -->
        <header class="md:hidden bg-white px-5 py-4 flex justify-between items-center shadow-sm z-10 sticky top-0 shrink-0">
             <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold">R</div>
                <h1 class="text-xl font-bold tracking-tight">RestoGenie</h1>
            </div>
            <div onclick="openConfig()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 cursor-pointer">
                <i class="fas fa-cog"></i>
            </div>
        </header>

        <!-- Content Pages -->
        <div class="flex-1 overflow-y-auto p-0 md:p-8 pb-24 md:pb-8 space-y-8 scroll-smooth" id="main-scroll">
            
            <!-- 1. STAFF MANAGEMENT -->
            <section id="view-staff" class="space-y-6 max-w-4xl mx-auto px-5 md:px-0 pt-5 md:pt-0">
                <div class="flex flex-col md:flex-row md:justify-between md:items-end gap-4">
                    <div>
                        <h2 class="text-3xl font-bold">직원 관리</h2>
                        <p class="text-[#8B95A1] mt-2 text-sm font-medium">현재 총 <span id="staff-count" class="text-blue-600 font-bold">0</span>명이 함께하고 있어요</p>
                    </div>
                    <button onclick="openStaffModal()" class="toss-btn-primary text-sm shadow-lg shadow-blue-100">+ 직원 등록</button>
                </div>
                <div id="staff-list" class="space-y-4">
                    <!-- Staff Cards Here -->
                </div>
            </section>

            <!-- 2. SCHEDULE -->
            <section id="view-schedule" class="hidden h-full flex flex-col md:flex-row gap-6 max-w-7xl mx-auto px-5 md:px-0 pt-5 md:pt-0">
                
                <!-- Sidebar for Staff Selection in Schedule -->
                <div class="md:w-64 shrink-0 flex flex-col gap-4">
                    <h2 class="text-2xl font-bold md:mb-2">근무 일정</h2>
                    <div id="schedule-staff-list" class="flex md:flex-col gap-3 overflow-x-auto md:overflow-visible pb-2 md:pb-0 scrollbar-hide">
                        <!-- Staff Icons Here -->
                    </div>
                </div>

                <!-- Calendar Area -->
                <div class="flex-1 flex flex-col gap-4 h-full pb-10">
                    <div class="bg-white rounded-2xl p-4 shadow-sm flex flex-col sm:flex-row justify-between items-center gap-4 shrink-0">
                        <div class="flex items-center gap-2">
                            <button onclick="changeDateRange(-1)" class="w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center transition-colors text-gray-500"><i class="fas fa-chevron-left"></i></button>
                            
                            <div onclick="openDatePicker()" class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 px-3 py-1.5 rounded-lg transition-colors group">
                                <span id="current-month-display" class="text-xl font-bold text-gray-800">2025년 12월</span>
                                <i class="fas fa-chevron-down text-gray-400 text-xs group-hover:text-gray-600"></i>
                            </div>

                            <button onclick="changeDateRange(1)" class="w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center transition-colors text-gray-500"><i class="fas fa-chevron-right"></i></button>
                        </div>

                        <div class="flex bg-gray-100 p-1 rounded-xl">
                            <button onclick="toggleViewMode('month')" id="btn-view-month" class="px-4 py-1.5 rounded-lg text-sm font-bold bg-white text-blue-600 shadow-sm">월간</button>
                            <button onclick="toggleViewMode('week')" id="btn-view-week" class="px-4 py-1.5 rounded-lg text-sm font-bold text-gray-500">주간</button>
                        </div>
                    </div>

                    <div id="calendar-container" class="toss-card flex-1 min-h-[500px] overflow-hidden relative p-0 flex flex-col">
                        <!-- Month Grid -->
                        <div id="month-view-container" class="flex flex-col h-full">
                            <div class="grid grid-cols-7 gap-1 text-center border-b border-gray-100 pb-2 bg-white z-10 p-4">
                                <div class="text-sm text-gray-400 font-medium">월</div>
                                <div class="text-sm text-gray-400 font-medium">화</div>
                                <div class="text-sm text-gray-400 font-medium">수</div>
                                <div class="text-sm text-gray-400 font-medium">목</div>
                                <div class="text-sm text-gray-400 font-medium">금</div>
                                <div class="text-sm text-blue-500 font-medium">토</div>
                                <div class="text-sm text-red-500 font-medium">일</div>
                            </div>
                            <div id="calendar-grid" class="grid grid-cols-7 gap-2 p-4 overflow-y-auto">
                                <!-- Days Here -->
                            </div>
                        </div>

                        <!-- Week Grid -->
                        <div id="week-view-container" class="hidden flex-1 overflow-y-auto relative h-full flex flex-col">
                            <div class="grid grid-cols-[60px_repeat(7,1fr)] sticky top-0 bg-white z-20 border-b border-gray-200" id="week-header-row">
                                <div class="p-2 border-r border-gray-100 bg-gray-50 sticky left-0 z-30"></div>
                            </div>
                            <div class="grid grid-cols-[60px_repeat(7,1fr)] relative flex-1" id="week-grid-body">
                                <!-- Time Labels -->
                                <div class="flex flex-col border-r border-gray-100 text-xs text-gray-400 font-medium text-center bg-gray-50">
                                    <script>
                                        for(let i=0; i<=24; i++) {
                                            document.write(`<div class="h-[20px] border-b border-gray-100 flex items-start justify-center pt-1">${String(i).padStart(2,'0')}:00</div>`);
                                        }
                                    </script>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 3. PAYROLL -->
            <section id="view-payroll" class="hidden space-y-6 max-w-4xl mx-auto px-5 md:px-0 pt-5 md:pt-0">
                <div class="flex justify-between items-center">
                    <h2 class="text-3xl font-bold">급여 정산</h2>
                    <div class="text-xs font-bold text-blue-600 bg-blue-50 px-3 py-1.5 rounded-full flex items-center gap-1">
                        <div class="w-1.5 h-1.5 rounded-full bg-blue-600 animate-pulse"></div> 실시간 계산됨
                    </div>
                </div>
                <div id="payroll-list" class="space-y-8">
                    <!-- Payroll Cards Here -->
                </div>
            </section>

        </div>

        <!-- Mobile Bottom Navigation -->
        <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 flex justify-around p-2 pb-safe z-30 shadow-[0_-4px_20px_rgba(0,0,0,0.03)]">
            <button onclick="switchTab('staff')" id="mob-staff" class="flex-1 flex flex-col items-center gap-1 py-2 text-blue-600">
                <i class="fas fa-users text-xl mb-0.5"></i>
                <span class="text-[10px] font-bold">직원</span>
            </button>
            <button onclick="switchTab('schedule')" id="mob-schedule" class="flex-1 flex flex-col items-center gap-1 py-2 text-gray-400">
                <i class="far fa-calendar-alt text-xl mb-0.5"></i>
                <span class="text-[10px] font-bold">일정</span>
            </button>
            <button onclick="switchTab('payroll')" id="mob-payroll" class="flex-1 flex flex-col items-center gap-1 py-2 text-gray-400">
                <i class="fas fa-coins text-xl mb-0.5"></i>
                <span class="text-[10px] font-bold">정산</span>
            </button>
        </nav>
    </main>

    <!-- MODALS -->

    <!-- Config Modal -->
    <div id="config-modal" class="fixed inset-0 z-[70] hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 modal-overlay" onclick="closeConfig()"></div>
        <div class="bg-white w-full max-w-md rounded-2xl p-6 relative z-10 shadow-2xl">
            <h3 class="text-xl font-bold mb-4">서비스 설정</h3>
            
            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-500 mb-1">Google Apps Script URL (데이터 저장소)</label>
                <input type="text" id="api-url-input" class="toss-input" placeholder="https://script.google.com/..." >
                <p class="text-[10px] text-gray-400 mt-1">DB 연동을 위한 GAS Web App URL을 입력하세요.</p>
            </div>
            
            <div class="mb-6">
                <label class="block text-xs font-bold text-gray-500 mb-1">Gemini API Key (AI 리포트)</label>
                <input type="password" id="gemini-key-input" class="toss-input" placeholder="AIz..." >
                <p class="text-[10px] text-gray-400 mt-1">AI 리포트 생성을 위한 Gemini API 키를 입력하세요.</p>
            </div>

            <button onclick="saveConfig()" class="toss-btn-primary w-full">저장하기</button>
        </div>
    </div>

    <!-- API Key Request Modal (On Demand) -->
    <div id="ai-key-modal" class="fixed inset-0 z-[80] hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 modal-overlay"></div>
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 relative z-10 shadow-2xl text-center">
            <div class="w-12 h-12 bg-gradient-to-tr from-indigo-500 to-purple-500 rounded-full flex items-center justify-center text-white mx-auto mb-4">
                <i class="fas fa-key"></i>
            </div>
            <h3 class="text-lg font-bold mb-2">Gemini API 키가 필요해요</h3>
            <p class="text-sm text-gray-500 mb-4">AI 리포트를 생성하려면 Google Gemini API 키가 필요합니다.<br>(한 번 입력하면 브라우저에 저장됩니다)</p>
            <input type="password" id="modal-gemini-key" class="toss-input mb-4 text-center" placeholder="API Key 입력">
            <div class="flex gap-2">
                <button onclick="document.getElementById('ai-key-modal').classList.add('hidden')" class="flex-1 py-3 bg-gray-100 text-gray-600 font-bold rounded-xl">취소</button>
                <button onclick="saveGeminiKeyAndRun()" class="flex-1 toss-btn-primary">확인</button>
            </div>
            <p class="text-[10px] text-gray-400 mt-3"><a href="https://aistudio.google.com/app/apikey" target="_blank" class="underline">API 키 발급받기 ↗</a></p>
        </div>
    </div>

    <!-- Staff Modal -->
    <div id="staff-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 modal-overlay" onclick="closeStaffModal()"></div>
        <div class="absolute bottom-0 left-0 right-0 md:top-1/2 md:left-1/2 md:bottom-auto md:-translate-x-1/2 md:-translate-y-1/2 md:w-[600px] bg-white rounded-t-3xl md:rounded-3xl p-0 shadow-2xl transform transition-transform duration-300 translate-y-full h-[85vh] flex flex-col" id="staff-modal-content">
            <div class="p-6 pb-4 border-b border-gray-100 flex justify-between items-center bg-white rounded-t-3xl shrink-0">
                <h3 class="text-xl font-bold" id="modal-title">직원 등록</h3>
                <button onclick="closeStaffModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            <form id="staff-form" onsubmit="handleStaffSubmit(event)" class="flex-1 overflow-y-auto p-6 space-y-8">
                <input type="hidden" id="staff-id">
                
                <!-- 1. Basic -->
                <div class="space-y-4">
                    <h4 class="text-sm font-bold text-gray-800 border-l-4 border-blue-500 pl-2">기본 정보</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-xs font-bold text-gray-500 mb-1">이름</label><input type="text" id="staff-name" class="toss-input" required></div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">직책</label>
                            <div class="flex gap-2">
                                <label class="flex-1 cursor-pointer"><input type="radio" name="role" value="staff" class="peer hidden" checked><div class="text-center py-3 rounded-xl bg-gray-50 peer-checked:bg-blue-50 peer-checked:text-blue-500 peer-checked:ring-1 peer-checked:ring-blue-500 font-medium text-xs">스태프</div></label>
                                <label class="flex-1 cursor-pointer"><input type="radio" name="role" value="manager" class="peer hidden"><div class="text-center py-3 rounded-xl bg-gray-50 peer-checked:bg-blue-50 peer-checked:text-blue-500 peer-checked:ring-1 peer-checked:ring-blue-500 font-medium text-xs">매니저</div></label>
                            </div>
                        </div>
                    </div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">주민등록번호</label><div class="flex items-center gap-2"><input type="text" id="staff-rrn-front" class="toss-input text-center" maxlength="6"><span class="text-gray-400">-</span><input type="password" id="staff-rrn-back" class="toss-input text-center" maxlength="7"></div></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">주소</label><input type="text" id="staff-address" class="toss-input"></div>
                </div>

                <!-- 2. Employment -->
                <div class="space-y-4">
                    <h4 class="text-sm font-bold text-gray-800 border-l-4 border-blue-500 pl-2">근무 정보</h4>
                    <div class="flex items-end gap-4">
                        <div class="flex-1"><label class="block text-xs font-bold text-gray-500 mb-1">입사일</label><input type="date" id="staff-join-date" class="toss-input" required></div>
                        <div class="flex-1"><label class="block text-xs font-bold text-gray-500 mb-1">퇴사일</label><input type="date" id="staff-resign-date" class="toss-input" disabled></div>
                    </div>
                    <div class="flex items-center gap-2"><input type="checkbox" id="staff-is-working" class="w-4 h-4 text-blue-600 rounded" checked onchange="toggleResignDate()"><label for="staff-is-working" class="text-sm text-gray-700 font-medium">재직 중</label></div>
                    <div class="bg-gray-50 p-4 rounded-xl space-y-3"><p class="text-xs font-bold text-gray-500">요일별 기본 근무 시간</p><div id="work-days-container" class="grid grid-cols-1 gap-2"></div></div>
                </div>

                <!-- 3. Pay -->
                <div class="space-y-4">
                    <h4 class="text-sm font-bold text-gray-800 border-l-4 border-blue-500 pl-2">급여 정보</h4>
                    <div class="flex gap-4 mb-2">
                        <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="payType" value="hourly" class="w-4 h-4 text-blue-600" checked onchange="togglePayInputs()"><span class="text-sm font-medium">시급제</span></label>
                        <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="payType" value="monthly" class="w-4 h-4 text-blue-600" onchange="togglePayInputs()"><span class="text-sm font-medium">월급제</span></label>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-xs font-bold text-gray-500 mb-1" id="label-base-pay">시급</label><input type="number" id="staff-base-pay" class="toss-input text-right" placeholder="0"></div>
                        <div><label class="block text-xs font-bold text-gray-500 mb-1">수당 (직책/기타)</label><input type="number" id="staff-allowance" class="toss-input text-right" placeholder="0"></div>
                    </div>
                    <div id="hourly-options" class="bg-blue-50 p-3 rounded-lg flex items-center gap-2"><input type="checkbox" id="staff-juhyu-included" class="w-4 h-4 text-blue-600 rounded"><label for="staff-juhyu-included" class="text-sm text-blue-800 font-medium">입력된 시급에 주휴수당 포함</label></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">계약 형태</label><select id="staff-contract-type" class="toss-input"><option value="4major">4대보험 (약 9.3%)</option><option value="2major">2대보험 (고용/산재)</option><option value="freelancer">프리랜서 (3.3%)</option></select></div>
                </div>

                <!-- 4. Account -->
                <div class="space-y-4">
                    <h4 class="text-sm font-bold text-gray-800 border-l-4 border-blue-500 pl-2">계좌 정보</h4>
                    <div class="grid grid-cols-3 gap-3">
                        <div class="col-span-1"><label class="block text-xs font-bold text-gray-500 mb-1">은행</label><select id="staff-bank" class="toss-input px-2"><option value="">선택</option><option value="KB">국민</option><option value="Shinhan">신한</option><option value="Toss">토스</option><option value="Kakao">카카오</option><option value="Woori">우리</option><option value="Hana">하나</option><option value="NH">농협</option><option value="IBK">기업</option></select></div>
                        <div class="col-span-2"><label class="block text-xs font-bold text-gray-500 mb-1">계좌번호</label><input type="text" id="staff-account" class="toss-input"></div>
                    </div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">예금주</label><input type="text" id="staff-account-holder" class="toss-input"></div>
                </div>

                <div class="pt-4 flex gap-3 pb-safe">
                    <button type="button" onclick="deleteStaff()" id="btn-delete" class="flex-1 py-4 rounded-xl bg-red-50 text-red-500 font-bold hidden">삭제</button>
                    <button type="submit" class="flex-[2] toss-btn-primary w-full shadow-lg shadow-blue-200">저장하기</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Date Picker Modal -->
    <div id="date-picker-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 modal-overlay" onclick="closeDatePicker()"></div>
        <div class="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl relative z-10">
            <h3 class="text-lg font-bold mb-4 text-center">날짜 이동</h3>
            <div class="flex justify-center items-center gap-4 mb-6">
                <button onclick="adjustPickerYear(-1)" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center"><i class="fas fa-minus text-xs"></i></button>
                <span id="picker-year" class="text-2xl font-bold text-blue-600">2025</span>
                <button onclick="adjustPickerYear(1)" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center"><i class="fas fa-plus text-xs"></i></button>
            </div>
            <div class="grid grid-cols-4 gap-2">
                <script>for(let i=1;i<=12;i++)document.write(`<button onclick="selectPickerMonth(${i-1})" class="py-3 rounded-xl font-bold text-sm bg-gray-50 hover:bg-blue-50 hover:text-blue-600">${i}월</button>`);</script>
            </div>
        </div>
    </div>
    
    <!-- Schedule Modal -->
    <div id="schedule-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 modal-overlay" onclick="closeScheduleModal()"></div>
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative z-10">
            <h3 class="text-lg font-bold mb-1" id="schedule-modal-date"></h3>
            <p class="text-sm text-gray-500 mb-6">근무 시간 입력</p>
            <div class="space-y-4">
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-xl">
                    <span class="font-bold text-gray-700">근무 상태</span>
                    <select id="work-status" onchange="toggleTimeInputs()" class="bg-transparent font-bold text-blue-600 outline-none text-right">
                        <option value="work">정상 근무</option>
                        <option value="absent">결근</option>
                        <option value="off">휴무</option>
                    </select>
                </div>
                <div id="time-inputs" class="space-y-3">
                    <div class="flex items-center gap-2">
                        <input type="time" id="start-time" class="toss-input py-2 text-center font-bold" onchange="calculateDuration()">
                        <span class="text-gray-300">~</span>
                        <input type="time" id="end-time" class="toss-input py-2 text-center font-bold" onchange="calculateDuration()">
                    </div>
                    <div class="text-center text-sm font-medium text-gray-600 bg-gray-50 py-2 rounded-lg">
                        총 <span id="calc-hours" class="text-blue-600 font-bold">0</span>시간 <span class="text-xs text-gray-400">(휴게 <span id="calc-break">0</span>분 자동)</span>
                    </div>
                </div>
                <!-- Delete Button Added -->
                <div class="flex gap-2 mt-4">
                    <button type="button" onclick="deleteSchedule()" id="btn-delete-schedule" class="flex-1 toss-btn-danger hidden">삭제</button>
                    <button onclick="saveSchedule()" class="flex-[2] toss-btn-primary">저장하기</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- AI Report Modal -->
    <div id="ai-report-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 modal-overlay" onclick="closeAIModal()"></div>
        <div class="absolute bottom-0 left-0 right-0 md:top-1/2 md:left-1/2 md:bottom-auto md:-translate-x-1/2 md:-translate-y-1/2 md:w-[600px] bg-white rounded-t-3xl md:rounded-3xl p-0 shadow-2xl transform transition-transform duration-300 translate-y-full h-[80vh] md:h-auto flex flex-col" id="ai-modal-content">
            <div class="p-6 pb-4 border-b border-gray-100 flex justify-between bg-gradient-to-r from-indigo-50 to-white rounded-t-3xl">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-indigo-500 to-purple-500 flex items-center justify-center text-white"><i class="fas fa-sparkles"></i></div>
                    <h3 class="text-xl font-bold">AI 급여 리포트</h3>
                </div>
                <button onclick="closeAIModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 overflow-y-auto flex-1 bg-white" id="ai-result-container"></div>
            <div class="p-4 border-t border-gray-100">
                <button onclick="copyAIReport()" class="w-full py-3 bg-gray-50 text-gray-700 font-bold rounded-xl">복사하기</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full opacity-0 pointer-events-none z-[100] transition-opacity duration-300"></div>

    <script>
        // === ERROR HANDLER ===
        window.onerror = function(msg, url, line, col, error) {
            console.error("Global Error", msg, error);
            showToast(`오류 발생: ${msg}`);
            showLoading(false);
            return false;
        };

        // === GLOBAL CONFIG ===
        let API_URL = localStorage.getItem('gas_api_url') || "https://script.google.com/macros/s/AKfycbyiLXmBFoDN9dqsiiHXRH_-e-W6Eot02fe__8zEbdxHI1Dwgryd8zr4eAbtQK1OvLdftg/exec"; 
        const GEMINI_API_KEY = ""; 

        // === STATE ===
        let staffData = [];
        let schedules = {};
        let payrollResults = {}; 
        let currentReportStaffId = null; 
        
        let currentYear = 2025;
        let currentMonth = 11; // Dec
        let currentWeekStart = null;
        let selectedScheduleStaffId = null;
        let scheduleViewMode = 'month';

        // Add missing global vars
        let editingStaffId = null;
        let editingDateStr = null;

        // === API HANDLER ===
        async function fetchAPI(action, payload = {}) {
            if(!API_URL) return null; 
            
            showLoading(true);
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15s timeout

                if(action === 'getInitialData') {
                    const res = await fetch(`${API_URL}?action=getInitialData`, { signal: controller.signal });
                    clearTimeout(timeoutId);
                    const json = await res.json();
                    return json;
                } else {
                    const res = await fetch(API_URL, {
                        method: 'POST',
                        mode: 'no-cors', 
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action, ...payload }),
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    return { success: true };
                }
            } catch(e) {
                console.error("API Error", e);
                if (e.name === 'AbortError') {
                    console.warn("Timeout");
                    showToast("연결 지연: 로컬 모드로 전환합니다");
                } else {
                    showToast("데이터 통신 오류: " + e.message);
                }
                return null;
            } finally {
                showLoading(false);
            }
        }

        // === INIT ===
        async function init() {
            try {
                setTimeout(() => {
                    const btn = document.getElementById('force-close-loading');
                    if(btn) btn.classList.remove('hidden');
                }, 3000);

                const d = new Date(currentYear, currentMonth, 1);
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                currentWeekStart = new Date(d.setDate(diff));

                if(API_URL) {
                    const cloudData = await fetchAPI('getInitialData');
                    if(cloudData) {
                        if(cloudData.staff) {
                            staffData = cloudData.staff;
                            schedules = cloudData.schedules || {};
                        }
                        if(staffData.length === 0) showToast("연동 성공! (현재 데이터 없음)");
                    }
                }
                
                if(staffData.length === 0) seedDemoData(); 

                if(staffData.length > 0 && !selectedScheduleStaffId) selectedScheduleStaffId = staffData[0].id;

                renderStaffList();
                renderScheduleStaffList();
                renderCalendar();
                renderPayroll();
                renderWorkDaysInputs();
                
                if(!API_URL) showToast("API URL 미설정: 로컬 모드로 동작합니다");
            } catch (e) {
                console.error("Init failed", e);
                showLoading(false); 
            }
        }

        function seedDemoData() {
            staffData = [
                {id:'kim_m', name:'김매니저', role:'manager', joinDate:'2024-01-01', isWorking:true, payType:'monthly', basePay:2200000, allowance:200000, contractType:'4major', bank:'KB', account:'111', defaultSchedule:{}},
                {id:'kim_d', name:'김도윤', role:'staff', joinDate:'2025-12-01', isWorking:true, payType:'hourly', basePay:10000, allowance:0, contractType:'freelancer', bank:'Toss', account:'222', defaultSchedule:{}}
            ];
        }

        // === NAV LOGIC ===
        function switchTab(t){
            document.querySelectorAll('section').forEach(e=>e.classList.add('hidden'));
            const target = document.getElementById(`view-${t}`);
            target.classList.remove('hidden');
            
            if(t === 'schedule') target.classList.add('flex');
            else document.getElementById('view-schedule').classList.remove('flex');
            
            document.getElementById('main-scroll').scrollTop = 0;
            
            ['staff','schedule','payroll'].forEach(x=>{
                const btn = document.getElementById(`nav-${x}`);
                const mob = document.getElementById(`mob-${x}`);
                if(x===t){
                    btn.className='w-full flex items-center gap-3 px-5 py-3.5 rounded-2xl text-left font-bold transition-all nav-item-active';
                    mob.className='flex-1 flex flex-col items-center gap-1 py-2 text-blue-600';
                } else {
                    btn.className='w-full flex items-center gap-3 px-5 py-3.5 rounded-2xl text-left font-bold transition-all nav-item-inactive';
                    mob.className='flex-1 flex flex-col items-center gap-1 py-2 text-gray-400';
                }
            });
            
            if(t==='schedule') renderCalendar();
            if(t==='payroll') renderPayroll();
        }

        // === STAFF LOGIC ===
        function openStaffModal(id) {
            const modal = document.getElementById('staff-modal');
            const form = document.getElementById('staff-form');
            const title = document.getElementById('modal-title');
            const delBtn = document.getElementById('btn-delete');
            
            form.reset();
            document.getElementById('staff-id').value = '';
            
            if(id) {
                const s = staffData.find(x => x.id === id);
                if (s) {
                    document.getElementById('modal-title').innerText = '직원 수정';
                    document.getElementById('staff-id').value = s.id;
                    document.getElementById('staff-name').value = s.name;
                    
                    const r = document.querySelector(`input[name="role"][value="${s.role}"]`);
                    if(r) r.checked = true;

                    document.getElementById('staff-rrn-front').value = s.rrnFront || '';
                    document.getElementById('staff-rrn-back').value = s.rrnBack || '';
                    document.getElementById('staff-address').value = s.address || '';
                    document.getElementById('staff-join-date').value = s.joinDate || '';
                    
                    const w = document.getElementById('staff-is-working');
                    w.checked = s.isWorking;
                    const rd = document.getElementById('staff-resign-date');
                    rd.value = s.resignDate || '';
                    rd.disabled = s.isWorking;
                    
                    const pt = document.querySelector(`input[name="payType"][value="${s.payType}"]`);
                    if(pt) pt.checked = true;
                    
                    document.getElementById('staff-base-pay').value = s.basePay;
                    document.getElementById('staff-allowance').value = s.allowance;
                    document.getElementById('staff-juhyu-included').checked = s.juhyuIncluded;
                    document.getElementById('staff-contract-type').value = s.contractType;
                    
                    document.getElementById('staff-bank').value = s.bank || '';
                    document.getElementById('staff-account').value = s.account || '';
                    document.getElementById('staff-account-holder').value = s.accountHolder || '';
                    
                    if(s.defaultSchedule) {
                        Object.keys(s.defaultSchedule).forEach(k => {
                            const sin = document.querySelector(`input[name="def_s_${k}"]`);
                            const ein = document.querySelector(`input[name="def_e_${k}"]`);
                            if(sin) sin.value = s.defaultSchedule[k].s;
                            if(ein) ein.value = s.defaultSchedule[k].e;
                        });
                    }
                    
                    delBtn.classList.remove('hidden');
                }
            } else {
                document.getElementById('modal-title').innerText = '직원 등록';
                delBtn.classList.add('hidden');
                document.getElementById('staff-is-working').checked = true;
                document.getElementById('staff-resign-date').disabled = true;
            }
            
            renderWorkDaysInputs();
            togglePayInputs();
            
            modal.classList.remove('hidden');
            setTimeout(() => document.getElementById('staff-modal-content').classList.remove('translate-y-full'), 10);
        }

        function closeStaffModal() {
            document.getElementById('staff-modal-content').classList.add('translate-y-full');
            setTimeout(() => document.getElementById('staff-modal').classList.add('hidden'), 300);
        }

        async function handleStaffSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('staff-id').value;
            let defSch = {};
            for(let i=1; i<=7; i++) {
                const s = document.querySelector(`input[name="def_s_${i}"]`).value;
                const e_t = document.querySelector(`input[name="def_e_${i}"]`).value;
                if(s && e_t) defSch[i] = {s, e: e_t};
            }

            const newStaff = {
                id: id || 'staff_' + Date.now(),
                name: document.getElementById('staff-name').value,
                role: document.querySelector('input[name="role"]:checked').value,
                rrnFront: document.getElementById('staff-rrn-front').value,
                rrnBack: document.getElementById('staff-rrn-back').value,
                address: document.getElementById('staff-address').value,
                joinDate: document.getElementById('staff-join-date').value,
                isWorking: document.getElementById('staff-is-working').checked,
                resignDate: document.getElementById('staff-resign-date').value,
                payType: document.querySelector('input[name="payType"]:checked').value,
                basePay: Number(document.getElementById('staff-base-pay').value),
                allowance: Number(document.getElementById('staff-allowance').value),
                juhyuIncluded: document.getElementById('staff-juhyu-included').checked,
                contractType: document.getElementById('staff-contract-type').value,
                bank: document.getElementById('staff-bank').value,
                account: document.getElementById('staff-account').value,
                accountHolder: document.getElementById('staff-account-holder').value,
                defaultSchedule: defSch
            };

            if(id) {
                const idx = staffData.findIndex(s => s.id === id);
                staffData[idx] = newStaff;
            } else {
                staffData.push(newStaff);
                if(!selectedScheduleStaffId) selectedScheduleStaffId = newStaff.id;
            }

            if(API_URL) await fetchAPI('saveStaff', { staff: newStaff });

            closeStaffModal();
            renderStaffList();
            renderScheduleStaffList();
            renderPayroll();
            showToast('저장되었습니다.');
        }

        async function deleteStaff() {
            const id = document.getElementById('staff-id').value;
            if(!confirm('삭제하시겠습니까?')) return;
            staffData = staffData.filter(s => s.id !== id);
            if(selectedScheduleStaffId === id) selectedScheduleStaffId = staffData[0]?.id || null;
            if(API_URL) await fetchAPI('deleteStaff', { staffId: id });
            closeStaffModal();
            renderStaffList();
            renderScheduleStaffList();
            renderPayroll();
            showToast('삭제되었습니다.');
        }

        // === SCHEDULE LOGIC ===
        async function saveSchedule() {
            const status = document.getElementById('work-status').value;
            const start = document.getElementById('start-time').value;
            const end = document.getElementById('end-time').value;
            let totalHours = 0, breakMinutes = 0;

            if(status === 'work') {
                if(!start || !end) return alert('시간 입력 필요');
                const sD = new Date(`2000-01-01T${start}`), eD = new Date(`2000-01-01T${end}`);
                if(eD < sD) eD.setDate(eD.getDate()+1);
                let diff = (eD - sD)/36e5;
                if(diff>=8) breakMinutes=60; else if(diff>=4) breakMinutes=30;
                totalHours = diff - (breakMinutes/60);
            }

            const key = `${editingStaffId}_${editingDateStr}`;
            const schData = {
                id: key,
                staffId: editingStaffId,
                date: editingDateStr,
                status,
                start: status==='work'?start:'',
                end: status==='work'?end:'',
                totalHours: Number(totalHours.toFixed(2)),
                breakMinutes
            };

            schedules[key] = schData;
            
            if(API_URL) await fetchAPI('saveSchedule', { schedule: schData });

            closeScheduleModal();
            renderCalendar();
            renderPayroll();
            showToast('일정이 저장되었습니다.');
        }

        async function deleteSchedule() {
            if(!confirm('정말 삭제하시겠습니까?')) return;
            const key = `${editingStaffId}_${editingDateStr}`;
            const schData = {
                id: key,
                staffId: editingStaffId,
                date: editingDateStr,
                status: 'off',
                start: '', end: '', totalHours: 0, breakMinutes: 0
            };
            schedules[key] = schData;
            if(API_URL) await fetchAPI('saveSchedule', { schedule: schData });
            closeScheduleModal();
            renderCalendar();
            renderPayroll();
            showToast('삭제되었습니다.');
        }

        // === CONFIG LOGIC ===
        function openConfig() {
            document.getElementById('api-url-input').value = API_URL;
            document.getElementById('gemini-key-input').value = GEMINI_API_KEY;
            document.getElementById('config-modal').classList.remove('hidden');
        }
        function closeConfig() { document.getElementById('config-modal').classList.add('hidden'); }
        function saveConfig() {
            const url = document.getElementById('api-url-input').value.trim();
            const key = document.getElementById('gemini-key-input').value.trim();
            localStorage.setItem('gas_api_url', url);
            localStorage.setItem('gemini_api_key', key);
            API_URL = url;
            GEMINI_API_KEY = key;
            closeConfig();
            location.reload();
        }
        function showLoading(show) {
            const el = document.getElementById('global-loading');
            if(show) {
                el.style.display = 'flex';
            } else {
                el.style.display = 'none';
            }
        }
        
        function saveGeminiKeyAndRun() {
            const k = document.getElementById('modal-gemini-key').value.trim();
            if(!k) return alert("API 키를 입력해주세요");
            
            localStorage.setItem('gemini_api_key', k);
            GEMINI_API_KEY = k;
            document.getElementById('ai-key-modal').classList.add('hidden');
            
            if(currentReportStaffId) {
                openAIReport(currentReportStaffId);
            }
        }
        
        function checkAndOpenAIReport(staffId) {
            currentReportStaffId = staffId;
            const key = localStorage.getItem('gemini_api_key') || GEMINI_API_KEY;
            if(!key) {
                document.getElementById('ai-key-modal').classList.remove('hidden');
            } else {
                openAIReport(staffId);
            }
        }

        function closeAIModal() {
            document.getElementById('ai-report-modal').classList.add('hidden');
        }

        function copyAIReport() {
            const text = document.getElementById('ai-result-container').innerText;
            navigator.clipboard.writeText(text).then(() => showToast("리포트 내용이 복사되었습니다."));
        }

        async function openAIReport(staffId) {
            const staffData = payrollResults[staffId];
            if(!staffData) return showToast("정산 데이터가 없습니다.");
            
            document.getElementById('ai-report-modal').classList.remove('hidden');
            document.getElementById('ai-modal-content').classList.remove('translate-y-full');
            
            const container = document.getElementById('ai-result-container');
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center h-64 space-y-4">
                    <div class="ai-loading-dots"><span></span><span></span><span></span></div>
                    <p class="text-gray-500 font-medium animate-pulse">급여 데이터를 분석하고 있습니다...</p>
                </div>
            `;

            try {
                const key = localStorage.getItem('gemini_api_key') || GEMINI_API_KEY;
                const prompt = `
                    당신은 인사/노무 전문가 'RestoGenie AI'입니다. 아래 급여 데이터를 바탕으로 직원에게 전달할 따뜻하고 전문적인 급여 리포트를 작성해주세요.
                    
                    [직원 정보]
                    - 이름: ${staffData.staff.name} (${staffData.staff.role})
                    - 급여 형태: ${staffData.staff.payType === 'monthly' ? '월급제' : '시급제'}
                    - 총 근무시간: ${staffData.totalHours}시간
                    - 세전 총액: ${formatMoney(staffData.totalGross)}
                    - 실 수령액: ${formatMoney(staffData.netPay)}
                    - 주휴수당 이슈: ${staffData.juhyuNotes.length > 0 ? staffData.juhyuNotes.join(', ') : '특이사항 없음'}
                    
                    [요청사항]
                    1. 인삿말: 노고에 대한 감사 (계절감 반영)
                    2. 급여 요약: 이번 달 근무 시간과 급여 구성에 대한 간략한 설명
                    3. 특이사항: 주휴수당 미지급 건이 있다면 부드럽게 설명, 없다면 성실한 근무 칭찬
                    4. 마무리: 건강 유의 및 격려
                    5. 말투: 정중하고 따뜻한 '해요'체
                    6. 포맷: 가독성 좋은 마크다운 (이모지 적절히 사용)
                `;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                const data = await response.json();
                if(data.error) throw new Error(data.error.message);
                
                const text = data.candidates[0].content.parts[0].text;
                container.innerHTML = `<div class="prose prose-sm max-w-none text-gray-700 leading-relaxed">${marked.parse(text)}</div>`;
                
            } catch (e) {
                container.innerHTML = `
                    <div class="text-center py-10">
                        <div class="text-red-500 text-4xl mb-3"><i class="fas fa-exclamation-circle"></i></div>
                        <h4 class="font-bold text-gray-800">분석에 실패했습니다</h4>
                        <p class="text-sm text-gray-500 mt-2">${e.message}</p>
                        <button onclick="checkAndOpenAIReport('${staffId}')" class="mt-4 px-4 py-2 bg-gray-100 rounded-lg text-sm font-bold">재시도</button>
                    </div>
                `;
            }
        }

        // --- Render Inputs Helpers ---
        function renderWorkDaysInputs(){const c=document.getElementById('work-days-container');if(c.children.length>0)return;const d=['월','화','수','목','금','토','일'];d.forEach((day,i)=>c.innerHTML+=`<div class="flex items-center gap-2"><span class="w-6 text-sm font-bold text-gray-600">${day}</span><input type="time" name="def_s_${i+1}" class="toss-input py-1 text-sm"><span class="text-gray-300">~</span><input type="time" name="def_e_${i+1}" class="toss-input py-1 text-sm"></div>`)}
        function toggleResignDate(){const w=document.getElementById('staff-is-working').checked;document.getElementById('staff-resign-date').disabled=w;if(w)document.getElementById('staff-resign-date').value=''}
        function togglePayInputs(){const t=document.querySelector('input[name="payType"]:checked').value;document.getElementById('label-base-pay').innerText=t==='monthly'?'월 기본급':'시급';document.getElementById('hourly-options').classList.toggle('hidden',t==='monthly')}
        function toggleTimeInputs(){const s=document.getElementById('work-status').value;document.getElementById('time-inputs').classList.toggle('hidden',s!=='work')}
        function calculateDuration(){const s=document.getElementById('start-time').value,e=document.getElementById('end-time').value;if(!s||!e){document.getElementById('calc-hours').innerText='0';return}const d1=new Date(`2000-01-01T${s}`),d2=new Date(`2000-01-01T${e}`);if(d2<d1)d2.setDate(d2.getDate()+1);const h=(d2-d1)/36e5;let b=0;if(h>=8)b=60;else if(h>=4)b=30;document.getElementById('calc-hours').innerText=(h-b/60).toFixed(1);document.getElementById('calc-break').innerText=b}
        let pickerYear=2025;
        function openDatePicker(){pickerYear=currentYear;document.getElementById('picker-year').innerText=pickerYear;document.getElementById('date-picker-modal').classList.remove('hidden')}
        function closeDatePicker(){document.getElementById('date-picker-modal').classList.add('hidden')}
        function adjustPickerYear(d){pickerYear+=d;document.getElementById('picker-year').innerText=pickerYear}
        function selectPickerMonth(m){currentYear=pickerYear;currentMonth=m;const d=new Date(currentYear,currentMonth,1);const dy=d.getDay();const diff=d.getDate()-dy+(dy===0?-6:1);currentWeekStart=new Date(d.setDate(diff));closeDatePicker();renderCalendar()}
        
        // --- Formatter ---
        function formatTimeSimple(t) {
            if (!t) return '';
            if (t.length > 5 && (t.includes('T') || t.includes('-'))) {
                const d = new Date(t);
                if (isNaN(d.getTime())) return t;
                const h = String(d.getHours()).padStart(2, '0');
                const m = String(d.getMinutes()).padStart(2, '0');
                return `${h}:${m}`;
            }
            return t.substring(0, 5);
        }

        // --- UI Renders ---
        function renderStaffList(){const l=document.getElementById('staff-list');document.getElementById('staff-count').innerText=staffData.length;l.innerHTML='';staffData.forEach(s=>{const t=s.payType==='monthly'?`월급 ${formatMoney(s.basePay)}`:`시급 ${formatMoney(s.basePay)}`;const c=document.createElement('div');c.className='toss-card flex justify-between items-center cursor-pointer hover:translate-x-1 hover:shadow-md transition-all';c.onclick=()=>openStaffModal(s.id);c.innerHTML=`<div class="flex items-center gap-4"><div class="w-12 h-12 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-lg">${s.name[0]}</div><div><div class="font-bold text-lg text-gray-800">${s.name}<span class="text-xs px-2 py-0.5 rounded ml-1 font-bold ${s.role==='manager'?'text-blue-600 bg-blue-50':'text-green-600 bg-green-50'}">${s.role==='manager'?'매니저':'스태프'}</span>${!s.isWorking?'<span class="text-xs bg-gray-100 text-gray-500 px-1 rounded ml-1">퇴사</span>':''}</div><div class="text-gray-500 text-sm mt-0.5 font-medium">${t} • ${s.bank}</div></div></div><i class="fas fa-chevron-right text-gray-300"></i>`;l.appendChild(c)})}
        function renderScheduleStaffList(){const l=document.getElementById('schedule-staff-list');l.innerHTML='';staffData.forEach(s=>{const a=s.id===selectedScheduleStaffId;const c=document.createElement('div');c.className=`flex-shrink-0 md:flex-shrink w-auto md:w-full p-3 rounded-xl cursor-pointer transition-all flex items-center gap-3 ${a?'schedule-staff-active ring-2 ring-blue-500 ring-offset-2':'schedule-staff-inactive'}`;c.onclick=()=>{selectedScheduleStaffId=s.id;renderScheduleStaffList();renderCalendar()};c.innerHTML=`<div class="w-10 h-10 rounded-full ${a?'bg-white/20 text-white':'bg-blue-50 text-blue-600'} flex items-center justify-center font-bold">${s.name[0]}</div><div class="hidden md:block"><div class="font-bold text-sm">${s.name}</div><div class="text-xs ${a?'text-blue-100':'text-gray-400'}">${s.role==='manager'?'매니저':'스태프'}</div></div><div class="md:hidden font-bold text-sm pr-2">${s.name}</div>`;l.appendChild(c)})}
        function renderCalendar(){const d=document.getElementById('current-month-display');if(!selectedScheduleStaffId)return;if(scheduleViewMode==='month'){d.innerText=`${currentYear}년 ${currentMonth+1}월`;const g=document.getElementById('calendar-grid');g.innerHTML='';const fd=new Date(currentYear,currentMonth,1).getDay();const dim=new Date(currentYear,currentMonth+1,0).getDate();const off=fd===0?6:fd-1;for(let i=0;i<off;i++)g.innerHTML+=`<div></div>`;for(let i=1;i<=dim;i++)renderDayCard(g,currentYear,currentMonth,i)}else{const ed=new Date(currentWeekStart);ed.setDate(ed.getDate()+6);d.innerText=`${currentWeekStart.getMonth()+1}월 ${currentWeekStart.getDate()}일 - ${ed.getMonth()+1}월 ${ed.getDate()}일`;renderWeekGrid()}}
        function renderDayCard(c,y,m,d){const k=`${selectedScheduleStaffId}_${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;const sch=schedules[k];let h=`<span class="text-gray-300 text-xs">-</span>`,bg='bg-white hover:bg-gray-50',br='border-gray-100';if(sch){if(sch.status==='work'){h=`<span class="text-blue-600 font-bold text-xs bg-blue-50 px-1.5 py-0.5 rounded-md">${sch.totalHours}h</span>`;bg='bg-white hover:border-blue-300';br='border-blue-100 ring-1 ring-blue-50'}else if(sch.status==='absent'){h=`<span class="text-red-500 font-bold text-xs bg-red-50 px-1.5 py-0.5 rounded-md">결근</span>`;bg='bg-white hover:border-red-300';br='border-red-100 ring-1 ring-red-50'}else h=`<span class="text-gray-400 font-medium text-xs">휴무</span>`}const el=document.createElement('div');el.className=`h-24 md:h-28 border rounded-2xl flex flex-col items-center justify-center cursor-pointer transition-all ${bg} ${br}`;el.onclick=()=>openScheduleModal(d,selectedScheduleStaffId,y,m);el.innerHTML=`<span class="text-sm font-medium mb-2 text-gray-700">${d}</span>${h}`;c.appendChild(el)}
        function renderWeekGrid(){const h=document.getElementById('week-header-row');h.innerHTML=`<div class="p-2 border-r border-gray-100 bg-gray-50 sticky left-0 z-30"></div>`;const b=document.getElementById('week-grid-body');while(b.children.length>1)b.removeChild(b.lastChild);const days=['월','화','수','목','금','토','일'];for(let i=0;i<7;i++){const d=new Date(currentWeekStart);d.setDate(d.getDate()+i);const dn=d.getDate(),dl=days[i],clr=i===5?'text-blue-500':(i===6?'text-red-500':'text-gray-600');h.innerHTML+=`<div class="text-center py-2 border-r border-gray-100 font-bold text-sm bg-white"><div class="${clr}">${dl}</div><div class="text-lg">${dn}</div></div>`;const col=document.createElement('div');col.className="border-r border-gray-100 relative bg-white";for(let hr=0;hr<24;hr++){createTimeSlot(col,d,hr,0);createTimeSlot(col,d,hr,30)}const ds=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;const k=`${selectedScheduleStaffId}_${ds}`;const sch=schedules[k];if(sch&&sch.status==='work'){const[sH,sM]=sch.start.split(':').map(Number);const[eH,eM]=sch.end.split(':').map(Number);const st=(sH)*60+sM,et=(eH)*60+eM;if(st>=0){const blk=document.createElement('div');blk.className='schedule-block';blk.style.top=`${(st/30)*20}px`;blk.style.height=`${((et-st)/30)*20}px`;blk.innerHTML=`<span class="truncate">${sch.start}-${sch.end}</span>`;blk.onclick=(e)=>{e.stopPropagation();openScheduleModal(dn,selectedScheduleStaffId,d.getFullYear(),d.getMonth())};col.appendChild(blk)}}b.appendChild(col)}}
        let isDragging=false,dragStartEl=null;
        function createTimeSlot(c,d,h,m){const s=document.createElement('div');s.className="time-grid-cell cursor-pointer";Object.assign(s.dataset,{year:d.getFullYear(),month:d.getMonth(),day:d.getDate(),hour:h,min:m});s.onmousedown=()=>{isDragging=true;dragStartEl=s;updateSelection(s)};s.onmouseover=()=>{if(isDragging)updateSelection(s)};s.onmouseup=()=>{if(isDragging){isDragging=false;finishDrag(s)}};c.appendChild(s)}
        function updateSelection(c){document.querySelectorAll('.time-grid-cell.selected').forEach(e=>e.classList.remove('selected'));if(dragStartEl&&dragStartEl.parentElement===c.parentElement){const sib=[...dragStartEl.parentElement.children].filter(e=>e.classList.contains('time-grid-cell')),idx1=sib.indexOf(dragStartEl),idx2=sib.indexOf(c);for(let i=Math.min(idx1,idx2);i<=Math.max(idx1,idx2);i++)sib[i].classList.add('selected')}}
        function finishDrag(e){if(!dragStartEl||dragStartEl.parentElement!==e.parentElement){dragStartEl=null;return}document.querySelectorAll('.time-grid-cell.selected').forEach(el=>el.classList.remove('selected'));const ds=dragStartEl.dataset,de=e.dataset;const t1=parseInt(ds.hour)*60+parseInt(ds.min),t2=parseInt(de.hour)*60+parseInt(de.min),s=Math.min(t1,t2),end=Math.max(t1,t2)+30;openScheduleModal(parseInt(ds.day),selectedScheduleStaffId,parseInt(ds.year),parseInt(ds.month));document.getElementById('work-status').value='work';toggleTimeInputs();document.getElementById('start-time').value=`${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;document.getElementById('end-time').value=`${String(Math.floor(end/60)).padStart(2,'0')}:${String(end%60).padStart(2,'0')}`;calculateDuration();dragStartEl=null}
        
        // --- PAYROLL CALCULATION ENGINE ---
        function getLocalDateString(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function parseLocalDate(str) {
            if(!str) return null;
            const [y, m, d] = str.split('-').map(Number);
            return new Date(y, m - 1, d);
        }

        function renderPayroll() {
            const container = document.getElementById('payroll-list');
            container.innerHTML = '';
            payrollResults = {}; 

            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

            staffData.forEach(staff => {
                let hourlyRate = 0;
                let calculationNote = "";

                // Calculate Hourly Rate
                if(staff.payType === 'monthly') {
                    let workingDays = 0;
                    for(let d=1; d<=daysInMonth; d++) {
                        const day = new Date(currentYear, currentMonth, d).getDay();
                        if(day >=1 && day <=5) workingDays++;
                    }
                    const totalMonthly = staff.basePay + staff.allowance;
                    const rawRate = (totalMonthly / workingDays / 8) / 1.2;
                    hourlyRate = Math.ceil(rawRate);
                    calculationNote = `통상시급: (${formatMoney(totalMonthly)} / ${workingDays}일 / 8h / 1.2) = ${formatMoney(hourlyRate)}`;
                } else {
                    if(staff.juhyuIncluded) {
                        const totalHourly = staff.basePay + staff.allowance; 
                        hourlyRate = Math.ceil(totalHourly / 1.2);
                        calculationNote = `통상시급(주휴포함 역산): (${formatMoney(totalHourly)}) / 1.2 = ${formatMoney(hourlyRate)}`;
                    } else {
                        hourlyRate = staff.basePay + staff.allowance;
                        calculationNote = `시급: ${formatMoney(hourlyRate)}`;
                    }
                }

                let totalWorkPay = 0;
                let totalJuhyuPay = 0;
                let totalHours = 0;
                let dailyDetails = [];
                let juhyuNotes = [];
                
                // Identify all weeks involved (Monday based, Local Time)
                const distinctWeekKeys = new Set();
                for(let d=1; d<=daysInMonth; d++) {
                    const date = new Date(currentYear, currentMonth, d);
                    const day = date.getDay(); // 0(Sun)...6(Sat)
                    const diff = date.getDate() - day + (day === 0 ? -6 : 1); // Adjust to Monday
                    const mondayDate = new Date(date);
                    mondayDate.setDate(diff);
                    
                    const weekKey = getLocalDateString(mondayDate);
                    distinctWeekKeys.add(weekKey);
                }

                // Analyze each week fully (Mon-Sun)
                const weekAnalysis = {};
                
                distinctWeekKeys.forEach(weekKey => {
                    // weekKey is YYYY-MM-DD of Monday
                    const monday = parseLocalDate(weekKey);
                    const sunday = new Date(monday);
                    sunday.setDate(monday.getDate() + 6);

                    let weekTotalHours = 0;
                    let weekWorkPay = 0;
                    let hasMissedDay = false;
                    let missedReason = "";
                    let weekHasJoin = false;
                    let weekHasResign = false;

                    // Parse Join/Resign as Local Date to compare correctly
                    const joinD = parseLocalDate(staff.joinDate);
                    const resignD = staff.resignDate ? parseLocalDate(staff.resignDate) : null;

                    // Normalize for safe comparison (set to 00:00:00)
                    const mTime = monday.getTime();
                    const sTime = sunday.getTime();
                    
                    // 입사일 체크: 해당 주 월요일보다 입사일이 늦으면 (화~일 입사) -> 만근 불가 간주
                    if (joinD && joinD.getTime() > mTime) weekHasJoin = true; 
                    
                    // 퇴사일 체크: 해당 주 일요일보다 퇴사일이 빠르면 (월~토 퇴사) -> 만근 불가 간주
                    // 단, 퇴사일이 일요일(sTime)과 같으면 만근 가능
                    if (resignD && resignD.getTime() < sTime) weekHasResign = true;

                    // Iterate Mon(0) to Sun(6) for this week
                    for(let i=0; i<7; i++) {
                        const loopDate = new Date(monday);
                        loopDate.setDate(monday.getDate() + i);
                        const dateStr = getLocalDateString(loopDate);
                        
                        const sch = schedules[`${staff.id}_${dateStr}`];
                        
                        // Default Schedule Check
                        let dayIdx = loopDate.getDay();
                        dayIdx = dayIdx === 0 ? 7 : dayIdx; // 1(Mon) ... 7(Sun)

                        const isDefaultWorkDay = staff.defaultSchedule && staff.defaultSchedule[dayIdx];

                        if (sch && sch.status === 'work') {
                            weekTotalHours += sch.totalHours;
                            weekWorkPay += Math.ceil(sch.totalHours * hourlyRate);
                        }

                        // Check Missed Attendance
                        if (isDefaultWorkDay) {
                            if (!sch) {
                                hasMissedDay = true;
                                missedReason = `기록 미입력(${dateStr})`;
                            } else if (sch.status === 'absent') {
                                hasMissedDay = true;
                                missedReason = `결근(${dateStr})`;
                            }
                        }
                    }

                    // Determine Juhyu Eligibility
                    let isEligible = true;
                    let failReason = "";

                    if (weekTotalHours < 15) { isEligible = false; failReason = "15시간 미만"; }
                    else if (hasMissedDay) { isEligible = false; failReason = missedReason; }
                    else if (weekHasJoin) { isEligible = false; failReason = "입사 주간"; }
                    else if (weekHasResign) { isEligible = false; failReason = "퇴사 주간"; }

                    weekAnalysis[weekKey] = {
                        isEligible,
                        failReason,
                        hours: weekTotalHours,
                        basePay: weekWorkPay
                    };
                    
                    if (!isEligible && weekTotalHours > 0) {
                        const mStr = `${monday.getMonth()+1}/${monday.getDate()}`;
                        const sStr = `${sunday.getMonth()+1}/${sunday.getDate()}`;
                        // Filter notes to only show relevant weeks for current view
                        if(monday.getMonth() === currentMonth || sunday.getMonth() === currentMonth) {
                            juhyuNotes.push(`${mStr}~${sStr} 주휴 제외: ${failReason}`);
                        }
                    }
                });

                // Generate Display Data
                for(let d=1; d<=daysInMonth; d++) {
                    const date = new Date(currentYear, currentMonth, d);
                    const dateStr = getLocalDateString(date);
                    
                    const day = date.getDay();
                    const diff = date.getDate() - day + (day === 0 ? -6 : 1);
                    const mondayDate = new Date(date);
                    mondayDate.setDate(diff);
                    const weekKey = getLocalDateString(mondayDate);

                    const sch = schedules[`${staff.id}_${dateStr}`];
                    let dailyPay = 0;
                    let dailyHours = 0;
                    let statusStr = '-';
                    let timeStr = '-';
                    let juhyuAmt = 0;
                    let juhyuReason = null;

                    if(sch && sch.status === 'work') {
                        dailyHours = sch.totalHours;
                        dailyPay = Math.ceil(dailyHours * hourlyRate);
                        statusStr = '근무';
                        timeStr = `${formatTimeSimple(sch.start)}~${formatTimeSimple(sch.end)}`;
                        
                        const wStats = weekAnalysis[weekKey];
                        if(wStats && wStats.isEligible) {
                            juhyuAmt = Math.ceil(dailyPay * 0.2);
                        } else if(wStats) {
                            juhyuReason = wStats.failReason;
                        }
                    } else if(sch && sch.status === 'absent') {
                        statusStr = '결근';
                    }

                    if(statusStr !== '-') {
                        dailyDetails.push({
                            date: dateStr,
                            time: timeStr,
                            status: statusStr,
                            hours: dailyHours,
                            pay: dailyPay,
                            juhyu: juhyuAmt,
                            juhyuReason: juhyuReason
                        });
                        totalWorkPay += dailyPay;
                        totalJuhyuPay += juhyuAmt;
                        totalHours += dailyHours;
                    }
                }

                const totalGross = totalWorkPay + totalJuhyuPay;
                let deductionDetails = [];
                let totalDeduction = 0;

                if(staff.contractType === 'freelancer') {
                    const incomeTax = Math.floor(totalGross * 0.03 / 10) * 10;
                    const localTax = Math.floor(incomeTax * 0.1 / 10) * 10;
                    deductionDetails.push({ name: '사업소득세(3%)', amount: incomeTax });
                    deductionDetails.push({ name: '지방소득세(0.3%)', amount: localTax });
                    totalDeduction = incomeTax + localTax;
                } else if(staff.contractType === '4major') {
                    const pension = Math.floor(totalGross * 0.045 / 10) * 10;
                    const health = Math.floor(totalGross * 0.03545 / 10) * 10;
                    const care = Math.floor(health * 0.1295 / 10) * 10;
                    const emp = Math.floor(totalGross * 0.009 / 10) * 10;
                    deductionDetails.push({ name: '국민연금(4.5%)', amount: pension });
                    deductionDetails.push({ name: '건강보험(3.545%)', amount: health });
                    deductionDetails.push({ name: '장기요양(12.95%)', amount: care });
                    deductionDetails.push({ name: '고용보험(0.9%)', amount: emp });
                    totalDeduction = pension + health + care + emp;
                } else { // 2major
                    const emp = Math.floor(totalGross * 0.009 / 10) * 10;
                    deductionDetails.push({ name: '고용보험(0.9%)', amount: emp });
                    totalDeduction = emp;
                }
                
                const netPay = totalGross - totalDeduction;

                payrollResults[staff.id] = {
                    staff,
                    totalHours,
                    totalWorkPay,
                    totalJuhyuPay,
                    totalGross,
                    netPay,
                    juhyuNotes,
                    dailyDetails // Store for AI Report
                };

                const wrapper = document.createElement('div');
                wrapper.className = 'toss-card';
                
                const detailRows = dailyDetails.map(d => `
                    <tr class="border-b border-gray-100 last:border-0 text-sm hover:bg-gray-50">
                        <td class="py-3 pl-2 text-gray-500">${d.date.slice(5)}</td>
                        <td class="py-3 font-medium ${d.status==='결근'?'text-red-500':''}">${d.time}<br><span class="text-xs text-gray-400">${d.status}</span></td>
                        <td class="py-3 text-right">${d.hours}h</td>
                        <td class="py-3 text-right text-gray-600">${formatMoney(d.pay)}</td>
                        <td class="py-3 text-right ${d.juhyu?'text-blue-500':'text-gray-400'}">${d.juhyu ? formatMoney(d.juhyu) : (d.juhyuReason ? `<span class="text-[10px] text-red-400">${d.juhyuReason}</span>` : '-')}</td>
                        <td class="py-3 text-right pr-2 font-bold">${formatMoney(d.pay + (d.juhyu||0))}</td>
                    </tr>
                `).join('');

                wrapper.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800">${staff.name} <span class="text-sm font-normal text-gray-500">(${staff.role === 'manager' ? '매니저' : '스태프'})</span></h3>
                            <p class="text-xs text-gray-400 mt-1">${calculationNote}</p>
                            <div class="text-xs text-gray-400 mt-1">${staff.bank} ${staff.account} (${staff.accountHolder})</div>
                        </div>
                        <div class="text-right">
                            <button onclick="checkAndOpenAIReport('${staff.id}')" class="toss-btn-ai mb-2">
                                <i class="fas fa-sparkles"></i> AI 리포트
                            </button>
                            <div class="text-2xl font-bold text-blue-600">${formatMoney(netPay)}</div>
                            <div class="text-xs text-gray-400 font-medium">세후 예상 수령액</div>
                        </div>
                    </div>

                    <div class="bg-gray-50 rounded-xl p-4 space-y-3 text-sm mb-4">
                        <div class="flex justify-between border-b border-gray-200 pb-2">
                            <span class="text-gray-500">지급 총액 (세전)</span>
                            <span class="font-bold text-gray-700">${formatMoney(totalGross)}</span>
                        </div>
                        
                        <!-- Deductions Accordion -->
                        <details class="group/deduction">
                            <summary class="flex justify-between items-center cursor-pointer list-none text-gray-500 hover:text-gray-700">
                                <span class="flex items-center gap-1">공제 총액 (${staff.contractType==='freelancer'?'3.3%':(staff.contractType==='4major'?'4대보험':'2대보험')}) <i class="fas fa-chevron-down text-xs transition-transform group-open/deduction:rotate-180"></i></span>
                                <span class="text-red-500 font-medium">-${formatMoney(totalDeduction)}</span>
                            </summary>
                            <div class="mt-2 pl-2 space-y-1 text-xs text-gray-500 bg-white p-2 rounded-lg border border-gray-100">
                                ${deductionDetails.map(d => `<div class="flex justify-between"><span>${d.name}</span><span>-${formatMoney(d.amount)}</span></div>`).join('')}
                            </div>
                        </details>

                        ${juhyuNotes.length > 0 ? `
                        <div class="pt-2 border-t border-gray-200 mt-1">
                            <span class="text-xs text-red-500 font-bold flex items-center gap-1 mb-1"><i class="fas fa-exclamation-triangle"></i> 주휴 미지급 알림</span>
                            <ul class="text-xs text-gray-500 list-disc pl-4 space-y-0.5">
                                ${juhyuNotes.map(n => `<li>${n}</li>`).join('')}
                            </ul>
                        </div>` : ''}
                    </div>

                    <details class="group">
                        <summary class="flex justify-between items-center cursor-pointer list-none py-3 border-t border-gray-100 hover:bg-gray-50 px-2 -mx-2 rounded-lg transition-colors">
                            <span class="font-bold text-gray-600 text-sm">일별 상세 내역 보기</span>
                            <span class="transition-transform group-open:rotate-180"><i class="fas fa-chevron-down text-gray-400"></i></span>
                        </summary>
                        <div class="mt-2 overflow-x-auto">
                            <table class="w-full text-left whitespace-nowrap">
                                <thead class="bg-gray-50 text-gray-500">
                                    <tr class="text-xs border-b border-gray-200">
                                        <th class="py-2 pl-2 rounded-tl-lg">날짜</th>
                                        <th class="py-2">근무시간/상태</th>
                                        <th class="py-2 text-right">시간</th>
                                        <th class="py-2 text-right">기본급</th>
                                        <th class="py-2 text-right">주휴</th>
                                        <th class="py-2 text-right pr-2 rounded-tr-lg">지급액</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${detailRows}
                                </tbody>
                            </table>
                        </div>
                    </details>
                `;
                container.appendChild(wrapper);
            });
        }

        // --- Standard UI Helpers ---
        function formatMoney(n){return Math.floor(n).toLocaleString()+'원'}
        function showToast(m){const t=document.getElementById('toast');t.innerText=m;t.style.opacity='1';setTimeout(()=>t.style.opacity='0',3000)}
        function toggleViewMode(m){scheduleViewMode=m;const bm=document.getElementById('btn-view-month'),bw=document.getElementById('btn-view-week');if(m==='month'){bm.classList.add('bg-white','text-blue-600','shadow-sm');bm.classList.remove('text-gray-500');bw.classList.remove('bg-white','text-blue-600','shadow-sm');bw.classList.add('text-gray-500');document.getElementById('month-view-container').classList.remove('hidden');document.getElementById('week-view-container').classList.add('hidden')}else{bw.classList.add('bg-white','text-blue-600','shadow-sm');bw.classList.remove('text-gray-500');bm.classList.remove('bg-white','text-blue-600','shadow-sm');bm.classList.add('text-gray-500');document.getElementById('month-view-container').classList.add('hidden');document.getElementById('week-view-container').classList.remove('hidden')}renderCalendar()}
        function changeDateRange(d){if(scheduleViewMode==='month'){currentMonth+=d;if(currentMonth>11){currentMonth=0;currentYear++}if(currentMonth<0){currentMonth=11;currentYear--}}else{currentWeekStart.setDate(currentWeekStart.getDate()+(d*7));currentYear=currentWeekStart.getFullYear();currentMonth=currentWeekStart.getMonth()}renderCalendar()}
        
        // --- Modal Toggles ---
        function openScheduleModal(d,sid,y,m){
            editingStaffId=sid;
            editingDateStr=`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            document.getElementById('schedule-modal-date').innerText=`${m+1}월 ${d}일`;
            
            const s=schedules[`${sid}_${editingDateStr}`];
            
            if(s){
                document.getElementById('work-status').value=s.status;
                document.getElementById('start-time').value=s.start;
                document.getElementById('end-time').value=s.end;
                document.getElementById('btn-delete-schedule').classList.remove('hidden');
            } else {
                document.getElementById('work-status').value='work';
                document.getElementById('btn-delete-schedule').classList.add('hidden');
                
                // Auto-fill logic
                const dateObj = new Date(y, m, d);
                let dayKey = dateObj.getDay(); 
                if(dayKey === 0) dayKey = 7; // Convert Sun 0 -> 7
                
                const staff = staffData.find(st => st.id === sid);
                if(staff && staff.defaultSchedule && staff.defaultSchedule[dayKey]) {
                    document.getElementById('start-time').value = staff.defaultSchedule[dayKey].s;
                    document.getElementById('end-time').value = staff.defaultSchedule[dayKey].e;
                } else {
                    document.getElementById('start-time').value='';
                    document.getElementById('end-time').value='';
                }
            }
            
            toggleTimeInputs();
            calculateDuration();
            document.getElementById('schedule-modal').classList.remove('hidden');
        }
        
        function closeScheduleModal(){document.getElementById('schedule-modal').classList.add('hidden')}

        init();
    </script>
</body>
</html>
