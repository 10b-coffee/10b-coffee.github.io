<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="robots" content="noindex, nofollow">
    <title>레스토지니 v2.0.5 (Payslip Restore)</title>
    
    <!-- Pretendard Font -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body { font-family: "Pretendard Variable", Pretendard, sans-serif; background-color: #F2F4F6; color: #191F28; -webkit-font-smoothing: antialiased; }
        .toss-card { background: #FFFFFF; border-radius: 24px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03); padding: 24px; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .toss-btn-primary { background-color: #3182F6; color: white; font-weight: 600; border-radius: 12px; padding: 14px 20px; transition: background-color 0.2s; }
        .toss-btn-primary:hover { background-color: #1B64DA; }
        .toss-btn-ai { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; font-weight: 600; border-radius: 12px; padding: 10px 16px; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 6px; }
        .toss-input { background-color: #F9FAFB; border: 1px solid #E5E8EB; border-radius: 12px; padding: 14px; font-size: 16px; width: 100%; transition: border-color 0.2s; }
        .toss-input:focus { outline: none; border-color: #3182F6; }
        .toss-input:disabled { background-color: #F2F4F6; color: #B0B8C1; cursor: not-allowed; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #D1D6DB; border-radius: 3px; }
        .nav-item-active { background-color: #E8F3FF; color: #3182F6; }
        .nav-item-inactive { color: #8B95A1; }
        .nav-item-inactive:hover { background-color: #F9FAFB; color: #191F28; }
        .schedule-staff-active { background-color: #3182F6; color: white; box-shadow: 0 4px 12px rgba(49, 130, 246, 0.3); }
        .schedule-staff-inactive { background-color: white; color: #4E5968; border: 1px solid #E5E8EB; }
        .time-grid-cell { border-bottom: 1px solid #F2F4F6; border-right: 1px solid #F2F4F6; height: 40px; position: relative; user-select: none; }
        .time-grid-cell:hover { background-color: #F9FAFB; }
        .time-grid-cell.selected { background-color: #E8F3FF; }
        .schedule-block { position: absolute; left: 2px; right: 2px; background-color: #3182F6; color: white; border-radius: 6px; padding: 4px; font-size: 11px; font-weight: 600; overflow: hidden; z-index: 10; pointer-events: auto; box-shadow: 0 2px 4px rgba(49, 130, 246, 0.3); cursor: pointer; transition: transform 0.1s; }
        .schedule-block:hover { transform: scale(1.02); z-index: 20; }
        .ai-loading-dots span { display: inline-block; width: 6px; height: 6px; border-radius: 50%; background-color: #8b5cf6; animation: bounce 1.4s infinite ease-in-out both; margin: 0 2px; }
        .ai-loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .ai-loading-dots span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body class="h-screen w-screen flex overflow-hidden bg-[#F2F4F6]">

    <!-- Loading Overlay -->
    <div id="global-loading" class="hidden fixed inset-0 z-[9999] bg-white/80 backdrop-blur-sm flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
        <p class="text-blue-600 font-bold animate-pulse" id="loading-text">데이터 동기화 중...</p>
    </div>

    <!-- Left Sidebar -->
    <aside class="w-64 bg-white border-r border-gray-100 flex flex-col hidden md:flex z-20 shadow-sm shrink-0">
        <div class="p-8 pb-4 flex items-center gap-3">
            <div class="w-9 h-9 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-blue-200 shadow-lg">R</div>
            <h1 class="text-xl font-extrabold tracking-tight text-[#191F28]">RestoGenie</h1>
        </div>
        <nav class="flex-1 px-4 space-y-2 mt-6">
            <button onclick="switchTab('staff')" id="nav-staff" class="w-full flex items-center gap-3 px-5 py-3.5 rounded-2xl text-left font-bold transition-all nav-item-active"><i class="fas fa-users w-5 text-center"></i> 직원 관리</button>
            <button onclick="switchTab('schedule')" id="nav-schedule" class="w-full flex items-center gap-3 px-5 py-3.5 rounded-2xl text-left font-bold transition-all nav-item-inactive"><i class="far fa-calendar-alt w-5 text-center"></i> 근무 일정</button>
            <button onclick="switchTab('payroll')" id="nav-payroll" class="w-full flex items-center gap-3 px-5 py-3.5 rounded-2xl text-left font-bold transition-all nav-item-inactive"><i class="fas fa-coins w-5 text-center"></i> 급여 정산</button>
        </nav>
        <div class="p-6 border-t border-gray-100">
            <div class="flex items-center gap-3 mb-2">
                <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-400"><i class="fas fa-user"></i></div>
                <div>
                    <div class="text-xs text-gray-400 font-medium">관리자 모드</div>
                    <div class="text-sm font-bold text-gray-700">김점장님</div>
                </div>
            </div>
            <div class="text-xs text-gray-300 mt-2 pl-1">v2.0.5 (Payslip Restore)</div>
            <button onclick="openConfig()" class="text-xs text-blue-400 underline mt-1 pl-1">API 설정</button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full relative overflow-hidden">
        <header class="md:hidden bg-white px-5 py-4 flex justify-between items-center shadow-sm z-10 sticky top-0 shrink-0">
             <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold">R</div>
                <h1 class="text-xl font-bold tracking-tight">RestoGenie</h1>
            </div>
            <div onclick="openConfig()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 cursor-pointer"><i class="fas fa-cog"></i></div>
        </header>

        <div class="flex-1 overflow-y-auto p-0 md:p-8 pb-24 md:pb-8 space-y-8 scroll-smooth" id="main-scroll">
            
            <!-- STAFF TAB -->
            <section id="view-staff" class="space-y-6 max-w-4xl mx-auto px-5 md:px-0 pt-5 md:pt-0">
                <div class="flex flex-col md:flex-row md:justify-between md:items-end gap-4">
                    <div>
                        <h2 class="text-3xl font-bold">직원 관리</h2>
                        <p class="text-[#8B95A1] mt-2 text-sm font-medium">현재 총 <span id="staff-count" class="text-blue-600 font-bold">0</span>명이 함께하고 있어요</p>
                    </div>
                    <button onclick="openStaffModal()" class="toss-btn-primary text-sm shadow-lg shadow-blue-100">+ 직원 등록</button>
                </div>
                <div id="staff-list" class="space-y-4"></div>
            </section>

            <!-- SCHEDULE TAB -->
            <section id="view-schedule" class="hidden h-full flex flex-col md:flex-row gap-6 max-w-7xl mx-auto px-5 md:px-0 pt-5 md:pt-0">
                <div class="md:w-64 shrink-0 flex flex-col gap-4">
                    <h2 class="text-2xl font-bold md:mb-2">근무 일정</h2>
                    <div id="schedule-staff-list" class="flex md:flex-col gap-3 overflow-x-auto md:overflow-visible pb-2 md:pb-0 scrollbar-hide"></div>
                </div>
                <div class="flex-1 flex flex-col gap-4 h-full pb-10">
                    <div class="bg-white rounded-2xl p-4 shadow-sm flex flex-col sm:flex-row justify-between items-center gap-4 shrink-0">
                        <div class="flex items-center gap-2">
                            <button onclick="changeDateRange(-1)" class="w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center transition-colors text-gray-500"><i class="fas fa-chevron-left"></i></button>
                            <div onclick="openDatePicker()" class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 px-3 py-1.5 rounded-lg transition-colors group">
                                <span id="current-month-display" class="text-xl font-bold text-gray-800">2025년 12월</span>
                                <i class="fas fa-chevron-down text-gray-400 text-xs group-hover:text-gray-600"></i>
                            </div>
                            <button onclick="changeDateRange(1)" class="w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center transition-colors text-gray-500"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div class="flex bg-gray-100 p-1 rounded-xl">
                            <button onclick="toggleViewMode('month')" id="btn-view-month" class="px-4 py-1.5 rounded-lg text-sm font-bold bg-white text-blue-600 shadow-sm">월간</button>
                            <button onclick="toggleViewMode('week')" id="btn-view-week" class="px-4 py-1.5 rounded-lg text-sm font-bold text-gray-500">주간</button>
                        </div>
                    </div>
                    <div id="calendar-container" class="toss-card flex-1 min-h-[500px] overflow-hidden relative p-0 flex flex-col">
                        <div id="month-view-container" class="flex flex-col h-full">
                            <div class="grid grid-cols-7 gap-1 text-center border-b border-gray-100 pb-2 bg-white z-10 p-4">
                                <div class="text-sm text-gray-400 font-medium">월</div><div class="text-sm text-gray-400 font-medium">화</div><div class="text-sm text-gray-400 font-medium">수</div><div class="text-sm text-gray-400 font-medium">목</div><div class="text-sm text-gray-400 font-medium">금</div><div class="text-sm text-blue-500 font-medium">토</div><div class="text-sm text-red-500 font-medium">일</div>
                            </div>
                            <div id="calendar-grid" class="grid grid-cols-7 gap-2 p-4 overflow-y-auto"></div>
                        </div>
                        <div id="week-view-container" class="hidden flex-1 overflow-y-auto relative h-full flex flex-col">
                            <div class="grid grid-cols-[60px_repeat(7,1fr)] sticky top-0 bg-white z-20 border-b border-gray-200" id="week-header-row"><div class="p-2 border-r border-gray-100 bg-gray-50 sticky left-0 z-30"></div></div>
                            <div class="grid grid-cols-[60px_repeat(7,1fr)] relative flex-1" id="week-grid-body">
                                <div class="flex flex-col border-r border-gray-100 text-xs text-gray-400 font-medium text-center bg-gray-50">
                                    <script>for(let i=0;i<=24;i++) document.write(`<div class="h-[80px] border-b border-gray-100 flex items-start justify-center pt-1">${String(i).padStart(2,'0')}:00</div>`);</script>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- PAYROLL TAB -->
            <section id="view-payroll" class="hidden space-y-6 max-w-4xl mx-auto px-5 md:px-0 pt-5 md:pt-0">
                <div class="flex justify-between items-center">
                    <h2 class="text-3xl font-bold">급여 정산</h2>
                    <div class="text-xs font-bold text-blue-600 bg-blue-50 px-3 py-1.5 rounded-full flex items-center gap-1"><div class="w-1.5 h-1.5 rounded-full bg-blue-600 animate-pulse"></div> 실시간 계산됨</div>
                </div>
                <div id="payroll-list" class="space-y-8"></div>
            </section>
        </div>

        <!-- Mobile Nav -->
        <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 flex justify-around p-2 pb-safe z-30 shadow-[0_-4px_20px_rgba(0,0,0,0.03)]">
            <button onclick="switchTab('staff')" id="mob-staff" class="flex-1 flex flex-col items-center gap-1 py-2 text-blue-600"><i class="fas fa-users text-xl"></i><span class="text-[10px] font-bold">직원</span></button>
            <button onclick="switchTab('schedule')" id="mob-schedule" class="flex-1 flex flex-col items-center gap-1 py-2 text-gray-400"><i class="far fa-calendar-alt text-xl"></i><span class="text-[10px] font-bold">일정</span></button>
            <button onclick="switchTab('payroll')" id="mob-payroll" class="flex-1 flex flex-col items-center gap-1 py-2 text-gray-400"><i class="fas fa-coins text-xl"></i><span class="text-[10px] font-bold">정산</span></button>
        </nav>
    </main>

    <!-- Modals -->
    <!-- API Config Modal -->
    <div id="config-modal" class="fixed inset-0 z-[70] hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 modal-overlay" onclick="closeConfig()"></div>
        <div class="bg-white w-full max-w-md rounded-2xl p-6 relative z-10 shadow-2xl">
            <h3 class="text-xl font-bold mb-4">Google Apps Script 연동</h3>
            <p class="text-sm text-gray-500 mb-4">배포된 GAS 웹 앱 URL을 입력하면 데이터가 클라우드에 저장됩니다.</p>
            <input type="text" id="api-url-input" class="toss-input mb-4" placeholder="https://script.google.com/macros/s/..." >
            <div class="bg-blue-50 p-3 rounded-lg text-xs text-blue-600 mb-4">
                * URL이 없으면 로컬 테스트 모드로 작동합니다.<br>
                * 데이터베이스 연결 시 기존 로컬 데이터는 무시됩니다.
            </div>
            <button onclick="saveConfig()" class="toss-btn-primary w-full">저장 및 다시 로드</button>
        </div>
    </div>

    <!-- Staff Modal -->
    <div id="staff-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 modal-overlay" onclick="closeStaffModal()"></div>
        <div class="absolute bottom-0 left-0 right-0 md:top-1/2 md:left-1/2 md:bottom-auto md:-translate-x-1/2 md:-translate-y-1/2 md:w-[600px] bg-white rounded-t-3xl md:rounded-3xl p-0 shadow-2xl transform transition-transform duration-300 translate-y-full h-[85vh] flex flex-col" id="staff-modal-content">
            <div class="p-6 pb-4 border-b border-gray-100 flex justify-between items-center bg-white rounded-t-3xl shrink-0">
                <h3 class="text-xl font-bold" id="modal-title">직원 등록</h3>
                <button onclick="closeStaffModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            <form id="staff-form" onsubmit="handleStaffSubmit(event)" class="flex-1 overflow-y-auto p-6 space-y-8">
                <input type="hidden" id="staff-id">
                
                <div class="space-y-4">
                    <h4 class="text-sm font-bold text-gray-800 border-l-4 border-blue-500 pl-2">기본 정보</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-xs font-bold text-gray-500 mb-1">이름</label><input type="text" id="staff-name" class="toss-input" required></div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">직책</label>
                            <div class="flex gap-2">
                                <label class="flex-1 cursor-pointer"><input type="radio" name="role" value="staff" class="peer hidden" checked><div class="text-center py-3 rounded-xl bg-gray-50 peer-checked:bg-blue-50 peer-checked:text-blue-500 peer-checked:ring-1 peer-checked:ring-blue-500 font-medium text-xs">스태프</div></label>
                                <label class="flex-1 cursor-pointer"><input type="radio" name="role" value="manager" class="peer hidden"><div class="text-center py-3 rounded-xl bg-gray-50 peer-checked:bg-blue-50 peer-checked:text-blue-500 peer-checked:ring-1 peer-checked:ring-blue-500 font-medium text-xs">매니저</div></label>
                            </div>
                        </div>
                    </div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">주민등록번호</label><div class="flex items-center gap-2"><input type="text" id="staff-rrn-front" class="toss-input text-center" maxlength="6"><span class="text-gray-400">-</span><input type="password" id="staff-rrn-back" class="toss-input text-center" maxlength="7"></div></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">주소</label><input type="text" id="staff-address" class="toss-input"></div>
                </div>

                <div class="space-y-4">
                    <h4 class="text-sm font-bold text-gray-800 border-l-4 border-blue-500 pl-2">근무 정보</h4>
                    <div class="flex items-end gap-4">
                        <div class="flex-1"><label class="block text-xs font-bold text-gray-500 mb-1">입사일</label><input type="date" id="staff-join-date" class="toss-input" required></div>
                        <div class="flex-1"><label class="block text-xs font-bold text-gray-500 mb-1">퇴사일</label><input type="date" id="staff-resign-date" class="toss-input" disabled></div>
                    </div>
                    <div class="flex items-center gap-2"><input type="checkbox" id="staff-is-working" class="w-4 h-4 text-blue-600 rounded" checked onchange="toggleResignDate()"><label for="staff-is-working" class="text-sm text-gray-700 font-medium">재직 중</label></div>
                    <div class="bg-gray-50 p-4 rounded-xl space-y-3"><p class="text-xs font-bold text-gray-500">요일별 기본 근무 시간</p><div id="work-days-container" class="grid grid-cols-1 gap-2"></div></div>
                </div>

                <div class="space-y-4">
                    <h4 class="text-sm font-bold text-gray-800 border-l-4 border-blue-500 pl-2">급여 정보</h4>
                    <div class="flex gap-4 mb-2">
                        <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="payType" value="hourly" class="w-4 h-4 text-blue-600" checked onchange="togglePayInputs()"><span class="text-sm font-medium">시급제</span></label>
                        <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="payType" value="monthly" class="w-4 h-4 text-blue-600" onchange="togglePayInputs()"><span class="text-sm font-medium">월급제</span></label>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-xs font-bold text-gray-500 mb-1" id="label-base-pay">시급</label><input type="number" id="staff-base-pay" class="toss-input text-right" placeholder="0"></div>
                        <div><label class="block text-xs font-bold text-gray-500 mb-1">수당 (직책/기타)</label><input type="number" id="staff-allowance" class="toss-input text-right" placeholder="0"></div>
                    </div>
                    <div id="hourly-options" class="bg-blue-50 p-3 rounded-lg flex items-center gap-2"><input type="checkbox" id="staff-juhyu-included" class="w-4 h-4 text-blue-600 rounded"><label for="staff-juhyu-included" class="text-sm text-blue-800 font-medium">입력된 시급에 주휴수당 포함</label></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">계약 형태</label><select id="staff-contract-type" class="toss-input"><option value="4major">4대보험 (약 9.3%)</option><option value="2major">2대보험 (고용/산재)</option><option value="freelancer">프리랜서 (3.3%)</option></select></div>
                </div>

                <div class="space-y-4">
                    <h4 class="text-sm font-bold text-gray-800 border-l-4 border-blue-500 pl-2">계좌 정보</h4>
                    <div class="grid grid-cols-3 gap-3">
                        <div class="col-span-1"><label class="block text-xs font-bold text-gray-500 mb-1">은행</label><select id="staff-bank" class="toss-input px-2"><option value="">선택</option><option value="KB">국민</option><option value="Shinhan">신한</option><option value="Toss">토스</option><option value="Kakao">카카오</option><option value="Woori">우리</option><option value="Hana">하나</option><option value="NH">농협</option><option value="IBK">기업</option></select></div>
                        <div class="col-span-2"><label class="block text-xs font-bold text-gray-500 mb-1">계좌번호</label><input type="text" id="staff-account" class="toss-input"></div>
                    </div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">예금주</label><input type="text" id="staff-account-holder" class="toss-input"></div>
                </div>

                <div class="pt-4 flex gap-3 pb-safe">
                    <button type="button" onclick="deleteStaff()" id="btn-delete" class="flex-1 py-4 rounded-xl bg-red-50 text-red-500 font-bold hidden">삭제</button>
                    <button type="submit" class="flex-[2] toss-btn-primary w-full shadow-lg shadow-blue-200">저장하기</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Date Picker, Schedule Modal -->
    <div id="date-picker-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center px-4"><div class="absolute inset-0 modal-overlay" onclick="closeDatePicker()"></div><div class="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl relative z-10"><h3 class="text-lg font-bold mb-4 text-center">날짜 이동</h3><div class="flex justify-center items-center gap-4 mb-6"><button onclick="adjustPickerYear(-1)" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center"><i class="fas fa-minus text-xs"></i></button><span id="picker-year" class="text-2xl font-bold text-blue-600">2025</span><button onclick="adjustPickerYear(1)" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center"><i class="fas fa-plus text-xs"></i></button></div><div class="grid grid-cols-4 gap-2"><script>for(let i=1;i<=12;i++)document.write(`<button onclick="selectPickerMonth(${i-1})" class="py-3 rounded-xl font-bold text-sm bg-gray-50 hover:bg-blue-50 hover:text-blue-600">${i}월</button>`);</script></div></div></div>
    <div id="schedule-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center px-4"><div class="absolute inset-0 modal-overlay" onclick="closeScheduleModal()"></div><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative z-10"><h3 class="text-lg font-bold mb-1" id="schedule-modal-date"></h3><p class="text-sm text-gray-500 mb-6">근무 시간 입력</p><div class="space-y-4"><div class="flex justify-between items-center bg-gray-50 p-3 rounded-xl"><span class="font-bold text-gray-700">근무 상태</span><select id="work-status" onchange="toggleTimeInputs()" class="bg-transparent font-bold text-blue-600 outline-none text-right"><option value="work">정상 근무</option><option value="absent">결근</option><option value="off">휴무</option></select></div><div id="time-inputs" class="space-y-3"><div class="flex items-center gap-2"><input type="time" id="start-time" class="toss-input py-2 text-center font-bold" onchange="calculateDuration()"><span class="text-gray-300">~</span><input type="time" id="end-time" class="toss-input py-2 text-center font-bold" onchange="calculateDuration()"></div><div class="text-center text-sm font-medium text-gray-600 bg-gray-50 py-2 rounded-lg">총 <span id="calc-hours" class="text-blue-600 font-bold">0</span>시간 <span class="text-xs text-gray-400">(휴게 <span id="calc-break">0</span>분 자동)</span></div></div><button onclick="saveSchedule()" class="toss-btn-primary w-full mt-4">저장하기</button></div></div></div>
    
    <!-- AI Report Modal (Fix: Added correct ID and animation classes) -->
    <div id="ai-report-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 modal-overlay" onclick="closeAIModal()"></div>
        <div class="absolute bottom-0 left-0 right-0 md:top-1/2 md:left-1/2 md:bottom-auto md:-translate-x-1/2 md:-translate-y-1/2 md:w-[600px] bg-white rounded-t-3xl md:rounded-3xl p-0 shadow-2xl transform transition-transform duration-300 translate-y-full h-[80vh] md:h-auto flex flex-col" id="ai-modal-content">
            <div class="p-6 pb-4 border-b border-gray-100 flex justify-between bg-gradient-to-r from-indigo-50 to-white rounded-t-3xl">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-indigo-500 to-purple-500 flex items-center justify-center text-white"><i class="fas fa-sparkles"></i></div>
                    <h3 class="text-xl font-bold">AI 급여 리포트</h3>
                </div>
                <button onclick="closeAIModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 overflow-y-auto flex-1 bg-white" id="ai-result-container"></div>
            <div class="p-4 border-t border-gray-100">
                <button onclick="copyAIReport()" class="w-full py-3 bg-gray-50 text-gray-700 font-bold rounded-xl">복사하기</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full opacity-0 pointer-events-none z-[100] transition-opacity duration-300"></div>

    <script>
        // === GLOBAL CONFIG ===
        let API_URL = localStorage.getItem('gas_api_url') || "https://script.google.com/macros/s/AKfycbyiLXmBFoDN9dqsiiHXRH_-e-W6Eot02fe__8zEbdxHI1Dwgryd8zr4eAbtQK1OvLdftg/exec"; 
        const GEMINI_API_KEY = ""; 

        // === STATE ===
        let staffData = [];
        let schedules = {}; // Key: staffId_YYYY-MM-DD
        
        let currentYear = 2025;
        let currentMonth = 11; // Dec
        let currentWeekStart = null;
        let selectedScheduleStaffId = null;
        let scheduleViewMode = 'month';

        // === API HANDLER ===
        async function fetchAPI(action, payload = {}) {
            if(!API_URL) return null; 
            
            showLoading(true);
            try {
                if(action === 'getInitialData') {
                    const res = await fetch(`${API_URL}?action=getInitialData`);
                    const json = await res.json();
                    return json;
                } 
                else {
                    const res = await fetch(API_URL, {
                        method: 'POST',
                        mode: 'no-cors', 
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action, ...payload })
                    });
                    return { success: true };
                }
            } catch(e) {
                console.error("API Error", e);
                showToast("데이터 통신 오류: " + e.message);
                return null;
            } finally {
                showLoading(false);
            }
        }

        // === INIT ===
        async function init() {
            const d = new Date(currentYear, currentMonth, 1);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            currentWeekStart = new Date(d.setDate(diff));

            if(API_URL) {
                const cloudData = await fetchAPI('getInitialData');
                if(cloudData) {
                    if(cloudData.staff) {
                        staffData = cloudData.staff;
                        schedules = cloudData.schedules || {};
                    }
                    if(staffData.length === 0) showToast("연동 성공! (현재 데이터 없음)");
                }
            } else {
                if(staffData.length === 0) seedDemoData(); 
            }

            if(staffData.length > 0 && !selectedScheduleStaffId) selectedScheduleStaffId = staffData[0].id;

            renderStaffList();
            renderScheduleStaffList();
            renderCalendar();
            renderPayroll();
            renderWorkDaysInputs();
            
            if(!API_URL) showToast("API URL 미설정: 로컬 모드로 동작합니다");
        }

        function seedDemoData() {
            staffData = [
                {id:'kim_m', name:'김매니저', role:'manager', joinDate:'2024-01-01', isWorking:true, payType:'monthly', basePay:2200000, allowance:200000, contractType:'4major', bank:'KB', account:'111', defaultSchedule:{}},
                {id:'kim_d', name:'김도윤', role:'staff', joinDate:'2025-12-01', isWorking:true, payType:'hourly', basePay:10000, allowance:0, contractType:'freelancer', bank:'Toss', account:'222', defaultSchedule:{}}
            ];
        }

        // === STAFF LOGIC ===
        async function handleStaffSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('staff-id').value;
            let defSch = {};
            for(let i=1; i<=7; i++) {
                const s = document.querySelector(`input[name="def_s_${i}"]`).value;
                const e_t = document.querySelector(`input[name="def_e_${i}"]`).value;
                if(s && e_t) defSch[i] = {s, e: e_t};
            }

            const newStaff = {
                id: id || 'staff_' + Date.now(),
                name: document.getElementById('staff-name').value,
                role: document.querySelector('input[name="role"]:checked').value,
                rrnFront: document.getElementById('staff-rrn-front').value,
                rrnBack: document.getElementById('staff-rrn-back').value,
                address: document.getElementById('staff-address').value,
                joinDate: document.getElementById('staff-join-date').value,
                isWorking: document.getElementById('staff-is-working').checked,
                resignDate: document.getElementById('staff-resign-date').value,
                payType: document.querySelector('input[name="payType"]:checked').value,
                basePay: Number(document.getElementById('staff-base-pay').value),
                allowance: Number(document.getElementById('staff-allowance').value),
                juhyuIncluded: document.getElementById('staff-juhyu-included').checked,
                contractType: document.getElementById('staff-contract-type').value,
                bank: document.getElementById('staff-bank').value,
                account: document.getElementById('staff-account').value,
                accountHolder: document.getElementById('staff-account-holder').value,
                defaultSchedule: defSch
            };

            if(id) {
                const idx = staffData.findIndex(s => s.id === id);
                staffData[idx] = newStaff;
            } else {
                staffData.push(newStaff);
                if(!selectedScheduleStaffId) selectedScheduleStaffId = newStaff.id;
            }

            if(API_URL) await fetchAPI('saveStaff', { staff: newStaff });

            closeStaffModal();
            renderStaffList();
            renderScheduleStaffList();
            renderPayroll();
            showToast('저장되었습니다.');
        }

        async function deleteStaff() {
            const id = document.getElementById('staff-id').value;
            if(!confirm('삭제하시겠습니까?')) return;
            
            staffData = staffData.filter(s => s.id !== id);
            if(selectedScheduleStaffId === id) selectedScheduleStaffId = staffData[0]?.id || null;
            
            if(API_URL) await fetchAPI('deleteStaff', { staffId: id });

            closeStaffModal();
            renderStaffList();
            renderScheduleStaffList();
            renderPayroll();
            showToast('삭제되었습니다.');
        }

        // === SCHEDULE LOGIC ===
        async function saveSchedule() {
            const status = document.getElementById('work-status').value;
            const start = document.getElementById('start-time').value;
            const end = document.getElementById('end-time').value;
            let totalHours = 0, breakMinutes = 0;

            if(status === 'work') {
                if(!start || !end) return alert('시간 입력 필요');
                const sD = new Date(`2000-01-01T${start}`), eD = new Date(`2000-01-01T${end}`);
                if(eD < sD) eD.setDate(eD.getDate()+1);
                let diff = (eD - sD)/36e5;
                if(diff>=8) breakMinutes=60; else if(diff>=4) breakMinutes=30;
                totalHours = diff - (breakMinutes/60);
            }

            const key = `${editingStaffId}_${editingDateStr}`;
            const schData = {
                id: key,
                staffId: editingStaffId,
                date: editingDateStr,
                status,
                start: status==='work'?start:'',
                end: status==='work'?end:'',
                totalHours: Number(totalHours.toFixed(2)),
                breakMinutes
            };

            schedules[key] = schData;
            
            if(API_URL) await fetchAPI('saveSchedule', { schedule: schData });

            closeScheduleModal();
            renderCalendar();
            renderPayroll();
            showToast('일정이 저장되었습니다.');
        }

        // === CONFIG LOGIC ===
        function openConfig() {
            document.getElementById('api-url-input').value = API_URL;
            document.getElementById('config-modal').classList.remove('hidden');
        }
        function closeConfig() { document.getElementById('config-modal').classList.add('hidden'); }
        function saveConfig() {
            const url = document.getElementById('api-url-input').value.trim();
            localStorage.setItem('gas_api_url', url);
            API_URL = url;
            closeConfig();
            location.reload();
        }
        function showLoading(show) {
            document.getElementById('global-loading').classList.toggle('hidden', !show);
        }

        // ... [PRESERVED: All UI Render Functions from v1.6.0] ... 
        
        function renderStaffList(){const l=document.getElementById('staff-list');document.getElementById('staff-count').innerText=staffData.length;l.innerHTML='';staffData.forEach(s=>{const t=s.payType==='monthly'?`월급 ${formatMoney(s.basePay)}`:`시급 ${formatMoney(s.basePay)}`;const c=document.createElement('div');c.className='toss-card flex justify-between items-center cursor-pointer hover:translate-x-1 hover:shadow-md transition-all';c.onclick=()=>openStaffModal(s.id);c.innerHTML=`<div class="flex items-center gap-4"><div class="w-12 h-12 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-lg">${s.name[0]}</div><div><div class="font-bold text-lg text-gray-800">${s.name}<span class="text-xs px-2 py-0.5 rounded ml-1 font-bold ${s.role==='manager'?'text-blue-600 bg-blue-50':'text-green-600 bg-green-50'}">${s.role==='manager'?'매니저':'스태프'}</span>${!s.isWorking?'<span class="text-xs bg-gray-100 text-gray-500 px-1 rounded ml-1">퇴사</span>':''}</div><div class="text-gray-500 text-sm mt-0.5 font-medium">${t} • ${s.bank}</div></div></div><i class="fas fa-chevron-right text-gray-300"></i>`;l.appendChild(c)})}
        function renderScheduleStaffList(){const l=document.getElementById('schedule-staff-list');l.innerHTML='';staffData.forEach(s=>{const a=s.id===selectedScheduleStaffId;const c=document.createElement('div');c.className=`flex-shrink-0 md:flex-shrink w-auto md:w-full p-3 rounded-xl cursor-pointer transition-all flex items-center gap-3 ${a?'schedule-staff-active ring-2 ring-blue-500 ring-offset-2':'schedule-staff-inactive'}`;c.onclick=()=>{selectedScheduleStaffId=s.id;renderScheduleStaffList();renderCalendar()};c.innerHTML=`<div class="w-10 h-10 rounded-full ${a?'bg-white/20 text-white':'bg-blue-50 text-blue-600'} flex items-center justify-center font-bold">${s.name[0]}</div><div class="hidden md:block"><div class="font-bold text-sm">${s.name}</div><div class="text-xs ${a?'text-blue-100':'text-gray-400'}">${s.role==='manager'?'매니저':'스태프'}</div></div><div class="md:hidden font-bold text-sm pr-2">${s.name}</div>`;l.appendChild(c)})}
        function renderCalendar(){const d=document.getElementById('current-month-display');if(!selectedScheduleStaffId)return;if(scheduleViewMode==='month'){d.innerText=`${currentYear}년 ${currentMonth+1}월`;const g=document.getElementById('calendar-grid');g.innerHTML='';const fd=new Date(currentYear,currentMonth,1).getDay();const dim=new Date(currentYear,currentMonth+1,0).getDate();const off=fd===0?6:fd-1;for(let i=0;i<off;i++)g.innerHTML+=`<div></div>`;for(let i=1;i<=dim;i++)renderDayCard(g,currentYear,currentMonth,i)}else{const ed=new Date(currentWeekStart);ed.setDate(ed.getDate()+6);d.innerText=`${currentWeekStart.getMonth()+1}월 ${currentWeekStart.getDate()}일 - ${ed.getMonth()+1}월 ${ed.getDate()}일`;renderWeekGrid()}}
        function renderDayCard(c,y,m,d){const k=`${selectedScheduleStaffId}_${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;const sch=schedules[k];let h=`<span class="text-gray-300 text-xs">-</span>`,bg='bg-white hover:bg-gray-50',br='border-gray-100';if(sch){if(sch.status==='work'){h=`<span class="text-blue-600 font-bold text-xs bg-blue-50 px-1.5 py-0.5 rounded-md">${sch.totalHours}h</span>`;bg='bg-white hover:border-blue-300';br='border-blue-100 ring-1 ring-blue-50'}else if(sch.status==='absent'){h=`<span class="text-red-500 font-bold text-xs bg-red-50 px-1.5 py-0.5 rounded-md">결근</span>`;bg='bg-white hover:border-red-300';br='border-red-100 ring-1 ring-red-50'}else h=`<span class="text-gray-400 font-medium text-xs">휴무</span>`}const el=document.createElement('div');el.className=`h-24 md:h-28 border rounded-2xl flex flex-col items-center justify-center cursor-pointer transition-all ${bg} ${br}`;el.onclick=()=>openScheduleModal(d,selectedScheduleStaffId,y,m);el.innerHTML=`<span class="text-sm font-medium mb-2 text-gray-700">${d}</span>${h}`;c.appendChild(el)}
        function renderWeekGrid(){const h=document.getElementById('week-header-row');h.innerHTML=`<div class="p-2 border-r border-gray-100 bg-gray-50 sticky left-0 z-30"></div>`;const b=document.getElementById('week-grid-body');while(b.children.length>1)b.removeChild(b.lastChild);const days=['월','화','수','목','금','토','일'];for(let i=0;i<7;i++){const d=new Date(currentWeekStart);d.setDate(d.getDate()+i);const dn=d.getDate(),dl=days[i],clr=i===5?'text-blue-500':(i===6?'text-red-500':'text-gray-600');h.innerHTML+=`<div class="text-center py-2 border-r border-gray-100 font-bold text-sm bg-white"><div class="${clr}">${dl}</div><div class="text-lg">${dn}</div></div>`;const col=document.createElement('div');col.className="border-r border-gray-100 relative bg-white";for(let hr=0;hr<24;hr++){createTimeSlot(col,d,hr,0);createTimeSlot(col,d,hr,30)}const ds=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;const k=`${selectedScheduleStaffId}_${ds}`;const sch=schedules[k];if(sch&&sch.status==='work'){const[sH,sM]=sch.start.split(':').map(Number);const[eH,eM]=sch.end.split(':').map(Number);const st=(sH)*60+sM,et=(eH)*60+eM;if(st>=0){const blk=document.createElement('div');blk.className='schedule-block flex flex-col justify-center items-center';blk.style.top=`${(st/30)*40}px`;blk.style.height=`${((et-st)/30)*40}px`;blk.innerHTML=`${sch.start}-${sch.end}`;blk.onclick=(e)=>{e.stopPropagation();openScheduleModal(dn,selectedScheduleStaffId,d.getFullYear(),d.getMonth())};col.appendChild(blk)}}b.appendChild(col)}}
        let isDragging=false,dragStartEl=null;
        function createTimeSlot(c,d,h,m){const s=document.createElement('div');s.className="time-grid-cell cursor-pointer";Object.assign(s.dataset,{year:d.getFullYear(),month:d.getMonth(),day:d.getDate(),hour:h,min:m});s.onmousedown=()=>{isDragging=true;dragStartEl=s;updateSelection(s)};s.onmouseover=()=>{if(isDragging)updateSelection(s)};s.onmouseup=()=>{if(isDragging){isDragging=false;finishDrag(s)}};c.appendChild(s)}
        function updateSelection(c){document.querySelectorAll('.time-grid-cell.selected').forEach(e=>e.classList.remove('selected'));if(dragStartEl&&dragStartEl.parentElement===c.parentElement){const sib=[...dragStartEl.parentElement.children].filter(e=>e.classList.contains('time-grid-cell')),idx1=sib.indexOf(dragStartEl),idx2=sib.indexOf(c);for(let i=Math.min(idx1,idx2);i<=Math.max(idx1,idx2);i++)sib[i].classList.add('selected')}}
        function finishDrag(e){if(!dragStartEl||dragStartEl.parentElement!==e.parentElement){dragStartEl=null;return}document.querySelectorAll('.time-grid-cell.selected').forEach(el=>el.classList.remove('selected'));const ds=dragStartEl.dataset,de=e.dataset;const t1=parseInt(ds.hour)*60+parseInt(ds.min),t2=parseInt(de.hour)*60+parseInt(de.min),s=Math.min(t1,t2),end=Math.max(t1,t2)+30;openScheduleModal(parseInt(ds.day),selectedScheduleStaffId,parseInt(ds.year),parseInt(ds.month));document.getElementById('work-status').value='work';toggleTimeInputs();document.getElementById('start-time').value=`${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;document.getElementById('end-time').value=`${String(Math.floor(end/60)).padStart(2,'0')}:${String(end%60).padStart(2,'0')}`;calculateDuration();dragStartEl=null}
        
        // --- PAYROLL CALCULATION ENGINE ---
        let payrollResults = {}; 

        function renderPayroll() {
            const container = document.getElementById('payroll-list');
            container.innerHTML = '';
            payrollResults = {}; 

            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

            staffData.forEach(staff => {
                let hourlyRate = 0;
                let calculationNote = "";

                if(staff.payType === 'monthly') {
                    let workingDays = 0;
                    for(let d=1; d<=daysInMonth; d++) {
                        const day = new Date(currentYear, currentMonth, d).getDay();
                        if(day >=1 && day <=5) workingDays++;
                    }
                    
                    const totalMonthly = staff.basePay + staff.allowance;
                    const rawRate = (totalMonthly / workingDays / 8) / 1.2;
                    hourlyRate = Math.ceil(rawRate);
                    calculationNote = `통상시급: (${formatMoney(totalMonthly)} / ${workingDays}일 / 8h / 1.2) = ${formatMoney(hourlyRate)}`;
                } else {
                    hourlyRate = staff.basePay;
                    calculationNote = `시급: ${formatMoney(hourlyRate)} ${staff.juhyuIncluded ? '(주휴포함)' : ''}`;
                    if(staff.allowance > 0) calculationNote += ` + 수당 ${formatMoney(staff.allowance)}`;
                }

                let totalWorkPay = 0;
                let totalJuhyuPay = 0;
                let totalHours = 0;
                let dailyDetails = [];
                let juhyuNotes = [];
                let weeks = {};
                
                for(let d=1; d<=daysInMonth; d++) {
                    const date = new Date(currentYear, currentMonth, d);
                    const dateStr = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    
                    const dayNum = date.getDay(); 
                    const diffToMon = (dayNum + 6) % 7; 
                    const mondayDate = new Date(date);
                    mondayDate.setDate(date.getDate() - diffToMon);
                    const weekKey = mondayDate.toISOString().split('T')[0];

                    if(!weeks[weekKey]) weeks[weekKey] = { dates:[], hours:0, absences:0, hasJoin:false };
                    
                    const sch = schedules[`${staff.id}_${dateStr}`];
                    
                    const joinD = new Date(staff.joinDate);
                    const sundayDate = new Date(mondayDate);
                    sundayDate.setDate(mondayDate.getDate() + 6);
                    
                    if(joinD >= mondayDate && joinD <= sundayDate) weeks[weekKey].hasJoin = true;

                    let dailyPay = 0;
                    let dailyHours = 0;
                    let statusStr = '-';
                    let timeStr = '-';

                    if(sch && sch.status === 'work') {
                        dailyHours = sch.totalHours;
                        dailyPay = Math.ceil(dailyHours * hourlyRate);
                        
                        weeks[weekKey].hours += dailyHours;
                        totalHours += dailyHours;
                        statusStr = '근무';
                        timeStr = `${sch.start}~${sch.end}`;
                    } else if(sch && sch.status === 'absent') {
                        weeks[weekKey].absences++;
                        statusStr = '결근';
                        timeStr = '-';
                    }

                    if(statusStr !== '-') {
                        dailyDetails.push({
                            date: dateStr,
                            time: timeStr,
                            status: statusStr,
                            hours: dailyHours,
                            pay: dailyPay,
                            weekKey: weekKey
                        });
                        totalWorkPay += dailyPay;
                    }
                }

                Object.keys(weeks).forEach(weekKey => {
                    const w = weeks[weekKey];
                    let isEligible = true;
                    let reason = "";

                    if(w.hours < 15) { isEligible = false; reason = "15시간 미만"; }
                    if(w.absences > 0) { isEligible = false; reason = "결근 발생"; }
                    if(w.hasJoin) { isEligible = false; reason = "입사 주간"; }
                    
                    if(isEligible) {
                        if(staff.payType === 'hourly' && staff.juhyuIncluded) {
                            dailyDetails.filter(d => d.weekKey === weekKey && d.status === '근무').forEach(d => {
                                d.juhyu = 0;
                                d.juhyuReason = "시급에 포함";
                            });
                        } else {
                            let weeklyBase = 0;
                            dailyDetails.filter(d => d.weekKey === weekKey).forEach(d => weeklyBase += d.pay);
                            
                            const juhyuAmt = Math.ceil(weeklyBase * 0.2);
                            totalJuhyuPay += juhyuAmt;
                            
                            dailyDetails.filter(d => d.weekKey === weekKey && d.status === '근무').forEach(d => {
                                d.juhyu = Math.ceil(d.pay * 0.2);
                            });
                        }
                    } else {
                        if(w.hours > 0) juhyuNotes.push(`${weekKey}주: 제외 (${reason})`);
                        dailyDetails.filter(d => d.weekKey === weekKey).forEach(d => {
                            d.juhyu = 0;
                            d.juhyuReason = reason;
                        });
                    }
                });

                if(staff.payType === 'hourly' && staff.allowance > 0) totalWorkPay += staff.allowance;

                const totalGross = totalWorkPay + totalJuhyuPay;
                let taxRate = 0;
                let taxAmount = 0;
                let insuranceName = "";

                if(staff.contractType === 'freelancer') {
                    taxRate = 0.033;
                    insuranceName = "사업소득세(3.3%)";
                } else if(staff.contractType === '4major') {
                    taxRate = 0.0932;
                    insuranceName = "4대보험(약 9.3%)";
                } else { // 2major
                    taxRate = 0.009;
                    insuranceName = "고용보험(0.9%)";
                }
                
                taxAmount = Math.ceil(totalGross * taxRate); 
                const netPay = totalGross - taxAmount;

                payrollResults[staff.id] = {
                    staff,
                    totalHours,
                    totalWorkPay,
                    totalJuhyuPay,
                    totalGross,
                    netPay,
                    juhyuNotes,
                    weeks
                };

                const wrapper = document.createElement('div');
                wrapper.className = 'toss-card';
                
                const detailRows = dailyDetails.map(d => `
                    <tr class="border-b border-gray-100 last:border-0 text-sm">
                        <td class="py-3 text-gray-500">${d.date.slice(5)}</td>
                        <td class="py-3 font-medium ${d.status==='결근'?'text-red-500':''}">${d.time}<br><span class="text-xs text-gray-400">${d.status}</span></td>
                        <td class="py-3 text-right">${d.hours}h</td>
                        <td class="py-3 text-right text-gray-600">${formatMoney(d.pay)}</td>
                        <td class="py-3 text-right text-blue-500">${d.juhyu ? formatMoney(d.juhyu) : (d.juhyuReason ? '<span class="text-xs text-gray-400">'+d.juhyuReason+'</span>' : '<span class="text-xs text-gray-300">미지급</span>')}</td>
                        <td class="py-3 text-right font-bold">${formatMoney(d.pay + (d.juhyu||0))}</td>
                    </tr>
                `).join('');

                wrapper.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800">${staff.name} <span class="text-sm font-normal text-gray-500">(${staff.role === 'manager' ? '매니저' : '스태프'})</span></h3>
                            <p class="text-xs text-gray-400 mt-1">${calculationNote}</p>
                            <div class="text-xs text-gray-400 mt-1">${staff.bank} ${staff.account} (${staff.accountHolder})</div>
                        </div>
                        <div class="text-right">
                            <button onclick="openAIReport('${staff.id}')" class="toss-btn-ai mb-2">
                                <i class="fas fa-sparkles"></i> AI 리포트
                            </button>
                            <div class="text-2xl font-bold text-blue-600">${formatMoney(netPay)}</div>
                            <div class="text-xs text-gray-400 font-medium">세후 예상 수령액</div>
                        </div>
                    </div>

                    <div class="bg-gray-50 rounded-xl p-4 space-y-2 text-sm mb-4">
                        <div class="flex justify-between">
                            <span class="text-gray-500">지급 총액 (세전)</span>
                            <span class="font-bold text-gray-700">${formatMoney(totalGross)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">공제 (${insuranceName})</span>
                            <span class="text-red-500 font-medium">-${formatMoney(taxAmount)}</span>
                        </div>
                        ${juhyuNotes.length > 0 ? `
                        <div class="pt-2 border-t border-gray-200 mt-2">
                            <span class="text-xs text-orange-500 font-bold flex items-center gap-1"><i class="fas fa-exclamation-circle"></i> 주휴 제외 알림</span>
                            <ul class="text-xs text-gray-500 mt-1 list-disc pl-4 space-y-0.5">
                                ${juhyuNotes.map(n => `<li>${n}</li>`).join('')}
                            </ul>
                        </div>` : ''}
                    </div>

                    <details class="group">
                        <summary class="flex justify-between items-center cursor-pointer list-none py-3 border-t border-gray-100 hover:bg-gray-50 px-2 -mx-2 rounded-lg transition-colors">
                            <span class="font-bold text-gray-600 text-sm">일별 상세 내역 보기</span>
                            <span class="transition-transform group-open:rotate-180"><i class="fas fa-chevron-down text-gray-400"></i></span>
                        </summary>
                        <div class="mt-2 overflow-x-auto">
                            <table class="w-full text-left whitespace-nowrap">
                                <thead>
                                    <tr class="text-xs text-gray-400 border-b border-gray-200">
                                        <th class="pb-2 pl-2">날짜</th>
                                        <th class="pb-2">시간/상태</th>
                                        <th class="pb-2 text-right">인정시간</th>
                                        <th class="pb-2 text-right">기본급</th>
                                        <th class="pb-2 text-right">주휴수당</th>
                                        <th class="pb-2 text-right pr-2">총지급액</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${detailRows}
                                </tbody>
                            </table>
                        </div>
                    </details>
                `;
                container.appendChild(wrapper);
            });
        }

        // --- Standard UI Helpers ---
        function formatMoney(n){return Math.floor(n).toLocaleString()+'원'}
        function showToast(m){const t=document.getElementById('toast');t.innerText=m;t.style.opacity='1';setTimeout(()=>t.style.opacity='0',3000)}
        function toggleViewMode(m){scheduleViewMode=m;const bm=document.getElementById('btn-view-month'),bw=document.getElementById('btn-view-week');if(m==='month'){bm.classList.add('bg-white','text-blue-600','shadow-sm');bm.classList.remove('text-gray-500');bw.classList.remove('bg-white','text-blue-600','shadow-sm');bw.classList.add('text-gray-500');document.getElementById('month-view-container').classList.remove('hidden');document.getElementById('week-view-container').classList.add('hidden')}else{bw.classList.add('bg-white','text-blue-600','shadow-sm');bw.classList.remove('text-gray-500');bm.classList.remove('bg-white','text-blue-600','shadow-sm');bm.classList.add('text-gray-500');document.getElementById('month-view-container').classList.add('hidden');document.getElementById('week-view-container').classList.remove('hidden')}renderCalendar()}
        function changeDateRange(d){if(scheduleViewMode==='month'){currentMonth+=d;if(currentMonth>11){currentMonth=0;currentYear++}if(currentMonth<0){currentMonth=11;currentYear--}}else{currentWeekStart.setDate(currentWeekStart.getDate()+(d*7));currentYear=currentWeekStart.getFullYear();currentMonth=currentWeekStart.getMonth()}renderCalendar()}
        
        // --- Modal Toggles ---
        function openStaffModal(id){const m=document.getElementById('staff-modal'),f=document.getElementById('staff-form');f.reset();document.getElementById('staff-id').value='';if(id){const s=staffData.find(x=>x.id===id);document.getElementById('modal-title').innerText='직원 수정';document.getElementById('staff-id').value=s.id;document.getElementById('staff-name').value=s.name;document.querySelector(`input[name="role"][value="${s.role}"]`).checked=true;document.getElementById('staff-rrn-front').value=s.rrnFront;document.getElementById('staff-rrn-back').value=s.rrnBack;document.getElementById('staff-address').value=s.address;document.getElementById('staff-join-date').value=s.joinDate;document.getElementById('staff-is-working').checked=s.isWorking;document.getElementById('staff-resign-date').value=s.resignDate;document.querySelector(`input[name="payType"][value="${s.payType}"]`).checked=true;document.getElementById('staff-base-pay').value=s.basePay;document.getElementById('staff-allowance').value=s.allowance;document.getElementById('staff-juhyu-included').checked=s.juhyuIncluded;document.getElementById('staff-contract-type').value=s.contractType;document.getElementById('staff-bank').value=s.bank;document.getElementById('staff-account').value=s.account;document.getElementById('staff-account-holder').value=s.accountHolder;if(s.defaultSchedule)Object.keys(s.defaultSchedule).forEach(k=>{document.querySelector(`input[name="def_s_${k}"]`).value=s.defaultSchedule[k].s;document.querySelector(`input[name="def_e_${k}"]`).value=s.defaultSchedule[k].e});document.getElementById('btn-delete').classList.remove('hidden')}else{document.getElementById('modal-title').innerText='직원 등록';document.getElementById('btn-delete').classList.add('hidden')}renderWorkDaysInputs();togglePayInputs();toggleResignDate();m.classList.remove('hidden');setTimeout(()=>document.getElementById('staff-modal-content').classList.remove('translate-y-full'),10)}
        function closeStaffModal(){document.getElementById('staff-modal-content').classList.add('translate-y-full');setTimeout(()=>document.getElementById('staff-modal').classList.add('hidden'),300)}
        function openScheduleModal(d,sid,y,m){editingStaffId=sid;editingDateStr=`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;document.getElementById('schedule-modal-date').innerText=`${m+1}월 ${d}일`;const s=schedules[`${sid}_${editingDateStr}`];if(s){document.getElementById('work-status').value=s.status;document.getElementById('start-time').value=s.start;document.getElementById('end-time').value=s.end}else{document.getElementById('work-status').value='work';document.getElementById('start-time').value='';document.getElementById('end-time').value=''}toggleTimeInputs();calculateDuration();document.getElementById('schedule-modal').classList.remove('hidden')}
        function closeScheduleModal(){document.getElementById('schedule-modal').classList.add('hidden')}
        
        // --- Nav ---
        function switchTab(t){document.querySelectorAll('section').forEach(e=>e.classList.add('hidden'));document.getElementById(`view-${t}`).classList.remove('hidden');if(t==='schedule')document.getElementById(`view-${t}`).classList.add('flex');else document.getElementById('view-schedule').classList.remove('flex');document.getElementById('main-scroll').scrollTop=0;['staff','schedule','payroll'].forEach(x=>{const b=document.getElementById(`nav-${x}`);const mb=document.getElementById(`mob-${x}`);if(x===t){b.className='w-full flex items-center gap-3 px-5 py-3.5 rounded-2xl text-left font-bold transition-all nav-item-active';mb.className='flex-1 flex flex-col items-center gap-1 py-2 text-blue-600'}else{b.className='w-full flex items-center gap-3 px-5 py-3.5 rounded-2xl text-left font-bold transition-all nav-item-inactive';mb.className='flex-1 flex flex-col items-center gap-1 py-2 text-gray-400'}});if(t==='schedule')renderCalendar();if(t==='payroll')renderPayroll()}
        
        // --- Render Inputs Helpers ---
        function renderWorkDaysInputs(){const c=document.getElementById('work-days-container');if(c.children.length>0)return;const d=['월','화','수','목','금','토','일'];d.forEach((day,i)=>c.innerHTML+=`<div class="flex items-center gap-2"><span class="w-6 text-sm font-bold text-gray-600">${day}</span><input type="time" name="def_s_${i+1}" class="toss-input py-1 text-sm"><span class="text-gray-300">~</span><input type="time" name="def_e_${i+1}" class="toss-input py-1 text-sm"></div>`)}
        function toggleResignDate(){const w=document.getElementById('staff-is-working').checked;document.getElementById('staff-resign-date').disabled=w;if(w)document.getElementById('staff-resign-date').value=''}
        function togglePayInputs(){const t=document.querySelector('input[name="payType"]:checked').value;document.getElementById('label-base-pay').innerText=t==='monthly'?'월 기본급':'시급';document.getElementById('hourly-options').classList.toggle('hidden',t==='monthly')}
        function toggleTimeInputs(){const s=document.getElementById('work-status').value;document.getElementById('time-inputs').classList.toggle('hidden',s!=='work')}
        function calculateDuration(){const s=document.getElementById('start-time').value,e=document.getElementById('end-time').value;if(!s||!e){document.getElementById('calc-hours').innerText='0';return}const d1=new Date(`2000-01-01T${s}`),d2=new Date(`2000-01-01T${e}`);if(d2<d1)d2.setDate(d2.getDate()+1);const h=(d2-d1)/36e5;let b=0;if(h>=8)b=60;else if(h>=4)b=30;document.getElementById('calc-hours').innerText=(h-b/60).toFixed(1);document.getElementById('calc-break').innerText=b}
        
        // Date Picker logic
        let pickerYear=2025;
        function openDatePicker(){pickerYear=currentYear;document.getElementById('picker-year').innerText=pickerYear;document.getElementById('date-picker-modal').classList.remove('hidden')}
        function closeDatePicker(){document.getElementById('date-picker-modal').classList.add('hidden')}
        function adjustPickerYear(d){pickerYear+=d;document.getElementById('picker-year').innerText=pickerYear}
        function selectPickerMonth(m){currentYear=pickerYear;currentMonth=m;const d=new Date(currentYear,currentMonth,1);const dy=d.getDay();const diff=d.getDate()-dy+(dy===0?-6:1);currentWeekStart=new Date(d.setDate(diff));closeDatePicker();renderCalendar()}

        init();
    </script>
</body>
</html>
